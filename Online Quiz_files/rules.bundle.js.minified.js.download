!function(e){function t(t){for(var i,a,s=t[0],l=t[1],u=t[2],d=0,h=[];d<s.length;d++)a=s[d],Object.prototype.hasOwnProperty.call(r,a)&&r[a]&&h.push(r[a][0]),r[a]=0;for(i in l)Object.prototype.hasOwnProperty.call(l,i)&&(e[i]=l[i]);for(c&&c(t);h.length;)h.shift()();return o.push.apply(o,u||[]),n()}function n(){for(var e,t=0;t<o.length;t++){for(var n=o[t],i=!0,s=1;s<n.length;s++){var l=n[s];0!==r[l]&&(i=!1)}i&&(o.splice(t--,1),e=a(a.s=n[0]))}return e}var i={},r={3:0},o=[];function a(t){if(i[t])return i[t].exports;var n=i[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.m=e,a.c=i,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(n,i,function(t){return e[t]}.bind(null,i));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="";var s=window.webpackJsonp=window.webpackJsonp||[],l=s.push.bind(s);s.push=t,s=s.slice();for(var u=0;u<s.length;u++)t(s[u]);var c=l;o.push([201,1,0]),n()}({201:function(e,t,n){"use strict";n.r(t);var i,r,o,a,s,l,u,c,d,h,f,g,p,v,m,y,b=n(3),E=n.n(b),w=n(4),T=n.n(w),N=n(6),C=n.n(N),k=n(5),S=n.n(k),I=n(2),O=n.n(I),D=n(7),A=n.n(D),R=n(0),x=n.n(R),_=n(13);!function(e){e.STATEMENT="statement",e.TABLE="table_reference",e.EXPRESSION="expression",e.FIELDS_LIST="fields_list",e.FIELD="field",e.UPDATE_FIELD="update_field",e.DELAYED_OPTION="delayed_option",e.LIMIT_OPTION="limit_option",e.ORDER_BY_OPTION="order_by_option",e.ORDER_BY_EXPRESSION="order_by_expression"}(i||(i={})),function(e){e.SELECT="select",e.UPDATE="update",e.INSERT="insert",e.DELETE="delete"}(r||(r={})),function(e){e.ALL_FIELDS="all",e.SPECIFIC_FIELDS="enumeration"}(o||(o={})),function(e){e.NUMBER="number",e.BOOLEAN="boolean",e.NULL="null",e.STRING="string",e.UNARY="unary",e.LOGICAL="logical",e.MATH="math",e.GROUP="group",e.IDENTIFIER="identifier",e.BINDING="binding",e.FUNCTION_CALL="function_call"}(a||(a={})),function(e){e.RANDOM="random",e.ORDERED="ordered"}(s||(s={})),function(e){e.ASCENDING="asc",e.DESCENDING="desc"}(l||(l={})),function(e){e.NOT="!",e.INVERT="-"}(u||(u={})),function(e){e.OR="||",e.AND="&&"}(c||(c={})),function(e){e.EQUALS="=",e.DIFFERENT="<>",e.LIKE="like",e.IN="in",e.LTE="<=",e.LT="<",e.GTE=">=",e.GT=">"}(d||(d={})),function(e){e.MULTIPLY="*",e.DIVISION="/",e.ADDITION="+",e.DIFFERENCE="-"}(h||(h={})),function(e){e.STRING="string",e.NUMBER="number",e.BOOLEAN="boolean",e.NULL="null",e.OBJECT="object"}(f||(f={})),function(e){e.STRING="string",e.INT="int",e.FLOAT="float",e.BOOLEAN="boolean"}(g||(g={})),function(e){e.IN_MEMORY="memory",e.REMOTE="remote"}(p||(p={})),function(e){e.READ="r",e.WRITE="w",e.READ_WRITE="rw"}(v||(v={})),function(e){e.FORM="private",e.GLOBAL="global"}(m||(m={})),function(e){e[e.INIT=0]="INIT",e[e.CHANGE=1]="CHANGE",e[e.CHECK=2]="CHECK",e[e.UNCHECK=3]="UNCHECK",e[e.TEXT_INPUT=4]="TEXT_INPUT",e[e.ALL_EVENTS=5]="ALL_EVENTS",e[e.REINITIALIZE=6]="REINITIALIZE",e[e.APPROVED=7]="APPROVED",e[e.SUBMITTED=8]="SUBMITTED",e[e.PREFILL=9]="PREFILL"}(y||(y={})),window.EJQLTableColumnType=f,window.EFormRuleEventType=y;var L=n(11),M=n.n(L),F=n(15);function P(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}var B=function(){function e(){E()(this,e)}return T()(e,null,[{key:"create",value:function(e,t,n){return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?P(Object(n),!0).forEach((function(t){x()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):P(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},{action:e,auth:t},{},n)}}]),e}(),U=n(18),V=n.n(U),j=function(){function e(){E()(this,e)}return T()(e,null,[{key:"getType",value:function(e){if(void 0===e)return null;if(null===e)return f.NULL;var t=V()(e);return"number"===t?isFinite(e)?f.NUMBER:null:"boolean"===t?f.BOOLEAN:"string"===t?f.STRING:"object"===t?f.OBJECT:null}},{key:"isNumeric",value:function(e){var t=this.getType(e);return t===f.NUMBER||t===f.STRING&&"-"!==e&&"+"!==e&&/^([\-+])?(0|[1-9]([0-9]+)?)?(\.[0-9]+)?/.test(e)}},{key:"getColumnDefinitions",value:function(e){for(var t,n=Object.create(null),i=0,r=(e||[]).length;i<r&&0===i;i++)for(var o in e[i])e[i].hasOwnProperty(o)&&(t=this.getType(e[i][o]),n[o]=t);var a=[];for(var s in n)null!==n[s]&&a.push({type:n[s],name:s});return a}},{key:"isReservedKeyword",value:function(e){return this.RESERVED_KEYWORDS.indexOf(String(e||""))>-1}},{key:"shuffleArray",value:function(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),i=[e[n],e[t]];e[t]=i[0],e[n]=i[1]}return e}},{key:"compare",value:function(e,t){var n,i,r=this.getType(e),o=this.getType(t);if(null===r&&null===o)return 0;if(null===r||null===o)return null===r?-1:1;if(r===o)switch(r){case f.BOOLEAN:case f.NUMBER:case f.NULL:return e==t?0:e<t?-1:1;case f.STRING:n=String(e).toLowerCase(),i=String(t).toLowerCase()}else n=r!==f.STRING?r===f.NUMBER?String(e):r===f.NULL?"":e?"1":"0":String(e).toLowerCase(),i=o!==f.STRING?o===f.NUMBER?String(t):o===f.NULL?"":t?"1":"0":String(e).toLowerCase();return n===i?0:n<i?-1:1}},{key:"parseString",value:function(e){for(var t,n,i="",r=0,o=e.length;r<o;r++)if("\\"===(t=e.charAt(r)))switch(n=e.charAt(r+1),r++,n){case"r":i+="\r";break;case"n":i+="\n";break;case"t":i+="\t";break;case"\\":case"":i+="\\";break;default:i+=n}else i+=t;return i}},{key:"castToString",value:function(e){return!0===e?"1":!1===e?"0":String(e||"")}},{key:"compareAsStrings",value:function(e,t){var n=this.castToString(e).toLowerCase(),i=this.castToString(t).toLowerCase();return n===i?0:n>i?-1:1}},{key:"encodeData",value:function(e){return Object.keys(e).map((function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])})).join("&")}},{key:"makeRequest",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.REQUEST_METHOD_GET,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.REQUEST_CONTENT_TYPE_PLAIN,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4?arguments[4]:void 0,a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=new XMLHttpRequest;return a&&(s.withCredentials=!0),new Promise((function(a,l){s.onreadystatechange=function(){if(4===s.readyState)if(s.status>=200&&s.status<300){var t;switch(s.responseType){case e.REQUEST_RESPONSE_TYPE_TEXT:t=s.responseText;break;case e.REQUEST_RESPONSE_TYPE_JSON:case e.REQUEST_RESPONSE_TYPE_BLOB:case e.REQUEST_RESPONSE_TYPE_BUFFER:default:t="string"==typeof s.response?JSON.parse(s.response):s.response}a(t)}else l(s.statusText)},s.ontimeout=function(){l(s.statusText)},s.open(n,t,!0),r&&(s.responseType=r),i&&s.setRequestHeader("Content-Type",i),s.send(o)}))}}]),e}();x()(j,"REQUEST_METHOD_POST","POST"),x()(j,"REQUEST_METHOD_GET","GET"),x()(j,"REQUEST_CONTENT_TYPE_PLAIN","text/plain"),x()(j,"REQUEST_CONTENT_TYPE_HTML","text/html"),x()(j,"REQUEST_CONTENT_TYPE_JSON","application/json"),x()(j,"REQUEST_CONTENT_TYPE_MULTIPART","multipart/form-data"),x()(j,"REQUEST_CONTENT_TYPE_X_WWW_FORM_URLENCODED","application/x-www-form-urlencoded"),x()(j,"REQUEST_RESPONSE_TYPE_BUFFER","arraybuffer"),x()(j,"REQUEST_RESPONSE_TYPE_BLOB","blob"),x()(j,"REQUEST_RESPONSE_TYPE_TEXT","text"),x()(j,"REQUEST_RESPONSE_TYPE_JSON","json"),x()(j,"RESERVED_KEYWORDS",["select","from","where","in","limit","order","by","asc","update","table","set","insert","into","values","delete","like"]);var G=function(){function e(t,n,i){E()(this,e),x()(this,"numColumns",void 0),x()(this,"columns",{}),x()(this,"data",[]),x()(this,"rowIndex",void 0),this.numColumns=t.length;for(var r=0;r<this.numColumns;r++)this.columns[t[r].name]={type:t[r].type,index:r};this.data=n,this.rowIndex=i}return T()(e,[{key:"withIndex",value:function(e){return this.rowIndex=e,this}},{key:"withRowData",value:function(e){return this.data=e,this}},{key:"getDataAsArray",value:function(){return this.data}},{key:"getColumnValue",value:function(e){return this.data[this.columns[e].index]}},{key:"setColumnValue",value:function(e,t){this.data[this.columns[e].index]=t}},{key:"toObject",value:function(){var e,t=Object.create(null);for(var n in this.columns)void 0===(e=this.data[this.columns[n].index])&&(e=null),t[n]=e;return t}},{key:"getRowIndex",value:function(){return this.rowIndex}}],[{key:"createFromObject",value:function(t){var n=[],i=[];for(var r in t)n.push({type:f.NULL,name:r}),i.push(t[r]);return new e(n,i,0)}},{key:"createFromTable",value:function(t){return new e(t.describe(),t.createEmptyRow(),void 0)}}]),e}(),q=function(){function e(){E()(this,e),x()(this,"affectedRows",void 0),x()(this,"affectingRows",!1),x()(this,"calcFoundRows",void 0)}return T()(e,[{key:"getAffectedRows",value:function(){return this.affectedRows}},{key:"withAffectedRows",value:function(e){return this.affectedRows=~~e,this}},{key:"withCalcFoundRows",value:function(e){return this.calcFoundRows=e,this}},{key:"getCalcFoundRows",value:function(){return this.calcFoundRows}},{key:"hasRows",value:function(){return!1}},{key:"getRows",value:function(){return[]}},{key:"getRowsAsArray",value:function(){return[]}}]),e}(),H=function(){function e(t,n,i){E()(this,e),x()(this,"statement",void 0),x()(this,"db",void 0),x()(this,"markedRowsForDelete",void 0),x()(this,"bindings",void 0),this.statement=t,this.db=n,this.bindings=i}return T()(e,[{key:"execute",value:function(){var e=this;return function(){return new Promise((function(t,n){try{e.statement.bind(e.bindings,e.db)}catch(i){return void n(i)}e.db.getTable(e.statement.getTable().getName()).fetch().then((function(r){r.isTransactional()&&r.startTransaction();try{e.markedRowsForDelete=[];for(var o,a=r.createIterator(),s=e.statement.getFilter();o=a.next();)(null===s||!!s.compute(o))&&e.markedRowsForDelete.push({rowIndex:o.getRowIndex(),values:o.getDataAsArray()});if(!e.markedRowsForDelete.length)return r.isTransactional()&&r.commitTransaction(),void t((new q).withAffectedRows(0));if(e.applySorting(),e.applyLimits(),!e.markedRowsForDelete.length)return r.isTransactional()&&r.commitTransaction(),void t((new q).withAffectedRows(0));for(var l=0,u=e.markedRowsForDelete.length;l<u;l++)r.deleteRow(e.markedRowsForDelete[l].rowIndex);r.compact(),r.isTransactional()&&r.commitTransaction(),t((new q).withAffectedRows(e.markedRowsForDelete.length))}catch(i){console.error(i),r.isTransactional()&&r.rollbackTransaction(),n(new Error("Failed to execute DELETE statement!"))}})).catch((function(e){console.error(e),n(new Error("Failed to fetch table from server!"))}))}))}}},{key:"applySorting",value:function(){var e=this.statement.getSorter(),t=this.db.getTable(this.statement.getTable().getName());if(e&&!(this.markedRowsForDelete.length<2)){if(e.isRandom())return j.shuffleArray(this.markedRowsForDelete);var n=e.getSortExpressions(),i=n.length,r=function(){for(var e=[],r=0;r<i;r++)r===i-1?e.push(function(e){return function(t,i){var r=n[e].getExpression().compute(t),o=n[e].getExpression().compute(i),a=j.compare(r,o);return n[e].getDirection()===l.DESCENDING&&(a=-a),a}}(r)):e.push(function(t){return function(i,r){var o=n[t].getExpression().compute(i),a=n[t].getExpression().compute(r),s=j.compare(o,a);return n[t].getDirection()===l.DESCENDING&&(s=-s),0===s?e[t+1](i,r):s}}(r));return function(n,i){return e[0](G.createFromTable(t).withRowData(n.values).withIndex(-1),G.createFromTable(t).withRowData(i.values).withIndex(-1))}}();this.markedRowsForDelete.sort(r)}}},{key:"applyLimits",value:function(){var e=this.statement.getLimit();e&&(this.markedRowsForDelete=this.markedRowsForDelete.slice(e.getSkip(),e.getSkip()+e.getLimit()))}}]),e}(),Q=function(){function e(t,n,i){E()(this,e),x()(this,"statement",void 0),x()(this,"db",void 0),x()(this,"bindings",void 0),this.statement=t,this.db=n,this.bindings=i}return T()(e,[{key:"execute",value:function(){var e=this;return function(){return new Promise((function(t,n){try{e.statement.bind(e.bindings,e.db)}catch(i){return void n(i)}e.db.getTable(e.statement.getTable().getName()).fetch().then((function(r){r.isTransactional()&&r.startTransaction();try{for(var o=G.createFromTable(r),a=0,s=e.statement.getFields(),l=s.length;a<l;a++)o.setColumnValue(s[a].getFieldName(),s[a].getExpression().compute(o));r.insertRow(o.getDataAsArray()),r.reIndex(),r.commitTransaction(),t((new q).withAffectedRows(1))}catch(i){r.isTransactional()&&r.rollbackTransaction(),console.error(i),n(new Error("Failed to execute INSERT statement"))}})).catch((function(e){console.error(e),n(new Error("Failed to fetch table from server!"))}))}))}}}]),e}(),J=n(78),Y=function(e){function t(){var e,n;E()(this,t);for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];return n=C()(this,(e=S()(t)).call.apply(e,[this].concat(r))),x()(O()(n),"lastInsertId",void 0),n}return A()(t,e),T()(t,[{key:"getLastInsertId",value:function(){return this.lastInsertId}},{key:"withLastInsertId",value:function(e){return this.lastInsertId=e,this}}]),t}(q),W=function(e){function t(){var e,n;E()(this,t);for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];return n=C()(this,(e=S()(t)).call.apply(e,[this].concat(r))),x()(O()(n),"rows",[]),n}return A()(t,e),T()(t,[{key:"addRows",value:function(e){if(e&&e.length)for(var t=0,n=e.length;t<n;t++)this.rows.push(e[t]);return this}},{key:"hasRows",value:function(){return!0}},{key:"getAffectedRows",value:function(){return this.rows.length}},{key:"getRows",value:function(){return this.rows}},{key:"getRowsAsArray",value:function(){if(!this.rows||!this.rows.length)return[];for(var e,t,n,i,r=[],o=0,a=this.rows.length;o<a;o++){n=[],t=(e=Object.keys(this.rows[o])).length;for(var s=0;s<t;s++)void 0===(i=this.rows[o][e[s]])&&(i=null),n.push(i);r.push(n)}return r}}]),t}(q),z=function(){function e(t,n,i){E()(this,e),x()(this,"statement",void 0),x()(this,"db",void 0),x()(this,"bindings",void 0),this.statement=t,this.db=n,this.bindings=i}return T()(e,[{key:"execute",value:function(){var e=this;return function(){return new Promise((function(t,n){try{e.statement.bind(e.bindings,e.db)}catch(a){return void n(a)}var i=-1!==e.statement.getTable().name.indexOf("salesforcePrefill")?e.db.getRPCEndpointSalesforceName():e.db.getRPCEndpointName(),r=-1!==e.statement.getTable().name.indexOf("salesforcePrefill")?e.db.getAuthorizationTokenSalesforce():e.db.getAuthorizationToken(),o=B.create("query",r,{query:btoa(JSON.stringify(e.statement.getTokenizedStatement())),bindings:btoa(Object(J.b)(JSON.stringify(e.statement.getBindingData()))),applicationConfig:btoa(e.db.getApplicationConfig())});j.makeRequest(i,j.REQUEST_METHOD_POST,j.REQUEST_CONTENT_TYPE_X_WWW_FORM_URLENCODED,j.REQUEST_RESPONSE_TYPE_JSON,j.encodeData(o)).then((function(n){t(e.createStatementResult(n))})).catch((function(e){n(new Error(e))}))}))}}},{key:"createStatementResult",value:function(e){if(!M()(e,Object))throw new Error("Object expected!");if(void 0===e.resultType)throw new Error('Property "resultType" expected!');switch(e.resultType){case r.SELECT:var t=new W;return t.addRows(e.rows),t.withCalcFoundRows(e.foundRows),t;case r.UPDATE:var n=new q;return n.withAffectedRows(parseInt(e.affectedRows)||0),n;case r.INSERT:var i=new Y;return i.withLastInsertId(parseInt(e.lastInsertId)||0),i.withAffectedRows(1),i;case r.DELETE:var o=new q;return o.withAffectedRows(parseInt(e.affectedRows)||0),o;default:throw new Error("Invalid server response resultType: ".concat(JSON.stringify(e.resultType)))}}}]),e}(),K=function(){function e(t,n,i){E()(this,e),x()(this,"statement",void 0),x()(this,"db",void 0),x()(this,"bindings",void 0),this.statement=t,this.db=n,this.bindings=i}return T()(e,[{key:"execute",value:function(){var t=this;return function(){return new Promise((function(n,i){try{t.statement.bind(t.bindings,t.db)}catch(a){return void i(a)}var r;if(t.statement.getTable())t.db.getTable(t.statement.getTable().getName()).fetch().then((function(o){try{r=t.applyLimit(t.applyColumnFiltering(t.applySorting(t.getStatementCandidateRows(o))));var s=(new W).addRows(r);t.statement.getUnion()?new e(t.statement.getUnion(),t.db,t.bindings).execute()().then((function(e){s.addRows(e.getRows()),n(s)})).catch((function(e){i(e)})):n(s)}catch(a){console.error(a),i(new Error("Failed to execute SELECT statement!"))}})).catch((function(e){console.error(e),i(new Error("Failed to fetch table from server!"))}));else try{r=[t.createSingleStatementRow()];var o=(new W).addRows(r);t.statement.getUnion()?new e(t.statement.getUnion(),t.db,t.bindings).execute()().then((function(e){o.addRows(e.getRows()),n(o)})).catch((function(e){i(e)})):n(o)}catch(a){console.error(a),i(new Error("Failed to execute INSERT statement!"))}}))}}},{key:"createSingleStatementRow",value:function(){var e,t,n=Object.create(null),i=new G([],[],0),r=this.statement.getFields();if(r.isSelectingAllFields())return n;for(var o=0,a=r.getFields(),s=a.length;o<s;o++)t=a[o].getLiteral(),e=a[o].getExpression().compute(i),null===t&&(t=a[o].getExpression().getLiteral()),n[t]=e;return n}},{key:"getStatementCandidateRows",value:function(e){var t,n,i,r,o,a,s=e.createIterator(),l=[],u=this.statement.getFields(),c=u.isSelectingAllFields(),d=u,h=this.statement.getFilter();for(c||(n=d.getFields());t=s.next();)if(!h||!!h.compute(t))if(c)l.push(t.toObject());else{i=Object.create(null);for(var f=0,g=n.length;f<g;f++)a=n[f].getLiteral(),o=n[f].getExpression().compute(t),null===a&&(a=n[f].getExpression().getLiteral()),i[a]=o;for(var p in(r=t.toObject())["."]=i,i)r[p]=i[p];l.push(r)}return l}},{key:"applySorting",value:function(e){var t=this.statement.getSorter();if(!t||e.length<2)return e;if(t.isRandom())return j.shuffleArray(e);var n=t.getSortExpressions(),i=n.length,r=function(){for(var e=[],t=0;t<i;t++)t===i-1?e.push(function(e){return function(t,i){var r=n[e].getExpression().compute(t),o=n[e].getExpression().compute(i),a=j.compare(r,o);return n[e].getDirection()===l.DESCENDING&&(a=-a),a}}(t)):e.push(function(t){return function(i,r){var o=n[t].getExpression().compute(i),a=n[t].getExpression().compute(r),s=j.compare(o,a);return n[t].getDirection()===l.DESCENDING&&(s=-s),0===s?e[t+1](i,r):s}}(t));return function(t,n){return e[0](G.createFromObject(t),G.createFromObject(n))}}();return e.sort(r)}},{key:"applyLimit",value:function(e){var t=this.statement.getLimit();return t?e.slice(t.getSkip(),t.getSkip()+t.getLimit()):e}},{key:"applyColumnFiltering",value:function(e){for(var t=[],n=0,i=e.length;n<i;n++)t.push(void 0===e[n]["."]?e[n]:e[n]["."]);return t}}]),e}(),$=function(){function e(t,n,i){E()(this,e),x()(this,"statement",void 0),x()(this,"db",void 0),x()(this,"markedRowsForUpdate",void 0),x()(this,"bindings",void 0),this.statement=t,this.db=n,this.bindings=i}return T()(e,[{key:"execute",value:function(){var e=this;return function(){return new Promise((function(t,n){try{e.statement.bind(e.bindings,e.db)}catch(i){return void n(i)}e.db.getTable(e.statement.getTable().getName()).fetch().then((function(r){r.isTransactional()&&r.startTransaction();try{e.markedRowsForUpdate=[];for(var o,a=r.createIterator(),s=e.statement.getFilter();o=a.next();)(null===s||!!s.compute(o))&&e.markedRowsForUpdate.push({rowIndex:o.getRowIndex(),values:o.getDataAsArray()});if(!e.markedRowsForUpdate.length)return r.isTransactional()&&r.commitTransaction(),void t((new q).withAffectedRows(0));if(e.applySorting(),e.applyLimits(),!e.markedRowsForUpdate.length)return r.isTransactional()&&r.commitTransaction(),void t((new q).withAffectedRows(0));for(var l,u,c=(new q).withAffectedRows(e.markedRowsForUpdate.length),d=G.createFromTable(r),h=e.statement.getFields(),f=h.length,g=0,p=e.markedRowsForUpdate.length;g<p;g++){d.withIndex(e.markedRowsForUpdate[g].rowIndex).withRowData(e.markedRowsForUpdate[g].values);for(var v=0;v<f;v++)l=h[v].getFieldName(),u=h[v].getExpression().compute(d),d.setColumnValue(l,u);r.replace(e.markedRowsForUpdate[g].rowIndex,d.getDataAsArray())}r.reIndex(),r.isTransactional()&&r.commitTransaction(),t(c)}catch(i){console.error(i),r.isTransactional()&&r.rollbackTransaction(),n(new Error("Failed to execute UPDATE statement!"))}})).catch((function(e){console.error(e),n(new Error("Failed to fetch table from server!"))}))}))}}},{key:"applySorting",value:function(){var e=this.statement.getSorter(),t=this.db.getTable(this.statement.getTable().getName());if(e&&!(this.markedRowsForUpdate.length<2)){if(e.isRandom())return j.shuffleArray(this.markedRowsForUpdate);var n=e.getSortExpressions(),i=n.length,r=function(){for(var e=[],r=0;r<i;r++)r===i-1?e.push(function(e){return function(t,i){var r=n[e].getExpression().compute(t),o=n[e].getExpression().compute(i),a=j.compare(r,o);return n[e].getDirection()===l.DESCENDING&&(a=-a),a}}(r)):e.push(function(t){return function(i,r){var o=n[t].getExpression().compute(i),a=n[t].getExpression().compute(r),s=j.compare(o,a);return n[t].getDirection()===l.DESCENDING&&(s=-s),0===s?e[t+1](i,r):s}}(r));return function(n,i){return e[0](G.createFromTable(t).withRowData(n.values).withIndex(-1),G.createFromTable(t).withRowData(i.values).withIndex(-1))}}();this.markedRowsForUpdate.sort(r)}}},{key:"applyLimits",value:function(){var e=this.statement.getLimit();e&&(this.markedRowsForUpdate=this.markedRowsForUpdate.slice(e.getSkip(),e.getSkip()+e.getLimit()))}}]),e}(),X=function(){function e(t){E()(this,e),x()(this,"queryId",0),x()(this,"database",void 0),x()(this,"queue",[]),x()(this,"isRunning",!1),this.database=t}return T()(e,[{key:"scheduleStatement",value:function(e,t){var n=this;return new Promise((function(i,r){n.queryId++,n.queue.push({queryId:n.queryId,statement:e,strategy:t,resolve:i,reject:r}),1!==n.queue.length||n.isRunning||(n.database.trigger("busy"),n.next())}))}},{key:"next",value:function(){var e=this;if(!this.isRunning){var t=this.queue.shift();if(void 0!==t){this.isRunning=!0;var n=function(){t.strategy.execute()().then((function(e){t.resolve(e)})).catch((function(e){t.reject(e)})).finally((function(){e.isRunning=!1,e.queue.length?e.next():e.database.trigger("idle")}))};0===this.queue.length%5?setTimeout(n):n()}else this.database.trigger("idle")}}}]),e}(),Z=function e(){E()(this,e)},ee=function(e){function t(){var e,n;E()(this,t);for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];return n=C()(this,(e=S()(t)).call.apply(e,[this].concat(r))),x()(O()(n),"literal",void 0),n}return A()(t,e),T()(t,[{key:"getOpcodeType",value:function(){return i.EXPRESSION}},{key:"getLiteral",value:function(){return void 0!==this.literal?this.literal:(this.literal=this.toString().replace(/["']+/g,"").trim(),this.literal)}}]),t}(Z),te=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"bindingName",void 0),x()(O()(n),"bindingValue",void 0),n.bindingName=e.name,n}return A()(t,e),T()(t,[{key:"getExpressionType",value:function(){return a.BINDING}},{key:"getBindingName",value:function(){return this.bindingName}},{key:"getBindedValue",value:function(){if(void 0===this.bindingValue)throw new Error("Binding "+JSON.stringify(this.bindingName)+" is not binded!");return this.bindingValue}},{key:"getBindings",value:function(){return[this]}},{key:"getFunctions",value:function(){return[]}},{key:"getIdentifiers",value:function(){return[]}},{key:"bind",value:function(e){return this.bindingValue=e,this}},{key:"unbind",value:function(){return this.bindingValue=void 0,this}},{key:"compute",value:function(e){if(void 0!==this.bindingValue)return this.bindingValue;throw new Error("Failed to compute binding: Binding "+this.bindingName+" is not binded!")}},{key:"toString",value:function(){return":"+this.bindingName}}]),t}(ee),ne=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"value",void 0),n.value=e.value,n}return A()(t,e),T()(t,[{key:"getExpressionType",value:function(){return a.BOOLEAN}},{key:"getBindings",value:function(){return[]}},{key:"getIdentifiers",value:function(){return[]}},{key:"getFunctions",value:function(){return[]}},{key:"compute",value:function(e){return this.value}},{key:"toString",value:function(){return String(this.value)}}]),t}(ee),ie=function(e){function t(e){var n;E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"functionName",void 0),x()(O()(n),"arguments",[]),x()(O()(n),"database",null),n.functionName=e.function_name;for(var i=0,r=e.arguments.length;i<r;i++)n.arguments.push(Ye.create(e.arguments[i]));return n}return A()(t,e),T()(t,[{key:"getExpressionType",value:function(){return a.FUNCTION_CALL}},{key:"getFunctionName",value:function(){return this.functionName}},{key:"getArguments",value:function(){return this.arguments}},{key:"getBindings",value:function(){for(var e=[],t=0,n=this.arguments.length;t<n;t++)for(var i=0,r=this.arguments[t].getBindings(),o=r.length;i<o;i++)e.push(r[i]);return e}},{key:"getFunctions",value:function(){for(var e=[this],t=0,n=this.arguments.length;t<n;t++)for(var i=0,r=this.arguments[t].getFunctions(),o=r.length;i<o;i++)e.push(r[i]);return e}},{key:"getIdentifiers",value:function(){for(var e=[],t=0,n=this.arguments.length;t<n;t++)for(var i=0,r=this.arguments[t].getIdentifiers(),o=r.length;i<o;i++)e.push(r[i]);return e}},{key:"withDatabase",value:function(e){return this.database=e||null,this}},{key:"compute",value:function(e){if(this.database){for(var t=[],n=0,i=this.arguments.length;n<i;n++)t.push(this.arguments[n].compute(e));return this.database.callFunction(this.functionName,t)}throw new Error("Failed to call function "+JSON.stringify(this.functionName)+": Database not binded to function!")}},{key:"toString",value:function(){for(var e=this.functionName+"(",t=0,n=this.arguments.length;t<n;t++)e+=(0===t?"":", ")+this.arguments[t].toString();return e+")"}}]),t}(ee),re=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"expression",void 0),n.expression=Ye.create(e.expression),n}return A()(t,e),T()(t,[{key:"getExpressionType",value:function(){return a.GROUP}},{key:"getBindings",value:function(){return this.expression.getBindings()}},{key:"getFunctions",value:function(){return this.expression.getFunctions()}},{key:"getIdentifiers",value:function(){return this.expression.getIdentifiers()}},{key:"compute",value:function(e){return this.expression.compute(e)}},{key:"toString",value:function(){return"("+this.expression.toString()+")"}}]),t}(ee),oe=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"identifierName",void 0),n.identifierName=e.name,n}return A()(t,e),T()(t,[{key:"getExpressionType",value:function(){return a.IDENTIFIER}},{key:"getIdentifierName",value:function(){return this.identifierName}},{key:"getBindings",value:function(){return[]}},{key:"getFunctions",value:function(){return[]}},{key:"getIdentifiers",value:function(){return[this]}},{key:"compute",value:function(e){return e.getColumnValue(this.identifierName)}},{key:"toString",value:function(){return this.identifierName}}]),t}(ee),ae=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"left",void 0),x()(O()(n),"right",void 0),n.left=Ye.create(e.left),n.right=null===e.right?null:Ye.create(e.right),n}return A()(t,e),T()(t,[{key:"getExpressionType",value:function(){return a.LOGICAL}},{key:"getLeftOperand",value:function(){return this.left}},{key:"getRightOperand",value:function(){return this.right}},{key:"getBindings",value:function(){for(var e=[],t=0,n=this.left.getBindings(),i=n.length;t<i;t++)e.push(n[t]);for(var r=0,o=this.right.getBindings(),a=o.length;r<a;r++)e.push(o[r]);return e}},{key:"getFunctions",value:function(){for(var e=[],t=0,n=this.left.getFunctions(),i=n.length;t<i;t++)e.push(n[t]);for(var r=0,o=this.right.getFunctions(),a=o.length;r<a;r++)e.push(o[r]);return e}},{key:"getIdentifiers",value:function(){for(var e=[],t=0,n=this.left.getIdentifiers(),i=n.length;t<i;t++)e.push(n[t]);for(var r=0,o=this.right.getIdentifiers(),a=o.length;r<a;r++)e.push(o[r]);return e}}]),t}(ee),se=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return c.AND}},{key:"compute",value:function(e){return!(!this.left.compute(e)||!this.right.compute(e))}},{key:"toString",value:function(){return this.left.toString()+" and "+this.right.toString()}}]),t}(ae),le=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return d.EQUALS}},{key:"compute",value:function(e){var t=this.left.compute(e),n=this.right.compute(e);return isNaN(t)||isNaN(n)?t!=n||0!==j.compareAsStrings(t,n):Number(t)!=Number(n)}},{key:"toString",value:function(){return this.left.toString()+" <> "+this.right.toString()}}]),t}(ae),ue=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return d.EQUALS}},{key:"compute",value:function(e){var t=this.left.compute(e),n=this.right.compute(e);return isNaN(t)||isNaN(n)?t==n||0===j.compareAsStrings(t,n):Number(t)==Number(n)}},{key:"toString",value:function(){return this.left.toString()+" = "+this.right.toString()}}]),t}(ae),ce=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return d.GT}},{key:"compute",value:function(e){var t=this.left.compute(e),n=this.right.compute(e);return isNaN(t)||isNaN(n)?t>n||j.compareAsStrings(t,n)<0:Number(t)>Number(n)}},{key:"toString",value:function(){return this.left.toString()+" > "+this.right.toString()}}]),t}(ae),de=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return d.GTE}},{key:"compute",value:function(e){var t=this.left.compute(e),n=this.right.compute(e);return isNaN(t)||isNaN(n)?t>=n||j.compareAsStrings(t,n)<=0:Number(t)>=Number(n)}},{key:"toString",value:function(){return this.left.toString()+" >= "+this.right.toString()}}]),t}(ae),he=function(e){function t(e){var n;E()(this,t),n=C()(this,S()(t).call(this,e)),x()(O()(n),"haystack",[]);for(var i=0,r=e.haystack.length;i<r;i++)n.haystack.push(Ye.create(e.haystack[i]));return n}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return d.IN}},{key:"compute",value:function(e){for(var t=this.left.compute(e),n=0,i=this.haystack.length;n<i;n++)if(this.equals(t,this.haystack[n].compute(e)))return!0;return!1}},{key:"equals",value:function(e,t){return isNaN(e)||isNaN(t)?e==t||0===j.compareAsStrings(e,t):Number(e)==Number(t)}},{key:"toString",value:function(){for(var e=this.left.toString()+" IN(",t=[],n=0,i=this.haystack.length;n<i;n++)t.push(this.haystack[n].toString());return e+t.join(", ")+")"}},{key:"getBindings",value:function(){for(var e=[],t=0,n=this.left.getBindings(),i=n.length;t<i;t++)e.push(n[t]);for(var r=0,o=this.haystack.length;r<o;r++)for(var a=0,s=this.haystack[r].getBindings(),l=s.length;a<l;a++)e.push(s[a]);return e}},{key:"getFunctions",value:function(){for(var e=[],t=0,n=this.left.getFunctions(),i=n.length;t<i;t++)e.push(n[t]);for(var r=0,o=this.haystack.length;r<o;r++)for(var a=0,s=this.haystack[r].getFunctions(),l=s.length;a<l;a++)e.push(s[a]);return e}},{key:"getIdentifiers",value:function(){for(var e=[],t=0,n=this.left.getIdentifiers(),i=n.length;t<i;t++)e.push(n[t]);for(var r=0,o=this.haystack.length;r<o;r++)for(var a=0,s=this.haystack[r].getIdentifiers(),l=s.length;a<l;a++)e.push(s[a]);return e}}]),t}(ae),fe=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return d.LIKE}},{key:"compute",value:function(e){return this.like(this.left.compute(e),this.right.compute(e))}},{key:"like",value:function(e,t){var n=j.castToString(e),i=j.castToString(t);return this.buildRegularExpression(i).test(n)}},{key:"buildRegularExpression",value:function(e){for(var t="^",n="",i=0,r=e.length;i<r;i++)switch(n=e.charAt(i)){case"%":t+="(.*)";break;case"\n":t+="\\n";break;case"\r":t+="\\r";break;case"\t":t+="\\t";break;case".":case"-":case"[":case"]":case"(":case")":case"?":case"!":case"^":case"$":case"\\":case"/":t+="\\"+n;break;default:t+=n}return new RegExp(t+"$","i")}},{key:"toString",value:function(){return this.left.toString()+" LIKE "+this.right.toString()}}]),t}(ae),ge=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return d.LT}},{key:"compute",value:function(e){var t=this.left.compute(e),n=this.right.compute(e);return isNaN(t)||isNaN(n)?t<n||j.compareAsStrings(t,n)>0:Number(t)<Number(n)}},{key:"toString",value:function(){return this.left.toString()+" < "+this.right.toString()}}]),t}(ae),pe=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return d.LTE}},{key:"compute",value:function(e){var t=this.left.compute(e),n=this.right.compute(e);return isNaN(t)||isNaN(n)?t<=n||j.compareAsStrings(t,n)>=0:Number(t)<=Number(n)}},{key:"toString",value:function(){return this.left.toString()+" <= "+this.right.toString()}}]),t}(ae),ve=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return c.OR}},{key:"compute",value:function(e){return!(!this.left.compute(e)&&!this.right.compute(e))}},{key:"toString",value:function(){return this.left.toString()+" or "+this.right.toString()}}]),t}(ae),me=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"left",void 0),x()(O()(n),"right",void 0),n.left=Ye.create(e.left),n.right=Ye.create(e.right),n}return A()(t,e),T()(t,[{key:"getExpressionType",value:function(){return a.MATH}},{key:"getLeftOperand",value:function(){return this.left}},{key:"getRightOperand",value:function(){return this.right}},{key:"getBindings",value:function(){for(var e=[],t=0,n=this.left.getBindings(),i=n.length;t<i;t++)e.push(n[t]);for(var r=0,o=this.right.getBindings(),a=o.length;r<a;r++)e.push(o[r]);return e}},{key:"getFunctions",value:function(){for(var e=[],t=0,n=this.left.getFunctions(),i=n.length;t<i;t++)e.push(n[t]);for(var r=0,o=this.right.getFunctions(),a=o.length;r<a;r++)e.push(o[r]);return e}},{key:"getIdentifiers",value:function(){for(var e=[],t=0,n=this.left.getIdentifiers(),i=n.length;t<i;t++)e.push(n[t]);for(var r=0,o=this.right.getIdentifiers(),a=o.length;r<a;r++)e.push(o[r]);return e}}]),t}(ee),ye=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return h.ADDITION}},{key:"compute",value:function(e){return Number((Number(this.left.compute(e))+Number(this.right.compute(e))).toFixed(6))}},{key:"toString",value:function(){return this.left.toString()+" + "+this.right.toString()}}]),t}(me),be=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return h.DIFFERENCE}},{key:"compute",value:function(e){return Number((Number(this.left.compute(e))-Number(this.right.compute(e))).toFixed(6))}},{key:"toString",value:function(){return this.left.toString()+" - "+this.right.toString()}}]),t}(me),Ee=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return h.DIVISION}},{key:"compute",value:function(e){return Number((Number(this.left.compute(e))/Number(this.right.compute(e))).toFixed(6))}},{key:"toString",value:function(){return this.left.toString()+" / "+this.right.toString()}}]),t}(me),we=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return h.MULTIPLY}},{key:"compute",value:function(e){return Number((Number(this.left.compute(e))*Number(this.right.compute(e))).toFixed(6))}},{key:"toString",value:function(){return this.left.toString()+" * "+this.right.toString()}}]),t}(me),Te=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getExpressionType",value:function(){return a.NULL}},{key:"getBindings",value:function(){return[]}},{key:"getFunctions",value:function(){return[]}},{key:"getIdentifiers",value:function(){return[]}},{key:"compute",value:function(e){return null}},{key:"toString",value:function(){return"null"}}]),t}(ee),Ne=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"value",void 0),n.value=e.value,n}return A()(t,e),T()(t,[{key:"getExpressionType",value:function(){return a.NUMBER}},{key:"getBindings",value:function(){return[]}},{key:"getFunctions",value:function(){return[]}},{key:"getIdentifiers",value:function(){return[]}},{key:"compute",value:function(e){return this.value}},{key:"toString",value:function(){return String(this.value)}}]),t}(ee),Ce=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"value",void 0),n.value=e.value,n}return A()(t,e),T()(t,[{key:"getExpressionType",value:function(){return a.STRING}},{key:"getBindings",value:function(){return[]}},{key:"getFunctions",value:function(){return[]}},{key:"getIdentifiers",value:function(){return[]}},{key:"compute",value:function(e){return this.value}},{key:"toString",value:function(){return JSON.stringify(this.value)}}]),t}(ee),ke=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"operand",void 0),n.operand=Ye.create(e.left),n}return A()(t,e),T()(t,[{key:"getExpressionType",value:function(){return a.UNARY}},{key:"getOperand",value:function(){return this.operand}},{key:"getBindings",value:function(){return this.operand.getBindings()}},{key:"getFunctions",value:function(){return this.operand.getFunctions()}},{key:"getIdentifiers",value:function(){return this.operand.getIdentifiers()}}]),t}(ee),Se=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return u.INVERT}},{key:"compute",value:function(e){var t=this.operand.compute(e);return null===t?null:!0===t?-1:!1===t?0:isNaN(t)?0:-t}},{key:"toString",value:function(){return"-"+this.operand.toString()}}]),t}(ke),Ie=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOperator",value:function(){return u.NOT}},{key:"compute",value:function(e){return console.warn('TODO: Properly implement "Unary !" operator'),!this.operand.compute(e)}},{key:"toString",value:function(){return"!"+this.operand.toString()}}]),t}(ke),Oe=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"limit",void 0),x()(O()(n),"skip",void 0),n.limit=e.limit,n.skip=e.skip,n}return A()(t,e),T()(t,[{key:"getOpcodeType",value:function(){return i.LIMIT_OPTION}},{key:"getLimit",value:function(){return this.limit}},{key:"getSkip",value:function(){return this.skip}}]),t}(Z),De=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"direction",void 0),x()(O()(n),"expression",void 0),n.direction=e.direction,n.expression=Ye.create(e.expression),n}return A()(t,e),T()(t,[{key:"getOpcodeType",value:function(){return i.ORDER_BY_EXPRESSION}},{key:"getDirection",value:function(){return this.direction}},{key:"getExpression",value:function(){return this.expression}}]),t}(Z),Ae=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"strategy",void 0),n.strategy=e.type,n}return A()(t,e),T()(t,[{key:"getOpcodeType",value:function(){return i.ORDER_BY_OPTION}}]),t}(Z),Re=function(e){function t(e){var n;E()(this,t),n=C()(this,S()(t).call(this,e)),x()(O()(n),"expressions",[]);for(var i=0,r=e.fields.length;i<r;i++)n.expressions.push(Ye.create(e.fields[i]));return n}return A()(t,e),T()(t,[{key:"getSortExpressions",value:function(){return this.expressions}},{key:"isRandom",value:function(){return!1}}]),t}(Ae),xe=function(e){function t(e){return E()(this,t),C()(this,S()(t).call(this,e))}return A()(t,e),T()(t,[{key:"isRandom",value:function(){return!0}}]),t}(Ae),_e=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"remote",void 0),x()(O()(n),"binded",void 0),x()(O()(n),"statement",void 0),n.remote=e.remote,n.statement=e,n}return A()(t,e),T()(t,[{key:"getOpcodeType",value:function(){return i.STATEMENT}},{key:"isRemote",value:function(){return this.remote}},{key:"bind",value:function(e,t){this.binded=!1;for(var n,i=this.getBindings(),r=i.length,o=e?"function"===typeof e?e():e:{},a=0;a<r;a++)i[a].unbind();for(var s=0;s<r;s++)if(void 0===o[n=i[s].getBindingName()]){if(!t||!t.autoBind(n,i[s]))throw new Error("Failed to bind statement: Binding "+JSON.stringify(n)+" is not defined in bind object, and is also not auto bindable!")}else i[s].bind(o[n]);return this.binded=!0,this}},{key:"getBindingData",value:function(){for(var e,t={},n=this.getBindings(),i=0,r=n.length;i<r;i++)void 0===t[e=n[i].getBindingName()]&&(t[e]=n[i].getBindedValue());return t}},{key:"isBinded",value:function(){return this.binded}},{key:"getTokenizedStatement",value:function(){return JSON.parse(JSON.stringify(this.statement))}}]),t}(Z),Le=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this,e)),x()(O()(n),"table",void 0),x()(O()(n),"filter",null),x()(O()(n),"sorter",null),x()(O()(n),"limit",null),n.table=Ye.create(e.table),e.where&&(n.filter=Ye.create(e.where)),e.orderBy&&(n.sorter=Ye.create(e.orderBy)),e.limit&&(n.limit=Ye.create(e.limit)),n}return A()(t,e),T()(t,[{key:"getStatementType",value:function(){return r.DELETE}},{key:"getTable",value:function(){return this.table}},{key:"getFilter",value:function(){return this.filter}},{key:"getSorter",value:function(){return this.sorter}},{key:"getLimit",value:function(){return this.limit}},{key:"getBindings",value:function(){var e=[];if(this.filter)for(var t=this.filter.getBindings(),n=0,i=t.length;n<i;n++)e.push(t[n]);if(this.sorter&&!this.sorter.isRandom())for(var r=0,o=this.sorter.getSortExpressions(),a=o.length;r<a;r++)for(var s=0,l=o[r].getExpression().getBindings(),u=l.length;s<u;s++)e.push(l[r]);return e}},{key:"getFunctions",value:function(){var e=[];if(null!==this.filter)for(var t=this.filter.getFunctions(),n=0,i=t.length;n<i;n++)e.push(t[n]);if(null!==this.sorter&&!this.sorter.isRandom())for(var r=0,o=this.sorter.getSortExpressions(),a=o.length;r<a;r++)for(var s=0,l=o[r].getExpression().getFunctions(),u=l.length;s<u;s++)e.push(l[r]);return e}},{key:"getIdentifiers",value:function(){var e=[];if(null!==this.filter)for(var t=this.filter.getIdentifiers(),n=0,i=t.length;n<i;n++)e.push(t[n]);if(null!==this.sorter&&!this.sorter.isRandom())for(var r=0,o=this.sorter.getSortExpressions(),a=o.length;r<a;r++)for(var s=0,l=o[r].getExpression().getIdentifiers(),u=l.length;s<u;s++)e.push(l[s]);return e}}]),t}(_e),Me=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"literal",null),x()(O()(n),"expression",void 0),n.literal=e.literal,n.expression=Ye.create(e.expression),n}return A()(t,e),T()(t,[{key:"getOpcodeType",value:function(){return i.FIELD}},{key:"getLiteral",value:function(){return this.literal}},{key:"getExpression",value:function(){return this.expression}}]),t}(Z),Fe=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getOpcodeType",value:function(){return i.FIELDS_LIST}}]),t}(Z),Pe=function(e){function t(e){return E()(this,t),C()(this,S()(t).call(this))}return A()(t,e),T()(t,[{key:"isSelectingAllFields",value:function(){return!0}}]),t}(Fe),Be=function(e){function t(e){var n;E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"fields",[]);for(var i=0,r=e.fields.length;i<r;i++)n.fields.push(Ye.create(e.fields[i]));return n}return A()(t,e),T()(t,[{key:"getFields",value:function(){return this.fields}},{key:"isSelectingAllFields",value:function(){return!1}}]),t}(Fe),Ue=function(e){function t(e){var n;E()(this,t),n=C()(this,S()(t).call(this,e)),x()(O()(n),"table",void 0),x()(O()(n),"fields",[]),n.table=Ye.create(e.table);for(var i=0,r=e.fields.length;i<r;i++)n.fields.push(Ye.create(e.fields[i]));return n}return A()(t,e),T()(t,[{key:"getStatementType",value:function(){return r.INSERT}},{key:"getTable",value:function(){return this.table}},{key:"getFields",value:function(){return this.fields}},{key:"getBindings",value:function(){for(var e=[],t=0,n=this.fields.length;t<n;t++)for(var i=0,r=this.fields[t].getExpression().getBindings(),o=r.length;i<o;i++)e.push(r[i]);return e}},{key:"getFunctions",value:function(){for(var e=[],t=0,n=this.fields.length;t<n;t++)for(var i=0,r=this.fields[t].getExpression().getFunctions(),o=r.length;i<o;i++)e.push(r[i]);return e}},{key:"getIdentifiers",value:function(){for(var e=[],t=0,n=this.fields.length;t<n;t++)for(var i=0,r=this.fields[t].getExpression().getIdentifiers(),o=r.length;i<o;i++)e.push(r[i]);return e}}]),t}(_e),Ve=n(10),je=n.n(Ve),Ge=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this,e)),x()(O()(n),"fields",void 0),x()(O()(n),"table",null),x()(O()(n),"filter",null),x()(O()(n),"sorter",null),x()(O()(n),"limit",null),x()(O()(n),"calcFoundRows",void 0),x()(O()(n),"union",null),x()(O()(n),"previous",null),n.calcFoundRows=e.calcFoundRows,n.fields=Ye.create(e.fields),e.table&&(n.table=Ye.create(e.table),e.where&&(n.filter=Ye.create(e.where)),e.orderBy&&(n.sorter=Ye.create(e.orderBy)),e.limit&&(n.limit=Ye.create(e.limit))),e.union&&(n.union=Ye.create(e.union).withPreviousStatement(O()(n))),n}return A()(t,e),T()(t,[{key:"isRemote",value:function(){return this.previous?this.previous.isRemote():je()(S()(t.prototype),"isRemote",this).call(this)}},{key:"getStatementType",value:function(){return r.SELECT}},{key:"getFields",value:function(){return this.fields}},{key:"getTable",value:function(){return this.table}},{key:"getFilter",value:function(){return this.filter}},{key:"getSorter",value:function(){return this.sorter}},{key:"getLimit",value:function(){return this.limit}},{key:"getUnion",value:function(){return this.union}},{key:"withPreviousStatement",value:function(e){return this.previous=e||null,this}},{key:"getBindings",value:function(){var e=[];if(null!==this.fields&&!this.fields.isSelectingAllFields())for(var t=0,n=this.fields.getFields(),i=n.length;t<i;t++)for(var r=0,o=n[t].getExpression().getBindings(),a=o.length;r<a;r++)e.push(o[r]);if(null!==this.filter)for(var s=this.filter.getBindings(),l=0,u=s.length;l<u;l++)e.push(s[l]);if(null!==this.sorter&&!this.sorter.isRandom())for(var c=0,d=this.sorter.getSortExpressions(),h=d.length;c<h;c++)for(var f=0,g=d[c].getExpression().getBindings(),p=g.length;f<p;f++)e.push(g[c]);return e}},{key:"getFunctions",value:function(){var e=[];if(null!==this.fields&&!this.fields.isSelectingAllFields())for(var t=0,n=this.fields.getFields(),i=n.length;t<i;t++)for(var r=0,o=n[t].getExpression().getFunctions(),a=o.length;r<a;r++)e.push(o[r]);if(null!==this.filter)for(var s=this.filter.getFunctions(),l=0,u=s.length;l<u;l++)e.push(s[l]);if(null!==this.sorter&&!this.sorter.isRandom())for(var c=0,d=this.sorter.getSortExpressions(),h=d.length;c<h;c++)for(var f=0,g=d[c].getExpression().getFunctions(),p=g.length;f<p;f++)e.push(g[c]);if(null!==this.union)for(var v=this.union.getFunctions(),m=0,y=v.length;m<y;m++)e.push(v[m]);return e}},{key:"getIdentifiers",value:function(){var e=[];if(null!==this.fields&&!this.fields.isSelectingAllFields())for(var t=0,n=this.fields.getFields(),i=n.length;t<i;t++)for(var r=0,o=n[t].getExpression().getIdentifiers(),a=o.length;r<a;r++)e.push(o[r]);if(null!==this.filter)for(var s=this.filter.getIdentifiers(),l=0,u=s.length;l<u;l++)e.push(s[l]);if(null!==this.sorter&&!this.sorter.isRandom())for(var c=0,d=this.sorter.getSortExpressions(),h=d.length;c<h;c++)for(var f=0,g=d[c].getExpression().getIdentifiers(),p=g.length;f<p;f++)e.push(g[f]);return e}},{key:"getCalcFoundRows",value:function(){return this.calcFoundRows}}]),t}(_e),qe=function(e){function t(e){var n;E()(this,t),n=C()(this,S()(t).call(this,e)),x()(O()(n),"table",void 0),x()(O()(n),"fields",[]),x()(O()(n),"filter",null),x()(O()(n),"limit",null),x()(O()(n),"sorter",null),x()(O()(n),"timer",null),n.table=Ye.create(e.table),e.delayed&&(n.timer=Ye.create(e.delayed));for(var i=0,r=e.fields.length;i<r;i++)n.fields.push(Ye.create(e.fields[i]));return e.where&&(n.filter=Ye.create(e.where)),e.limit&&(n.limit=Ye.create(e.limit)),e.orderBy&&(n.sorter=Ye.create(e.orderBy)),n}return A()(t,e),T()(t,[{key:"getStatementType",value:function(){return r.UPDATE}},{key:"getTimer",value:function(){return this.timer}},{key:"getTable",value:function(){return this.table}},{key:"getFields",value:function(){return this.fields}},{key:"getFilter",value:function(){return this.filter}},{key:"getSorter",value:function(){return this.sorter}},{key:"getLimit",value:function(){return this.limit}},{key:"getBindings",value:function(){for(var e=[],t=0,n=this.fields.length;t<n;t++)for(var i=0,r=this.fields[t].getExpression().getBindings(),o=r.length;i<o;i++)e.push(r[i]);if(this.filter)for(var a=0,s=this.filter.getBindings(),l=s.length;a<l;a++)e.push(s[a]);if(this.sorter&&!this.sorter.isRandom())for(var u=0,c=this.sorter.getSortExpressions(),d=c.length;u<d;u++)for(var h=0,f=c[u].getExpression().getBindings(),g=f.length;h<g;h++)e.push(f[u]);return e}},{key:"getFunctions",value:function(){for(var e=[],t=0,n=this.fields.length;t<n;t++)for(var i=0,r=this.fields[t].getExpression().getFunctions(),o=r.length;i<o;i++)e.push(r[i]);if(this.filter)for(var a=0,s=this.filter.getFunctions(),l=s.length;a<l;a++)e.push(s[a]);if(this.sorter&&!this.sorter.isRandom())for(var u=0,c=this.sorter.getSortExpressions(),d=c.length;u<d;u++)for(var h=0,f=c[u].getExpression().getFunctions(),g=f.length;h<g;h++)e.push(f[u]);return e}},{key:"getIdentifiers",value:function(){for(var e=[],t=0,n=this.fields.length;t<n;t++)for(var i=0,r=this.fields[t].getExpression().getIdentifiers(),o=r.length;i<o;i++)e.push(r[i]);if(this.filter)for(var a=0,s=this.filter.getIdentifiers(),l=s.length;a<l;a++)e.push(s[a]);if(null!==this.sorter&&!this.sorter.isRandom())for(var u=0,c=this.sorter.getSortExpressions(),d=c.length;u<d;u++)for(var h=0,f=c[u].getExpression().getIdentifiers(),g=f.length;h<g;h++)e.push(f[h]);return e}}]),t}(_e),He=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"timer",void 0),n.timer="number"===typeof e.timer?e.timer:null,n}return A()(t,e),T()(t,[{key:"getOpcodeType",value:function(){return i.DELAYED_OPTION}},{key:"getTimerValueInMilliseconds",value:function(){return this.timer}}]),t}(Z),Qe=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"name",void 0),x()(O()(n),"expression",void 0),n.name=e.name,n.expression=Ye.create(e.expression),n}return A()(t,e),T()(t,[{key:"getOpcodeType",value:function(){return i.UPDATE_FIELD}},{key:"getFieldName",value:function(){return this.name}},{key:"getExpression",value:function(){return this.expression}}]),t}(Z),Je=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"name",void 0),n.name=e.name,n}return A()(t,e),T()(t,[{key:"getOpcodeType",value:function(){return i.TABLE}},{key:"getName",value:function(){return this.name}}]),t}(Z),Ye=function(){function e(){E()(this,e)}return T()(e,null,[{key:"create",value:function(e){switch(e.op){case i.STATEMENT:switch(e.type){case r.SELECT:return new Ge(e);case r.INSERT:return new Ue(e);case r.UPDATE:return new qe(e);case r.DELETE:return new Le(e);default:throw new Error("Cannot create statement from token: "+JSON.stringify(e))}case i.TABLE:return new Je(e);case i.EXPRESSION:switch(e.type){case a.NUMBER:return new Ne(e);case a.BOOLEAN:return new ne(e);case a.NULL:return new Te;case a.STRING:return new Ce(e);case a.UNARY:switch(e.operator){case u.INVERT:return new Se(e);case u.NOT:return new Ie(e);default:throw new Error("Cannot create unary expression from token: "+JSON.stringify(e))}case a.LOGICAL:switch(e.operator){case c.AND:return new se(e);case c.OR:return new ve(e);case d.EQUALS:return new ue(e);case d.DIFFERENT:return new le(e);case d.GT:return new ce(e);case d.GTE:return new de(e);case d.LT:return new ge(e);case d.LTE:return new pe(e);case d.LIKE:return new fe(e);case d.IN:return new he(e);default:throw new Error("Cannot create logical expression from token: "+JSON.stringify(e))}case a.MATH:switch(e.operator){case h.ADDITION:return new ye(e);case h.DIFFERENCE:return new be(e);case h.DIVISION:return new Ee(e);case h.MULTIPLY:return new we(e);default:throw new Error("Cannot create math expression from token: "+JSON.stringify(e))}case a.GROUP:return new re(e);case a.IDENTIFIER:return new oe(e);case a.BINDING:return new te(e);case a.FUNCTION_CALL:return new ie(e);default:throw new Error("Unknown expression type: "+JSON.stringify(e))}case i.FIELDS_LIST:switch(e.type){case o.ALL_FIELDS:return new Pe(e);case o.SPECIFIC_FIELDS:return new Be(e);default:throw new Error("Invalid lexer token select fields type: "+JSON.stringify(e))}case i.FIELD:return new Me(e);case i.UPDATE_FIELD:return new Qe(e);case i.DELAYED_OPTION:return new He(e);case i.LIMIT_OPTION:return new Oe(e);case i.ORDER_BY_OPTION:switch(e.type){case s.RANDOM:return new xe(e);case s.ORDERED:return new Re(e);default:throw new Error("Invalid lexer token ORDER BY: "+JSON.stringify(e))}case i.ORDER_BY_EXPRESSION:return new De(e);default:throw new Error("Invalid lexer token opcode type: "+JSON.stringify(e.op))}}}]),e}(),We=function(){function e(){E()(this,e)}return T()(e,null,[{key:"assertJQLV1ConfigurationStructure",value:function(e){if(!M()(e,Object))throw new Error("Object expected!");if(void 0===e.controlId)throw new Error('Missing property "controlId"');if("string"!==typeof e.controlId)throw new Error('Property "controlId" type should be string');if(void 0===e.eventType)throw new Error('Missing property "eventType"');if("number"!==typeof e.eventType)throw new Error('Property "eventType" type should be number');if(!Array.isArray(e.actions))throw new Error('Missing property "actions"');if(void 0!==e.isRule&&"boolean"!==typeof e.isRule)throw new Error('Property "isRule" type should be boolean|undefined');for(var t=0,n=e.actions.length;t<n;t++)this.assertJQLV1EventActionStructure(e.actions[t])}},{key:"assertJQLV1EventActionStructure",value:function(e){if(!M()(e,Object))throw new Error("Action object expected!");if(void 0===e.controlId)throw new Error('Action property "controlId" type should be string');if("string"!==typeof e.controlId)throw new Error('Action property "controlId" should be string');if(void 0===e.jql)throw new Error('Action property "jql" should be string');if("string"!==typeof e.jql)throw new Error('Action property "jql" should be string')}}]),e}(),ze=function(){function e(t,n){E()(this,e),x()(this,"descriptors",void 0),x()(this,"table",void 0),this.table=t,this.descriptors=(n||[]).slice(0)}return T()(e,[{key:"getDescriptors",value:function(){return this.descriptors}},{key:"getTable",value:function(){return this.table}}]),e}(),Ke=function(e){function t(e,n){return E()(this,t),C()(this,S()(t).call(this,e,[n]))}return A()(t,e),T()(t,[{key:"isUnique",value:function(){return!0}},{key:"isAutoIncrement",value:function(){return null}},{key:"getNextAutoIncrementValue",value:function(){return null}},{key:"index",value:function(){}}]),t}(ze),$e=function(e){function t(e,n){var i;return E()(this,t),i=C()(this,S()(t).call(this,e,[n])),x()(O()(i),"unique",void 0),x()(O()(i),"autoIncrement",void 0),x()(O()(i),"values",void 0),x()(O()(i),"maxAutoIncrement",0),i.unique=!!n.unique,i.autoIncrement=!!n.autoIncrement,i}return A()(t,e),T()(t,[{key:"isUnique",value:function(){return this.unique}},{key:"isAutoIncrement",value:function(){return this.autoIncrement}},{key:"getNextAutoIncrementValue",value:function(){if(this.autoIncrement)return this.maxAutoIncrement+1;throw new Error("Index is not auto-increment!")}},{key:"index",value:function(){this.values=[];var e,t,n=this.table.createIterator();for(this.maxAutoIncrement=0;e=n.next();){var i=e.getColumnValue(this.descriptors[0].name);if(null!==i){var r=String(i).toLowerCase();if(this.values.indexOf(t=r)>-1)throw new Error("Duplicate key "+JSON.stringify(this.descriptors[0].name)+" found with value "+JSON.stringify(t)+" found!");this.values.push(t),this.autoIncrement&&(this.maxAutoIncrement=Math.max(this.maxAutoIncrement,Number(t)))}}}}]),t}(ze),Xe=function(){function e(){E()(this,e)}return T()(e,null,[{key:"createFromIndexDescriptor",value:function(e,t){return e.getStorageEngine()===p.IN_MEMORY?new $e(e,t):new Ke(e,t)}}]),e}(),Ze=function(){function e(t){E()(this,e),x()(this,"identifiers",[]),x()(this,"emptyRow",[]),x()(this,"indexes",[]),x()(this,"autoIncrementColumnIndex",null),x()(this,"autoIncrementValue",1);for(var n=0,i=t||[],r=i.length;n<r;n++)if(this.identifiers.push(i[n]),void 0!==i[n].default)this.emptyRow.push(i[n].default);else switch(t[n].type){case f.NULL:this.emptyRow.push(null);break;case f.NUMBER:this.emptyRow.push(0);break;case f.STRING:this.emptyRow.push("");break;case f.BOOLEAN:this.emptyRow.push(!1);break;default:this.emptyRow.push(null)}}return T()(e,[{key:"withSingleColumnIndex",value:function(e){var t,n=0;if(this.indexes)for(var i=0,r=this.indexes.length;i<r;i++)this.indexes[i].isAutoIncrement()&&n++;if(void 0!==e.unique&&e.unique||void 0!==e.autoIncrement&&e.autoIncrement){if((t=Xe.createFromIndexDescriptor(this,e)).isAutoIncrement()){if(n++,t.getDescriptors().length>1)throw new Error("Auto-increment indexes must refer to a single column only!");if(n>1)throw new Error("There can be only a single auto-increment index!");if(!t.isUnique())throw new Error("Auto-increment indexes must be unique!");for(var o=!1,a=0,s=this.identifiers.length;a<s;a++)if(this.identifiers[a].name===e.name){if(this.autoIncrementColumnIndex=a,o=!0,this.identifiers[a].type!==f.NUMBER)throw new Error("Auto-increment index column type must be NUMBER!");break}if(!o)throw new Error("Cannot add a index on a non-existing column!")}this.indexes.push(t)}return this}},{key:"describe",value:function(){return this.identifiers.slice(0)}},{key:"hasIdentifier",value:function(e){for(var t=0,n=this.identifiers.length;t<n;t++)if(this.identifiers[t].name===e)return!0;return!1}},{key:"createEmptyRow",value:function(){return this.emptyRow.slice(0)}},{key:"getIndexes",value:function(){return this.indexes}},{key:"reIndex",value:function(){for(var e=0,t=this.indexes.length;e<t;e++)this.indexes[e].index(),this.indexes[e].isAutoIncrement()&&this.setNextAutoIncrementValue(this.indexes[e].getNextAutoIncrementValue())}},{key:"fetch",value:function(){return Promise.resolve(this)}}]),e}(),et=function(){function e(t){E()(this,e),x()(this,"table",void 0),x()(this,"index",0),x()(this,"row",void 0),this.table=t,this.row=new G(t.describe(),null,null)}return T()(e,[{key:"next",value:function(){var e=this.table.getRowAt(this.index);return null===e?null:(this.row.withIndex(this.index),this.row.withRowData(e),this.index++,this.row)}}]),e}(),tt=function(e){function t(e,n,i){var r;E()(this,t),r=C()(this,S()(t).call(this,e)),x()(O()(r),"rows",[]),x()(O()(r),"lastTransactionSnapshot",void 0);for(var o=0,a=n.length;o<a;o++)r.rows.push(n[o]);if(i){if(!Array.isArray(i))throw new Error("Invalid class constructor argument: indexes: Expected array!");for(var s=0,l=i.length;s<l;s++)r.withSingleColumnIndex(i[s]);r.reIndex()}return r}return A()(t,e),T()(t,[{key:"isRemote",value:function(){return!1}},{key:"getStorageEngine",value:function(){return p.IN_MEMORY}},{key:"getRowAt",value:function(e){return this.rows[e]||null}},{key:"createIterator",value:function(){return new et(this)}},{key:"replace",value:function(e,t){if(!this.rows[e])throw new Error("Undefined table index: "+JSON.stringify(e));for(var n=0,i=this.rows[e].length;n<i;n++)this.rows[e][n]=t[n]}},{key:"deleteRow",value:function(e){this.rows[e]&&(this.rows[e]=null)}},{key:"insertRow",value:function(e){if(!e||void 0===e.length)throw new Error("Invalid argument row: array expected!");if(e.length!==this.identifiers.length)throw new Error("Row mismatch: Expected "+this.identifiers.length+" values, got "+e.length+" values!");null!==this.autoIncrementColumnIndex&&null===e[this.autoIncrementColumnIndex]&&(e[this.autoIncrementColumnIndex]=this.autoIncrementValue,this.autoIncrementValue++),this.rows.push(e)}},{key:"compact",value:function(){for(var e=this.rows.length-1;e>=0;e--)null===this.rows[e]&&this.rows.splice(e,1)}},{key:"isTransactional",value:function(){return!0}},{key:"startTransaction",value:function(){this.lastTransactionSnapshot=JSON.stringify(this.rows)}},{key:"commitTransaction",value:function(){if(void 0===this.lastTransactionSnapshot)throw new Error('No transaction started before!"');this.lastTransactionSnapshot=void 0}},{key:"rollbackTransaction",value:function(){if(void 0===this.lastTransactionSnapshot)throw new Error("Failed to rollback transaction: No transaction started before!");this.rows=JSON.parse(this.lastTransactionSnapshot)}},{key:"getNextAutoIncrementValue",value:function(){return this.autoIncrementValue+1}},{key:"setNextAutoIncrementValue",value:function(e){if("number"!==typeof e||!isFinite(e))throw new Error("Value is not finite!");if(e%1!==0)throw new Error("Value must be integer!");if(e<1)throw new Error("Value must be greater than 0!");this.autoIncrementValue=e}},{key:"alterIndexes",value:function(e){return Promise.reject()}},{key:"isIndexable",value:function(){return!0}},{key:"isVirtual",value:function(){return!1}}]),t}(Ze),nt=function(){function e(t){E()(this,e),x()(this,"table",void 0),x()(this,"cols",void 0),x()(this,"data",void 0),this.table=t,this.data=Object.create(null);for(var n=0,i=this.table.describe(),r=i.length;n<r;n++)!function(e,t,n){Object.defineProperty(n,String(e),{get:function(){return void 0===n.data[t]||void 0===n.data[t].get?void 0:n.data[t].get()},set:function(e){if(void 0===n.data[t]||void 0===n.data[t].set)throw new Error('Value "'+t+'" is read-only!');n.data[t].set(e)},enumerable:!0,configurable:!1})}(n,i[n].name,this),this.cols=n+1}return T()(e,[{key:"withPropertySetter",value:function(e,t){if(!this.table.hasIdentifier(e))throw new Error('Property "'+e+'" is not allowed!');return this.data[e]=this.data[e]||Object.create(null),this.data[e].set=t,this}},{key:"withPropertyGetter",value:function(e,t){if(!this.table.hasIdentifier(e))throw new Error('Property "'+e+'" is not allowed!');return this.data[e]=this.data[e]||Object.create(null),this.data[e].get=t,this}},{key:"length",get:function(){return this.cols}}]),e}(),it=function(e){function t(e){return E()(this,t),C()(this,S()(t).call(this,e,[],void 0))}return A()(t,e),T()(t,[{key:"createRow",value:function(){var e=new nt(this);return this.rows.push(e),e}},{key:"withSingleColumnIndex",value:function(e){throw new Error("Cannot add indexes on virtual tables!")}},{key:"replace",value:function(e,t){}},{key:"insertRow",value:function(e){throw new Error("Cannot insert rows on virtual tables!")}},{key:"deleteRow",value:function(e){throw new Error("Cannot delete rows from virtual tables!")}},{key:"isTransactional",value:function(){return!1}},{key:"startTransaction",value:function(){throw new Error("Transactions are not supported on virtual tables!")}},{key:"commitTransaction",value:function(){throw new Error("Transactions are not supported on virtual tables!")}},{key:"rollbackTransaction",value:function(){throw new Error("Transactions are not supported on virtual tables!")}},{key:"getNextAutoIncrementValue",value:function(){return 1}},{key:"isIndexable",value:function(){return!1}},{key:"isVirtual",value:function(){return!0}}]),t}(tt),rt=function(e){function t(e,n){var i;if(E()(this,t),i=C()(this,S()(t).call(this,e)),n){if(!Array.isArray(n))throw new Error("Invalid class constructor argument: indexes: Expected array!");for(var r=0,o=n.length;r<o;r++)i.withSingleColumnIndex(n[r])}return i}return A()(t,e),T()(t,[{key:"isRemote",value:function(){return!0}},{key:"getStorageEngine",value:function(){return p.REMOTE}},{key:"isTransactional",value:function(){return!1}},{key:"startTransaction",value:function(){throw new Error("Operation handled by backend!")}},{key:"commitTransaction",value:function(){throw new Error("Operation handled by backend!")}},{key:"rollbackTransaction",value:function(){throw new Error("Operation handled by backend!")}},{key:"getNextAutoIncrementValue",value:function(){throw new Error("Operation handled by backend!")}},{key:"setNextAutoIncrementValue",value:function(e){throw new Error("Operation handled by backend!")}},{key:"alterIndexes",value:function(e){return Promise.reject()}},{key:"isIndexable",value:function(){return!0}},{key:"isVirtual",value:function(){return!1}}]),t}(Ze),ot=function(){function e(){E()(this,e)}return T()(e,null,[{key:"createVirtualTable",value:function(e){return new it(e)}},{key:"createFromInMemoryArrayOfObjects",value:function(e,t,n){var i,r,o,a=void 0===t?j.getColumnDefinitions(e):t,s=[],l=a.length;if(!a.length)throw new Error('No valid columns were detected in "in-memory" array!');for(var u=0,c=e.length;u<c;u++){var d=0,h=void 0;for(h=0;h<l;h++)if(Array.isArray(e[u][a[h].name])){d=e[u][a[h].name].length;break}if(d>0)for(var g=0;g<d;g++){i=[];for(var p=0;p<l;p++)r=p==h?e[u][a[p].name][g]:e[u][a[p].name],null!==(o=j.getType(r))&&o===a[p].type||(r=null),i.push(r);s.push(i)}else{i=[];for(var v=0;v<l;v++)r=e[u][a[v].name],(o=j.getType(r))===f.OBJECT&&(r=r[Object.keys(r)[0]],o=j.getType(r)),null!==o&&o===a[v].type||(r=null),i.push(r);s.push(i)}}return new tt(a,s,n)}},{key:"createFromRemoteTableDefinition",value:function(e,t){return new rt(e,t)}}]),e}();window.JQLTableFactory=ot;var at=function(){function e(t,n){E()(this,e),x()(this,"identifiers",[]),x()(this,"indexes",[]),x()(this,"remote",void 0),x()(this,"storageEngine",void 0),x()(this,"db",void 0),x()(this,"table",void 0),x()(this,"name",void 0),x()(this,"deferredTable",null),this.db=n,this.name=t.name,this.remote=t.storageEngine===p.REMOTE,this.storageEngine=t.storageEngine,this.computeIdentifiers(t.schema),this.computeIndexDescriptors(t.indexes)}return T()(e,[{key:"describe",value:function(){return this.identifiers}},{key:"hasIdentifier",value:function(e){for(var t=0,n=this.identifiers.length;t<n;t++)if(this.identifiers[t].name===e)return!0;return!1}},{key:"isRemote",value:function(){return this.remote}},{key:"fetch",value:function(){var e=this;return this.table?this.table:(this.isRemote()?this.table=new Promise((function(t,n){e.deferredTable=ot.createFromRemoteTableDefinition(e.describe(),e.indexes),t(e.deferredTable)})):this.table=new Promise((function(t,n){var i=-1!==e.name.indexOf("salesforcePrefill")?e.db.getAuthorizationTokenSalesforce():e.db.getAuthorizationToken(),r=B.create("fetch-table",i,{name:e.name,applicationConfig:btoa(e.db.getApplicationConfig())});j.makeRequest(-1!==e.name.indexOf("salesforcePrefill")?e.db.getRPCEndpointSalesforceName():e.db.getRPCEndpointName(),j.REQUEST_METHOD_POST,j.REQUEST_CONTENT_TYPE_X_WWW_FORM_URLENCODED,j.REQUEST_RESPONSE_TYPE_JSON,j.encodeData(r)).then((function(n){e.deferredTable=ot.createFromInMemoryArrayOfObjects(n,e.identifiers,e.indexes),t(e.deferredTable)})).catch((function(e){n(new Error(e))}))})),this.table)}},{key:"getStorageEngine",value:function(){return this.storageEngine}},{key:"computeIdentifiers",value:function(t){for(var n in t)t.hasOwnProperty(n)&&this.identifiers.push({name:n,type:e.castBackendDataTypeToFrontendDataType(t[n]),default:null})}},{key:"computeIndexDescriptors",value:function(e){if(e){if(!Array.isArray(e))throw new Error("Invalid argument: indexes: array expected!");for(var t=0,n=e.length;t<n;t++)this.indexes.push(e[t])}}},{key:"getIndexes",value:function(){if(this.deferredTable)return this.deferredTable.getIndexes();for(var e=[],t=0,n=(this.indexes||[]).length;t<n;t++)e.push(Xe.createFromIndexDescriptor(this,this.indexes[t]));return e}},{key:"alterIndexes",value:function(e){var t=this;return new Promise((function(n,i){t.db.alterTableIndexes(t.name,e).then((function(e){t.deferredTable=null,t.indexes=e.indexes,n(!0)})).catch((function(e){i(e)}))}))}},{key:"isIndexable",value:function(){return!this.deferredTable||this.deferredTable.isIndexable()}},{key:"isVirtual",value:function(){return!!this.deferredTable&&this.deferredTable.isVirtual()}},{key:"isTransactional",value:function(){return!this.deferredTable||this.deferredTable.isTransactional()}}],[{key:"castBackendDataTypeToFrontendDataType",value:function(e){switch(e){case g.BOOLEAN:return f.BOOLEAN;case g.FLOAT:case g.INT:return f.NUMBER;case g.STRING:return f.STRING;default:return f.NULL}}}]),e}();function st(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function lt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?st(Object(n),!0).forEach((function(t){x()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):st(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ut,ct,dt=function(e){function t(){var e;return E()(this,t),e=C()(this,S()(t).call(this)),x()(O()(e),"functions",{}),x()(O()(e),"tables",{}),x()(O()(e),"planner",void 0),x()(O()(e),"authorizationToken",void 0),x()(O()(e),"authorizationTokenSalesforce",void 0),x()(O()(e),"rpcEndpointName",void 0),x()(O()(e),"rpcEndpointSalesforceName",void 0),x()(O()(e),"bindingProviders",[]),x()(O()(e),"onSchemaChanged",void 0),x()(O()(e),"applicationConfig",void 0),e.onSchemaChanged=F.a.create((function(){e.trigger("schema-changed")}),100),e}return A()(t,e),T()(t,[{key:"initPlanner",value:function(){return this.planner=new X(this),this}},{key:"withAuthorizationToken",value:function(e){return this.authorizationToken=e,this}},{key:"getAuthorizationToken",value:function(){return this.authorizationToken}},{key:"withApplicationConfig",value:function(e){return this.applicationConfig=e,this}},{key:"getApplicationConfig",value:function(){return this.applicationConfig}},{key:"withAuthorizationTokenSalesforce",value:function(e){return this.authorizationTokenSalesforce=e,this}},{key:"getAuthorizationTokenSalesforce",value:function(){return this.authorizationTokenSalesforce}},{key:"withRPCEndpointName",value:function(e){return this.rpcEndpointName=e,this}},{key:"getRPCEndpointName",value:function(){return this.rpcEndpointName}},{key:"withRPCEndpointSalesforceName",value:function(e){return this.rpcEndpointSalesforceName=e,this}},{key:"getRPCEndpointSalesforceName",value:function(){return this.rpcEndpointSalesforceName}},{key:"isValidIdentifierName",value:function(e){return"string"===typeof e&&/^[a-zA-Z$_][a-zA-Z0-9_$]+$/.test(e)}},{key:"withFunction",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!this.isValidIdentifierName(e))throw new Error(JSON.stringify(e)+" is not a valid function name!");if(e=e.toLowerCase(),j.isReservedKeyword(e))throw new Error(JSON.stringify(e)+" is a reserved keyword and cannot be used as a function name!");if(void 0!==this.functions[e])throw new Error("Function "+JSON.stringify(e)+" already registered in database!");return this.functions[e]={func:t,local:n,remote:i},this}},{key:"hasLocalFunction",value:function(e){return!("string"!==typeof e||(e=e.toLowerCase(),void 0===this.functions[e]||!this.functions.hasOwnProperty(e)||!this.functions[e].local))}},{key:"hasRemoteFunction",value:function(e){return!("string"!==typeof e||(e=e.toLowerCase(),void 0===this.functions[e]||!this.functions.hasOwnProperty(e)||!this.functions[e].remote))}},{key:"callFunction",value:function(e,t){if(this.hasLocalFunction(e))return this.functions[e.toLowerCase()].func.apply(this,t);throw new Error("Failed to call function "+JSON.stringify(e)+": Function not defined!")}},{key:"getFunction",value:function(e){if(this.hasLocalFunction(e))return this.functions[e].func;throw new Error("Failed to get function "+JSON.stringify(e)+": Function not defined!")}},{key:"withTable",value:function(e,t){if(!this.isValidTableName(e))throw new Error(JSON.stringify(e)+" is not a valid table name!");if(void 0!==this.tables[e])throw new Error("Table "+JSON.stringify(e)+" already created!");return this.tables[e]=t,this.onSchemaChanged(),this}},{key:"isValidTableName",value:function(e){return"string"===typeof e&&/^[a-zA-Z$_][a-zA-Z0-9_$]+$/.test(e)}},{key:"withTablesList",value:function(e){for(var t=0,n=e.length;t<n;t++)this.withTable(e[t].name,new at(e[t],this));return this.onSchemaChanged(),this}},{key:"hasTable",value:function(e){return"string"===typeof e&&void 0!==this.tables[e]&&this.tables.hasOwnProperty(e)}},{key:"enumerateTables",value:function(){var e=[];for(var t in this.tables)this.tables.hasOwnProperty(t)&&e.push({name:t,instance:this.tables[t]});return e}},{key:"getTable",value:function(e){if(this.hasTable(e))return this.tables[e];throw new Error("Table "+JSON.stringify(e)+" does not exist!")}},{key:"createStatement",value:function(e){if(!e||"string"!==typeof e)throw new Error("Invalid argument: statement: string expected!");if(!window.JQLGrammar)throw new Error("Cannot load JQLGrammar library!");var t=Ye.create(window.JQLGrammar.parse(e)),n=t.getTable();if(n){if(!this.hasTable(n.getName()))throw new Error("Failed to create statement: Table "+JSON.stringify(n.getName())+" does not exist!");for(var i=this.getTable(n.getName()),r=t.getIdentifiers(),o=0,a=r.length;o<a;o++)if(!i.hasIdentifier(r[o].getIdentifierName()))throw new Error("Unknown table identifier "+JSON.stringify(r[o].getIdentifierName()));if(i.isRemote()!==t.isRemote()){if(!t.isRemote())throw new Error("REMOTE statement clause is mandatory on encrypted tables");if(t.isRemote()&&i.isVirtual())throw new Error("REMOTE statements are not possible on virtual tables");if(i.isRemote()&&!t.isRemote())throw new Error("ENCRYPTED tables require remote statements")}}else if(t.getIdentifiers().length)throw new Error("A statement which does not affect a table cannot have identifiers!");for(var s=t.getFunctions(),l=0,u=s.length;l<u;l++){var c=s[l].getFunctionName();if(!t.isRemote()&&!this.hasLocalFunction(c)||t.isRemote()&&!this.hasRemoteFunction(c))throw new Error("Failed to create statement: Function "+JSON.stringify(s[l].getFunctionName())+" is not declared!");s[l].withDatabase(this)}return t}},{key:"executeStatement",value:function(e,t){try{return this.planner.scheduleStatement(e,this.createExecutionStrategy(e,t))}catch(n){return Promise.reject(n)}}},{key:"createExecutionStrategy",value:function(e,t){if(e.isRemote())return new z(e,this,t);switch(e.getStatementType()){case r.SELECT:return new K(e,this,t);case r.INSERT:return new Q(e,this,t);case r.UPDATE:return new $(e,this,t);case r.DELETE:return new H(e,this,t);default:throw new Error("Failed to create execution strategy: Uknown statement type!")}}},{key:"createTableFromCSVFile",value:function(e){var t=this,n=new FormData;return n.append("action","create-table-from-csv"),n.append("auth",this.authorizationToken),n.append("csvFile",e.csvFile||""),n.append("setting",btoa(JSON.stringify({table:{name:e.tableName,namespace:e.tableNamespace,accessMode:e.tableAccessMode,storageEngine:e.tableStorageEngine},csvParser:{enclosure:j.parseString(e.csvFieldEnclosure),encloseAllFields:e.csvEncloseAllFields,delimiter:j.parseString(e.csvFieldDelimiter),escapeCharacter:j.parseString(e.csvEscapeCharacter),autoTrim:e.csvAutoTrim,lineTerminator:j.parseString(e.csvLineTerminator)}}))),new Promise((function(e,i){t.makePostRequest(n).then((function(n){t.withTablesList([n]),e(n)})).catch((function(e){i(new Error(e))}))}))}},{key:"dropTable",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.hasTable(e))return Promise.reject(new Error("Table '".concat(e,"' does not exist!")));var i=B.create("drop-table",this.authorizationToken,lt({name:e},n));return new Promise((function(n,r){t.makePostRequest(i).then((function(i){delete t.tables[e],t.onSchemaChanged(),n(i)})).catch((function(e){r(new Error(e))}))}))}},{key:"unmountTable",value:function(e){if(!this.hasTable(e))throw new Error("Failed to unmount table "+JSON.stringify(e)+": Table not found!");delete this.tables[e]}},{key:"alterTableIndexes",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!this.hasTable(e))return Promise.reject(new Error("Table '".concat(e,"' does not exist!")));var r=B.create("alter-table-indexes",this.authorizationToken,lt({name:e,indexes:btoa(JSON.stringify(t||null))},i));return new Promise((function(e,t){n.makePostRequest(r).then((function(t){e(t),n.onSchemaChanged()})).catch((function(e){t(new Error(e))}))}))}},{key:"autoBind",value:function(e,t){for(var n=0,i=this.bindingProviders.length;n<i;n++)if(this.bindingProviders[n].canBind(e))return t.bind(this.bindingProviders[n].getBindedValue(e)),!0;return!1}},{key:"withAutoBindingProvider",value:function(e){return this.bindingProviders.push(e),this}},{key:"getJQLFormConfiguration",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=B.create("fetch-form-events",this.authorizationToken,lt({},t));return new Promise((function(t,i){e.makePostRequest(n).then((function(e){t(e)})).catch((function(e){i(new Error(e))}))}))}},{key:"saveJQLFormConfiguration",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{if(!Array.isArray(e))throw new Error("Array of IJQLv1FormEventConfiguration expected");for(var i=0,r=e.length;i<r;i++)We.assertJQLV1ConfigurationStructure(e[i]);for(var o=JSON.parse(JSON.stringify(e)),a=0,s=e.length;a<s;a++)for(var l=0,u=e[a].actions.length;l<u;l++)o[a].actions[l].statement=window.JQLGrammar.parse(e[a].actions[l].jql);var c=B.create("save-jql-configuration",this.authorizationToken,lt({configuration:btoa(JSON.stringify(o))},n));return new Promise((function(n,i){t.makePostRequest(c).then((function(){n(e)})).catch((function(e){i(new Error(e))}))}))}catch(d){return Promise.reject(d)}}},{key:"deleteAllAssociatedSettingsAndAllTables",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{var n=B.create("delete-jql-configuration-and-associated-tables",this.authorizationToken,lt({},t));return new Promise((function(t,i){e.makePostRequest(n).then((function(e){t(e)})).catch((function(e){i(new Error(e))}))}))}catch(i){return Promise.reject(i)}}},{key:"downloadTableAsCSV",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.hasTable(e))return Promise.reject(new Error("Table '".concat(e,"' does not exist!")));var i=B.create("export-table",this.authorizationToken,lt({name:e},n));return new Promise((function(e,n){t.makePostRequest(i).then((function(t){e(t)})).catch((function(e){n(new Error(e))}))}))}},{key:"makePostRequest",value:function(e){return j.makeRequest(this.rpcEndpointName,j.REQUEST_METHOD_POST,M()(e,FormData)?j.REQUEST_CONTENT_TYPE_MULTIPART:j.REQUEST_CONTENT_TYPE_X_WWW_FORM_URLENCODED,j.REQUEST_RESPONSE_TYPE_JSON,M()(e,FormData)?e:j.encodeData(e))}},{key:"triggerNextQuery",value:function(){this.planner.next()}}]),t}(_.a);!function(e){e[e.BY_SETTING_THE_VALUE_ATTRIBUTE=0]="BY_SETTING_THE_VALUE_ATTRIBUTE",e[e.BY_SETTING_THE_CHECKED_ATTRIBUTE=1]="BY_SETTING_THE_CHECKED_ATTRIBUTE",e[e.BY_SETTING_OPTIONS_AND_THEN_VALUE=2]="BY_SETTING_OPTIONS_AND_THEN_VALUE",e[e.BY_CUSTOM_PLUGIN_WHICH_CAN_FAIL=3]="BY_CUSTOM_PLUGIN_WHICH_CAN_FAIL",e[e.BY_USING_PROPRIETARY_DOM_ABSTRACTION_LAYER_METHOD=4]="BY_USING_PROPRIETARY_DOM_ABSTRACTION_LAYER_METHOD"}(ut||(ut={})),function(e){e[e.LEGACY_EDITOR=0]="LEGACY_EDITOR",e[e.LATEST_EDITOR_VERSION=1]="LATEST_EDITOR_VERSION",e[e.LEGACY_SALESFORCE_EDITOR=2]="LEGACY_SALESFORCE_EDITOR",e[e.LATEST_SALESFORCE_EDITOR_VERSION=3]="LATEST_SALESFORCE_EDITOR_VERSION"}(ct||(ct={}));var ht=n(32),ft=function(){function e(){E()(this,e)}return T()(e,[{key:"NOT",value:function(e){return!e}}],[{key:"DATE_DIFF",value:function(t,n,i){void 0===i&&(i=e.DEFAULT_JQL_DATE_FORMAT);var r=e.timeUtils.parseDate(t,i),o=e.timeUtils.parseDate(n,i),a=r.getTime(),s=o.getTime();return Math.ceil(Math.abs(s-a)/864e5)}},{key:"DATE_BETWEEN",value:function(t,n,i,r){void 0===r&&(r=e.DEFAULT_JQL_DATE_FORMAT);var o=e.timeUtils.parseDate(n,r),a=e.timeUtils.parseDate(i,r),s=e.timeUtils.parseDate(t,r),l=o.getTime(),u=a.getTime(),c=s.getTime();return c>=Math.min(l,u)&&c<=Math.max(l,u)}},{key:"DATE_FORMAT",value:function(t,n,i){void 0===n&&(n=e.DEFAULT_JQL_DATE_FORMAT),void 0===i&&(i=e.DEFAULT_JQL_DATE_FORMAT),""===t&&(t=i.replace("%Y","1970").replace("%m","01").replace("%d","01"));var r=e.timeUtils.parseDate(t,i);return e.timeUtils.formatTime(Math.floor(r.getTime()/1e3),n)}},{key:"DATE_GET_NUMBER_OF_DAYS",value:function(t,n){void 0===n&&(n=e.DEFAULT_JQL_DATE_FORMAT);try{var i=t?e.timeUtils.parseDate(t,n):new Date;if(!i)return 0;var r=i.getMonth(),o=i.getDate(),a=i.getFullYear(),s=0===a%4;return 365*(a-1)+~~(a/4)+e.DAYS_MAPPINGS[r]+o+(s&&r<2?-1:0)}catch(l){return 0}}},{key:"TIME_GET_NUMBER_OF_MINUTES",value:function(t,n){void 0===n&&(n=e.DEFAULT_JQL_TIME_FORMAT);var i=t?e.timeUtils.parseDate(t,n):new Date;return i?60*i.getHours()+i.getMinutes():0}},{key:"CURRENT_DATE",value:function(t){var n=new Date;return n.setHours(0),n.setMinutes(0),n.setSeconds(0),n.setMilliseconds(0),e.timeUtils.formatTime(Math.floor(n.getTime()/1e3),t||e.DEFAULT_JQL_DATE_FORMAT)}},{key:"DATE_COMPARE",value:function(t,n,i){var r=e.timeUtils.parseDate(t,i||e.DEFAULT_JQL_DATE_FORMAT),o=e.timeUtils.parseDate(n,i||e.DEFAULT_JQL_DATE_FORMAT),a=r.getTime(),s=o.getTime();return a===s?0:a<s?-1:1}},{key:"TIME_COMPARE",value:function(t,n,i){if(""===t)return-1;var r=e.timeUtils.stringToTime(t,i||e.DEFAULT_JQL_DATE_FORMAT),o=e.timeUtils.stringToTime(n,i||e.DEFAULT_JQL_DATE_FORMAT),a=r.getTime(),s=o.getTime();return a===s?0:a<s?-1:1}},{key:"DATE_ADD_INTERVAL",value:function(t,n,i){var r,o,a,s=e.timeUtils.parseDate(t,i||e.DEFAULT_JQL_DATE_FORMAT),l=0,u=null,c=null,d=null,h=null,f=null,g=null,p=null,v=String(n||"").toLowerCase();for(["-","+"].indexOf(r=v.substr(0,1))>-1&&(l="-"===r?-1:1,v=v.substr(1));o=/^([\s]+)?([1-9]([\d]+)?)([\s]+)?(day(s)?|month(s)?|year(s)?|hour(s)?|minute(s)?|second(s)?|millisecond(s)?)([\s]+)?/.exec(v);)switch(v=v.substr(o[0].length),a=~~o[2],o[5]){case"day":case"days":u=null===u?a:u+a;break;case"month":case"months":c=null===c?a:c+a;break;case"year":case"years":d=null===d?a:d+a;break;case"hour":case"hours":h=null===h?a:h+a;break;case"minute":case"minutes":f=null===f?a:f+a;break;case"second":case"seconds":g=null===g?a:g+a;break;case"millisecond":case"milliseconds":p=null===p?a:p+a}return null!==p&&s.setMilliseconds(s.getMilliseconds()+l*p),null!==g&&s.setSeconds(s.getSeconds()+l*g),null!==f&&s.setMinutes(s.getMinutes()+l*f),null!==h&&s.setHours(s.getHours()+l*h),null!==u&&s.setDate(s.getDate()+l*u),null!==c&&s.setMonth(s.getMonth()+l*c),null!==d&&s.setFullYear(s.getFullYear()+l*d),e.timeUtils.formatTime(Math.floor(s.getTime()/1e3),i||e.DEFAULT_JQL_DATE_FORMAT)}},{key:"CONCAT",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t?t.join(""):""}},{key:"SUM",value:function(){for(var e,t=0,n=0,i=arguments.length;n<i;n++)e=parseFloat(n<0||arguments.length<=n?void 0:arguments[n]),!isNaN(e)&&isFinite(e)&&(t+=e);return t}},{key:"EQUALS",value:function(e,t){return e==t}},{key:"COMPARE",value:function(e,t){var n,i,r,o,a,s,l;return null===e&&null===t?0:null===e?-2:(!1===e&&(e="0"),!1!==t&&null!==t||(t="0"),!0===e&&(e="1"),!0===t&&(t="1"),"string"===(i=V()(e))||"string"===(r=V()(t))?(o="string"===i?e.toLowerCase():String(e).toLowerCase(),a="string"===r?t.toLowerCase():String(t).toLowerCase(),s=parseFloat(o),l=parseFloat(a),n=isFinite(s)&&isFinite(l)?s===l?0:s<l?-1:1:o===a?0:o<a?-1:1):n=e===t?0:e<t?-1:1,n)}},{key:"IF",value:function(e,t,n){return e?t:n}},{key:"BOOL",value:function(e){return"0"!==e&&e!==1/0||(e=~~e),!!e}},{key:"INT",value:function(t){if(e.BOOL(t)){var n=parseInt(String(t));return!isNaN(n)&&isFinite(n)?n:0}return 0}},{key:"FLOAT",value:function(t){if(e.BOOL(t)){var n=parseFloat(String(t));return!isNaN(n)&&isFinite(n)?n:0}return 0}},{key:"STRING",value:function(e){switch(e){case!1:return"false";case null:return"null";case 0:return"0";default:return String(e||"")}}},{key:"FROM_BASE64",value:function(e){return atob(e)}},{key:"TO_BASE64",value:function(e){return btoa(e)}},{key:"REPLACE",value:function(e,t,n){if(!t)return e;var i=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),r=new RegExp(i,"ig");return String(e).replace(r,String(n))}},{key:"ALERT",value:function(){for(var t=[],n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];for(var o=0,a=i.length;o<a;o++)(i[o]||0===i[o])&&t.push(String(i[o]));return t.length&&e.INTERFACE_ENABLED&&setTimeout((function(){alert(t.join(" "))}),100),t.length?t.join(" "):null}},{key:"UNIQUE_ID_BASED_ON_DATE_MILISECOND",value:function(){return(+new Date).toString(36)}},{key:"IN",value:function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];var o;if(!i||!(o=i.length))return!1;for(var a=0;a<o;a++)if(0===e.COMPARE(t,i[a]))return!0;return!1}},{key:"onInterfaceEnabled",value:function(){e.INTERFACE_ENABLED=!0}}]),e}();x()(ft,"timeUtils",void 0),x()(ft,"DEFAULT_JQL_DATE_FORMAT","%Y-%m-%d"),x()(ft,"DEFAULT_JQL_TIME_FORMAT","%H:%i:%s"),x()(ft,"INTERFACE_ENABLED",!1),x()(ft,"DAYS_MAPPINGS",[0,31,59,90,120,151,181,212,243,273,304,334]),ft.timeUtils=ht.a.createInstanceInNonSingletonModeWithoutInternationalizationSupport();var gt=function(e){function t(e,n){var i,r;return E()(this,t),i=C()(this,S()(t).call(this)),x()(O()(i),"jq",void 0),x()(O()(i),"controls",[]),x()(O()(i),"formRules",void 0),i.jq=e,i.formRules=n,i.initializeControlMappings(),i.initializeNativeDOMEventsBridge(),(r=O()(i)).on("initialize-platform-specific-tasks",(function(e){setTimeout((function(){r.initializePlatformSpecificTasks(e)}),500)})),setTimeout((function(){for(var e=0,t=r.controls.length;e<t;e++)r.formRules.getLogger().log('Trigger "control-event" EFormRuleEventType.INIT for',r.controls[e].controlId),r.trigger("control-event",y.INIT,r.controls[e].domNode,r.controls[e].controlId)}),100),setTimeout((function(){var e;if(null!==r.formRules.getPreviouslySubmittedFormData())for(var t=0,n=r.controls.length;t<n;t++)e=r.formRules.getSubmissionValueForControlId(r.controls[t].controlId),r.formRules.getLogger().log('Trigger "control-event" EFormRuleEventType.REINITIALIZE for',r.controls[t].controlId,"with value: ",JSON.stringify(e)),r.trigger("control-event",y.REINITIALIZE,r.controls[t].domNode,r.controls[t].controlId,e)}),110),setTimeout((function(){r.formRules.getLogger().log("Enabling user interface"),ft.onInterfaceEnabled()}),500),i}return A()(t,e),T()(t,[{key:"clearControlsCache",value:function(){}},{key:"getControlValueById",value:function(e){var t,n,i=this.getControlById(e);if(null!==i)switch(n=i.nodeName.toLowerCase()){case"label":case"span":t=this.jq(i).text();break;default:t=this.jq(i).val()}else n="NULL";return this.formRules.getLogger().log("getControlValueById("+e+", "+n+" ) => ",JSON.stringify(t)),t}},{key:"castAnyToString",value:function(e){switch(V()(e)){case"string":return e;case"boolean":return e?"1":"0";case"number":return isFinite(e)?String(e):"0";default:return null===e?"":M()(e,Array)?this.castAnyToString(String(e.join("\t"))||""):String(JSON.stringify(e))}}},{key:"setupTextarea",value:function(e,t){var n=[];if(t)if("string"===typeof t)t&&(n=[String(t)]);else if(t&&M()(t,Array))for(var i=0,r=t.length;i<r;i++)if(t[i]){var o=this.castAnyToString(t[i]);o&&n.push(o)}e.value=n.join("\n")}},{key:"setupDropdown",value:function(e,t){var n,i,r=[];if(t)if("string"===typeof t)t&&(r=[String(t)]);else if(t&&M()(t,Array))for(var o=0,a=t.length;o<a;o++)if(t[o]){var s=this.castAnyToString(t[o]);s&&r.push(s)}for(;e.options.length;)e.remove(0);for(var l=0,u=r.length;l<u;l++)n=document.createElement("option"),i=r[l].split("\t"),n.text=i[0],n.value=i[1]||i[0],e.add(n);e.selectedIndex=r.length?0:-1,this.jq(e).parent().find(".select2-container > a > span:nth-child(1)").text(String(r[0]||"").split("\t")[0])}},{key:"setControlValueById",value:function(e,n){var i=this.getControlById(e);if(null!==i){var r,o=i.nodeName.toLowerCase();switch(o){case"input":switch(r=i.getAttribute("type")){case"checkbox":case"radio":i.checked=t.castAnyToCheckboxOrRadioValue(n),this.formRules.getLogger().log("setControlValueById("+e+" <"+r+">, "+JSON.stringify(t.castAnyToCheckboxOrRadioValue(n)));break;default:i.value=this.castAnyToString(n),this.reinitializeControlThirdPartyPluginsAfterItsValueHasBeenUpdated(i),this.formRules.getLogger().log("setControlValueById("+e+" <"+r+">, "+JSON.stringify(n))}break;case"textarea":this.setupTextarea(i,n),this.formRules.getLogger().log("setControlValueById("+e+" <"+o+">, "+JSON.stringify(n));break;case"select":this.setupDropdown(i,n),this.formRules.getLogger().log("setControlValueById("+e+" <"+o+">, "+JSON.stringify(n));break;case"label":case"span":this.formRules.getLogger().log("setControlValueById("+e+" <"+o+">, "+JSON.stringify(n)+": IGNORED");break;default:console.warn("AbstractionLayer: I don't know how to set the value for a input of type "+JSON.stringify(o))}}else this.formRules.getLogger().log("setControlValueById("+e+"): control not found!")}},{key:"getControlById",value:function(e){for(var t=String(e),n=0,i=this.controls.length;n<i;n++)if(this.controls[n].controlId===t)return this.controls[n].domNode;return null}},{key:"controlExistsInForm",value:function(e){var t=String(e);if(e){for(var n=0,i=this.controls.length;n<i;n++)if(t===this.controls[n].controlId)return!0;return!1}return!1}},{key:"isControl",value:function(e){return function(t,n){switch(e.nodeName.toLowerCase()){case"label":case"span":return n(e).closest(".uberfieldlat").hasClass("uberfieldlat");default:return!0}}(0,this.jq)}},{key:"initializeControlMappings",value:function(){var e;e=this,(0,this.jq)("form#mainform123 [id^=id123-control], form#mainform123 #id123-button-send, form#mainform123 [id^=id123-title]").each((function(){e.isControl(this)&&e.controls.push({controlId:t.getControlIdFromDOMNode(this),domNode:this})}))}},{key:"initializeNativeDOMEventsBridge",value:function(){var e;e=this,(0,this.jq)("form#mainform123").on("click","input[type=radio], input[type=checkbox]",(function(){e.trigger("control-event",this.checked?y.CHECK:y.UNCHECK,this,t.getControlIdFromDOMNode(this))})).on("change","select, input[type=text], input[type=number],input[type=email], input[type=password], textarea",(function(){e.trigger("control-event",y.CHANGE,this,t.getControlIdFromDOMNode(this))})).on("input","input:not([type=radio]):not([type=checkbox])",(function(){e.trigger("control-event",y.TEXT_INPUT,this,t.getControlIdFromDOMNode(this))}))}},{key:"getControlUpdateValueStrategy",value:function(e){var t=this.getControlById(e);if(null===t)return null;switch(t.nodeName.toLowerCase()){case"input":switch(t.getAttribute("type")){case"checkbox":case"radio":return ut.BY_SETTING_THE_CHECKED_ATTRIBUTE;default:return ut.BY_SETTING_THE_VALUE_ATTRIBUTE}case"textarea":return ut.BY_SETTING_THE_VALUE_ATTRIBUTE;case"select":return ut.BY_SETTING_OPTIONS_AND_THEN_VALUE;default:return ut.BY_CUSTOM_PLUGIN_WHICH_CAN_FAIL}}},{key:"initializeControlValueWhenTheFormIsPrefillingASubmission",value:function(e,n){var i,r=this.getControlUpdateValueStrategy(e);if(null!==r&&null!==n&&void 0!==n)switch(i=this.getControlById(e),r){case ut.BY_SETTING_THE_CHECKED_ATTRIBUTE:i.checked=t.castAnyToCheckboxOrRadioValue(n);break;case ut.BY_SETTING_THE_VALUE_ATTRIBUTE:i.value=String(n||"")||"";break;case ut.BY_SETTING_OPTIONS_AND_THEN_VALUE:this.setupDropdown(i,String(n||"")||""),i.selectedIndex=0;break;case ut.BY_USING_PROPRIETARY_DOM_ABSTRACTION_LAYER_METHOD:console.warn("DOMAbstractionLayer v1: Proprietary dom setters are not implemented by this abstraction layer");break;case ut.BY_CUSTOM_PLUGIN_WHICH_CAN_FAIL:}}},{key:"getControls",value:function(){return this.controls}},{key:"getJQuery",value:function(){return this.jq}},{key:"reinitializeControlThirdPartyPluginsAfterItsValueHasBeenUpdated",value:function(e){try{"datepicker"==e.dataset.toggle&&this.jq(e).datepicker("update",e.value)}catch(t){}}},{key:"initializePlatformSpecificTasks",value:function(e){if(e&&e.nextPreviewFormData)for(var t=function(t){return e.nextPreviewFormData[t||""]||null},n=this.getControls(),i=this.jq,r=0,o=n.length;r<o;r++)if(null!==t(n[r].controlId)&&""!=t(n[r].controlId)){var a=n[r].domNode;if("SELECT"==a.tagName){for(var s=i(a),l=0,u=s[0].options.length;l<u;l++)s[0].options[l].selected=s[0].options[l].value==t(n[r].controlId);-1!==a.className.indexOf("js-dropdown-searchable")?s.select2():s.trigger("change")}}}},{key:"getCurrentLanguage",value:function(){return"en"}}],[{key:"castAnyToCheckboxOrRadioValue",value:function(e){switch(!0){case"yes"===e:case!0===e:return!0;case"no"===e:case 0===e:return!1;default:return!!e}}},{key:"getControlIdFromDOMNode",value:function(e){return"id123-button-send"===e.id?"submit":String(e.id||e.name||"").replace(/^(id123-)?(control|title)/g,"").replace(/[^\d]+/g,"_")||null}}]),t}(_.a),pt=n(9),vt=function(){function e(t,n,i,r){E()(this,e),x()(this,"app",void 0),x()(this,"jq",void 0),x()(this,"notificationsAreaContainer",void 0),x()(this,"mainApplicationNode",void 0),this.app=t,this.jq=n,this.notificationsAreaContainer=i,this.mainApplicationNode=r}return T()(e,[{key:"alert",value:function(e,t,n,i){var r=this.createDialog(String(e||this.app.getI18n().translateText("myforms_UI_dlg_title_ALERT")),[{type:pt.c.OK,callback:function(e,t){n&&M()(n,Function)&&n(),t.close()}}],{width:i&&i.width?i.width:"500px",height:i&&i.height?i.height:void 0});r.body.textContent=String(t||"")||this.app.getI18n().translateText("myforms_UI_dlg_title_ALERT"),r.body.setAttribute("data-dialog-role","system-dialog")}},{key:"prompt",value:function(e,t,n,i){var r=this.createDialog(String(e||this.app.getI18n().translateText("myforms_UI_dlg_title_QUESTION")),[{type:pt.c.YES,callback:function(e,t){n&&M()(n,Function)&&n(),t.close()}},{type:pt.c.NO,callback:function(e,t){i&&M()(i,Function)&&(i(),pt.c.DOWNLOAD),t.close()}}],{width:"600px"});r.body.textContent=String(t||"")||this.app.getI18n().translateText("myforms_UI_dlg_title_QUESTION"),r.body.setAttribute("data-dialog-role","system-dialog")}},{key:"markNotificationTooltipAsClosed",value:function(e){var t=JSON.parse(localStorage.getItem("closed_notification_tooltips")||"{}");t[e]=1,localStorage.setItem("closed_notification_tooltips",JSON.stringify(t))}},{key:"isNotificationTooltipMarkedAsClosed",value:function(e){return!!JSON.parse(localStorage.getItem("closed_notification_tooltips")||"{}")[e]}},{key:"createNotificationTooltip",value:function(t,n){return function(i){var r=document.createElement("div"),o=document.createElement("div"),a=document.createElement("div"),s=document.createElement("div"),l=document.createElement("div");r.tabIndex=0,r.setAttribute("data-ui-tooltip-modal","1"),o.setAttribute("data-ui-tooltip-dialog","1"),o.setAttribute("data-placement",e.getNotificationTooltipPlacementAttribute(n.placement)),o.setAttribute(e.getNotificationTooltipStylingAttribute(n.tooltipType),"1"),a.setAttribute("data-ui-body","1"),l.setAttribute("data-ui-buttons","1"),1===t.length&&l.setAttribute("data-single-button-tooltip","1"),2===t.length&&l.setAttribute("data-two-buttons-tooltip","1"),r.appendChild(o),o.appendChild(a),a.appendChild(s);for(var u=!1,c={close:function(){u||(r.parentNode&&r.parentNode.removeChild(r),u=!0,n&&n.onCloseCallback&&n.onCloseCallback(c))},show:function(){o.removeAttribute("data-hide-tooltip")},hide:function(){o.setAttribute("data-hide-tooltip","")},persistentClose:function(){u||(r.parentNode&&r.parentNode.removeChild(r),u=!0,window.CFTracker&&window.CFTracker.event("tooltip_dismissed_".concat(n.tooltipId)),n&&n.tooltipId&&i.markNotificationTooltipAsClosed(n.tooltipId),n&&n.onCloseCallback&&n.onCloseCallback(c))},tooltip:s,body:a,tooltipId:n.tooltipId||null},d=0,h=t.length;d<h;d++)!function(t){var i=document.createElement("button");i.innerHTML=t.html||(t.i18nKey&&this.app.getI18n().translateText(t.i18nKey)!==t.i18nKey?this.app.getI18n().translateText(t.i18nKey):t.text),i.setAttribute(e.getNotificationTooltipStylingAttribute(n.tooltipType),"1"),i.onclick=function(){t.callback(c)},l.appendChild(i)}(t[d]);return o.appendChild(l),n&&(n.width&&(o.style.width=n.width),n.height&&(o.style.height=n.height)),n&&n.tooltipId&&i.isNotificationTooltipMarkedAsClosed(n.tooltipId)?setTimeout((function(){c.close()}),500):document.body.appendChild(r),r.focus(),c}(this)}},{key:"createDialog",value:function(t,n,i){return function(r,o){var a=document.createElement("div"),s=document.createElement("div"),l=document.createElement("div"),u=document.createElement("div"),c=document.createElement("div"),d=document.createElement("div"),h=document.createElement("div");a.tabIndex=0,a.className="ui-modal",s.className="ui-dialog",l.className="ui-titlebar",l.textContent=t,u.className="ui-titlebody",d.className="ui-body",h.className="ui-buttons bootstrap-iso",c.className="ui-close i123-close",a.appendChild(s),l.appendChild(u),l.appendChild(c),s.appendChild(l),s.appendChild(d);var f=!1;function g(e){var t;e.preventDefault(),e.stopPropagation(),o(h).find("> button").each((function(){switch(parseInt(o(this).attr("data-role").replace(/^button-type-/,""))){case pt.c.OK:case pt.c.YES:case pt.c.SAVE:case pt.c.FORM_MIGRATE:t||(t=this)}})),t&&o(t).click()}var p={close:function(){f||(o(d).find("form").off("submit",g),a.parentNode.removeChild(a),f=!0)},body:d,titlebody:u,dialog:s,setHTML:function(e){d.innerHTML=e,o(d).find("form").on("submit",g)},clearInlineErrors:function(){o(d).find("label.error").text("")},hide:function(){o(a).addClass("hidden")},show:function(){o(a).removeClass("hidden")},isClosed:function(){return f}};c.onclick=function(){if(i&&i.onCloseButtonClick)try{i.onCloseButtonClick()}catch(e){}p.close()},a.addEventListener("keyup",(function(e){27==(e.keyCode||e.charCode)&&(p.close(),i&&i.onCloseButtonClick&&i.onCloseButtonClick())}),!1);for(var v=0,m=n.length;v<m;v++)!function(t){var n=document.createElement("button");n.textContent=r.getDialogButtonLabel(t.type),h.appendChild(n),n.setAttribute("data-role","button-type-".concat(t.type)),n.className="btn ".concat(e.getDialogButtonClass(t.type)),n.onclick=function(){t.callback(t.type,p)}}(n[v]);return s.appendChild(h),i&&(i.width&&(s.style.width=i.width),i.height&&(s.style.height=i.height)),document.body.appendChild(a),a.focus(),a.addEventListener("keydown",(function(e){var t=e.target||e.srcElement;t&&-1===["input","select","textarea"].indexOf(t.nodeName.toLowerCase())&&(t.hasAttribute("data-allow-keyboard")||e.stopPropagation())}),!0),a.addEventListener("keypress",(function(e){var t=e.target||e.srcElement;t&&-1===["input","select","textarea"].indexOf(t.nodeName.toLowerCase())&&e.stopPropagation()}),!0),a.addEventListener("keyup",(function(e){var t=e.target||e.srcElement;t&&-1===["input","select","textarea"].indexOf(t.nodeName.toLowerCase())&&e.stopPropagation()}),!0),p}(this,this.jq)}},{key:"getDialogButtonLabel",value:function(e){switch(e){case pt.c.OK:return this.app.getI18n().translateText("myforms_UI_btn_OK");case pt.c.YES:return this.app.getI18n().translateText("myforms_UI_btn_YES");case pt.c.ABORT:return this.app.getI18n().translateText("myforms_UI_btn_ABORT");case pt.c.RETRY:return this.app.getI18n().translateText("myforms_UI_btn_RETRY");case pt.c.CANCEL:return this.app.getI18n().translateText("myforms_UI_btn_CANCEL");case pt.c.IGNORE:return this.app.getI18n().translateText("myforms_UI_btn_IGNORE");case pt.c.NO:return this.app.getI18n().translateText("myforms_UI_btn_NO");case pt.c.SAVE:return this.app.getI18n().translateText("myforms_UI_btn_SAVE");case pt.c.CHANGE:return this.app.getI18n().translateText("myforms_UI_btn_CHANGE");case pt.c.DELETE:return this.app.getI18n().translateText("myforms_UI_btn_DELETE");case pt.c.DOWNLOAD:return this.app.getI18n().translateText("myforms_UI_btn_DOWNLOAD");case pt.c.CLOSE:return this.app.getI18n().translateText("myforms_UI_btn_CLOSE");case pt.c.ENABLE_COMPLIANCE:return this.app.getI18n().translateText("myformsHipaaChangeStatusTitle0");case pt.c.DISABLE_COMPLIANCE:return this.app.getI18n().translateText("myformsHipaaChangeStatusTitle1");case pt.c.CREATE:return this.app.getI18n().translateText("applications_UI_btn_CREATE");case pt.c.DONE:return this.app.getI18n().translateText("applications_UI_btn_DONE");case pt.c.TRY_FORM:return this.app.getI18n().translateText("oldEditor_TryFormBtn");case pt.c.NO_THANKS:return this.app.getI18n().translateText("editForm_noThanksButton");case pt.c.UPDATE:return this.app.getI18n().translateText("Update");case pt.c.MAYBE_LATER:return this.app.getI18n().translateText("wix_popupMaybeLater");case pt.c.UPGRADE_NOW:return this.app.getI18n().translateText("LinkUpdateNowTitle");case pt.c.UPGRADE_NOW_PAYWALL:return this.app.getI18n().translateText("paywall_upgrade_button_1");case pt.c.CONTINUE:return this.app.getI18n().translateText("userServeyPopup_continue");case pt.c.KEEP_EDITING_FORM:return this.app.getI18n().translateText("edt_UI_btn_keep_editing_form");case pt.c.CLOSE_EDITOR:return this.app.getI18n().translateText("edt_UI_btn_close_editor");case pt.c.IMPORT:return this.app.getI18n().translateText("edt_UI_btn_import");case pt.c.ADD_DOMAIN:return this.app.getI18n().translateText("js_iep_domainalias05");case pt.c.VALIDATE:return this.app.getI18n().translateText("edt_UI_btn_validate_smtp");case pt.c.FORM_MIGRATE:return"Migrate";case pt.c.REQUEST_A_DEMO_CORPORATE_PAYWALL:return this.app.getI18n().translateText("paywall_request_a_demo");default:throw new Error("Invalid button type: ".concat(JSON.stringify(e),". Please use one of EDialogButtonType types"))}}},{key:"getCurrentNotification",value:function(){return this.notificationsAreaContainer.firstElementChild}},{key:"createNotification",value:function(t){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pt.d.DEFAULT,r=arguments.length>3?arguments[3]:void 0,o=document.createElement("div");if(o.className="notification",o.innerHTML=n?e.escapeHTML(t):t,r||void 0===r){var a=document.createElement("div");a.className="close",o.appendChild(a)}switch(this.notificationsAreaContainer.innerHTML="",i){case pt.d.DEFAULT:break;case pt.d.ERROR:this.jq(o).prepend('<span class="i123-warning"></span>'),this.jq(o).addClass("ERROR");break;case pt.d.SUCCESS:this.jq(o).prepend('<span class="i123-check"></span>'),this.jq(o).addClass("SUCCESS")}return this.notificationsAreaContainer.appendChild(o),this.jq(this.mainApplicationNode).addClass("with-notification"),o}},{key:"createResponsiveNotification",value:function(t){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pt.d.DEFAULT,r=arguments.length>3?arguments[3]:void 0,o=document.createElement("div"),a=n?e.escapeHTML(t):t;if(o.className="notification",o.innerHTML='<span class="notification-content">'.concat(a,"</span>"),r||void 0===r){var s=document.createElement("div");s.className="close",o.appendChild(s)}switch(this.notificationsAreaContainer.innerHTML="",i){case pt.d.DEFAULT:break;case pt.d.ERROR:this.jq(o).prepend('<span class="i123-warning"></span>'),this.jq(o).addClass("ERROR");break;case pt.d.SUCCESS:this.jq(o).prepend('<span class="i123-check"></span>'),this.jq(o).addClass("SUCCESS")}return this.notificationsAreaContainer.appendChild(o),this.jq(this.mainApplicationNode).addClass("with-notification"),o}},{key:"closeAllNotifications",value:function(){this.jq(this.mainApplicationNode).removeClass("with-notification"),this.notificationsAreaContainer.innerHTML=""}},{key:"getRootNode",value:function(){return this.mainApplicationNode}}],[{key:"getDialogButtonClass",value:function(e){switch(e){case pt.c.OK:case pt.c.YES:case pt.c.SAVE:case pt.c.CHANGE:case pt.c.DOWNLOAD:case pt.c.ENABLE_COMPLIANCE:case pt.c.CREATE:case pt.c.DONE:case pt.c.TRY_FORM:case pt.c.UPDATE:case pt.c.UPGRADE_NOW:case pt.c.UPGRADE_NOW_PAYWALL:case pt.c.CONTINUE:case pt.c.KEEP_EDITING_FORM:case pt.c.IMPORT:case pt.c.ADD_DOMAIN:case pt.c.VALIDATE:case pt.c.FORM_MIGRATE:case pt.c.REQUEST_A_DEMO_CORPORATE_PAYWALL:return"btn-secondary-cta";case pt.c.DELETE:case pt.c.DISABLE_COMPLIANCE:return"btn-secondary-red";default:return"btn-outline"}}},{key:"getNotificationTooltipStylingAttribute",value:function(e){switch(e){case pt.f.WARNING:return"data-styling-warning";case pt.f.ERROR:return"data-styling-error";case pt.f.DEFAULT:default:return"data-styling-regular"}}},{key:"getNotificationTooltipPlacementAttribute",value:function(e){switch(e){case pt.e.TOP_LEFT:return"top-left";case pt.e.TOP_CENTER:return"top-center";case pt.e.TOP_RIGHT:return"top-right";case pt.e.LEFT:return"left";case pt.e.CENTER:return"center";case pt.e.RIGHT:return"right";case pt.e.BOTTOM_LEFT:return"bottom-left";case pt.e.BOTTOM_CENTER:return"bottom-center";case pt.e.BOTTOM_RIGHT:default:return"bottom-right"}}},{key:"escapeHTML",value:function(t){e.HTMLEscaper.textContent=t;var n=e.HTMLEscaper.innerHTML;return e.HTMLEscaper.textContent="",n}}]),e}();x()(vt,"HTMLEscaper",document.createElement("div"));var mt,yt=function(e){function t(e,n){var i;if(E()(this,t),i=C()(this,S()(t).call(this)),x()(O()(i),"jq",void 0),x()(O()(i),"cache",{}),x()(O()(i),"started",{}),x()(O()(i),"loadedJS",{}),i.jq=e,n)for(var r in n)n.hasOwnProperty(r)&&i.preloadResource(r,n[r]);return i}return A()(t,e),T()(t,[{key:"preloadResource",value:function(e,t){this.cache[e]=t}},{key:"isPageNotFoundBuffer",value:function(e){return e&&"string"===typeof e&&e.indexOf('data-page-name="404error">')>-1}},{key:"get",value:function(e){if(!e||"string"!==typeof e)throw new Error("Invalid argument: non-empty string expected!");return t=this,n=this.jq,void 0!==t.cache[e]?n.Deferred((function(n){n.resolve(t.cache[e])})).promise():t.started[e]?n.Deferred((function(n){t.on("fetch_"+e,(function(){n.resolve(t.cache[e])})),t.on("error_"+e,(function(){n.reject(new Error('Failed fetching resource: "'+e+'"'))}))})).promise():(t.started[e]=(new Date).toString(),n.Deferred((function(i){var r=-1===e.indexOf("?")?e+"?_="+ +new Date:e+"&_="+ +new Date;n.get(r).then((function(n){if(t.isPageNotFoundBuffer(n))return i.reject(new Error("Resource "+e+" seems to be a not-found page!")),t.trigger("error_"+e),t.off("fetch_"+e),void t.off("error_"+e);t.cache[e]=n,delete t.started[e],i.resolve(t.cache[e]),t.trigger("fetch_"+e),t.off("fetch_"+e),t.off("error_"+e)})).fail((function(n){var r;setTimeout((function(){throw new Error("Failed to load resource from editor: "+e)}),0),null===(r=CFTracker)||void 0===r||r.event("editor_load_resource_error"),i.reject(new Error('Failed fetching resource: "'+e+'"')),t.trigger("error_"+e),t.off("fetch_"+e),t.off("error_"+e)}))})).promise());var t,n}},{key:"loadJavascript",value:function(e){return t=this.jq,this.loadedJS[e]?t.Deferred((function(e){e.resolve(!0)})).promise():t.Deferred((function(t){var n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("src",e),n.onload=function(){t.resolve(!0)},n.onerror=function(){var n;null===(n=CFTracker)||void 0===n||n.event("editor_load_resource_error"),t.reject(new Error('Failed to load external javascript: "'+e+'"'))},document.getElementsByTagName("head")[0].appendChild(n)})).promise();var t}}]),t}(_.a),bt=function(){function e(t,n){E()(this,e),x()(this,"dataGrid",void 0),x()(this,"rootDOMNode",void 0),x()(this,"gutterNumberDOMNode",void 0),x()(this,"height",28),x()(this,"rowData",void 0),x()(this,"cells",[]),x()(this,"rowIndex",void 0),x()(this,"selected",!1),x()(this,"selectedCellIndex",void 0),this.dataGrid=t,this.rootDOMNode=document.createElement("div"),this.rootDOMNode.setAttribute("data-role","row"),this.gutterNumberDOMNode=document.createElement("div"),this.gutterNumberDOMNode.setAttribute("data-role","gutter-number"),this.rootDOMNode.style.height=this.height+"px",this.gutterNumberDOMNode.style.height=this.height+"px",this.rowData=n||[],this.initCells()}return T()(e,[{key:"getRootDOMNode",value:function(){return this.rootDOMNode}},{key:"getGutterNumberDOMNode",value:function(){return this.gutterNumberDOMNode}},{key:"getHeight",value:function(){return this.height}},{key:"withHeight",value:function(e){return(e=~~e||0)<0&&(e=0),this.height=e,this.rootDOMNode.style.height=e+"px",this.gutterNumberDOMNode.style.height=e+"px",this.dataGrid.updateClientHeightDelayed(),this}},{key:"initCells",value:function(){for(var e=0,t=this.dataGrid.getColumns(),n=t.length;e<n;e++){var i=document.createElement("div");i.setAttribute("data-role","cell"),i.setAttribute("data-index",String(e)),i.innerHTML=t[e].renderValue(void 0===this.rowData[e]?null:this.rowData[e]),this.rootDOMNode.appendChild(i),this.cells.push(i)}}},{key:"getRowIndex",value:function(){return this.rowIndex}},{key:"withRowIndex",value:function(e){return null===e?(this.rowIndex=null,this.gutterNumberDOMNode.innerHTML=""):(e=~~e,this.rowIndex=e,this.gutterNumberDOMNode.appendChild(document.createElement("span")).textContent=String(this.rowIndex)),this}},{key:"getCells",value:function(){return this.cells}},{key:"getSelectedState",value:function(){return this.selected}},{key:"withSelectedState",value:function(e){return this.selected=!!e,this.selected?(this.rootDOMNode.setAttribute("data-selected",""),this.gutterNumberDOMNode.setAttribute("data-selected",""),this.dataGrid.getCollection()&&this.dataGrid.getCollection().setSelectedRowIndex(~~this.rootDOMNode.getAttribute("data-index"))):(this.rootDOMNode.removeAttribute("data-selected"),this.gutterNumberDOMNode.removeAttribute("data-selected"),null!==this.selectedCellIndex&&void 0!==this.selectedCellIndex&&this.withSelectedCellIndex(null)),this}},{key:"getSelectedCellIndex",value:function(){return null===this.selectedCellIndex||void 0===this.selectedCellIndex?null:this.selectedCellIndex}},{key:"withSelectedCellIndex",value:function(e){if(null===e||void 0===e)this.selectedCellIndex=void 0;else{if((e=~~e)<0)throw new Error("Invalid index!");if(e>=this.cells.length)throw new Error("Invalid index!");this.selectedCellIndex=e}for(var t=0,n=this.cells.length;t<n;t++)t===this.selectedCellIndex?this.cells[t].setAttribute("data-selected",""):this.cells[t].hasAttribute("data-selected")&&this.cells[t].removeAttribute("data-selected");return this}},{key:"getDataAt",value:function(e){return this.rowData[e]||null}},{key:"setDataAt",value:function(e,t){this.rowData[e]=t,this.cells[e].innerHTML=this.dataGrid.getColumns()[e].renderValue(void 0===this.rowData[e]?null:this.rowData[e])}}]),e}(),Et=function(){function e(){E()(this,e)}return T()(e,null,[{key:"renderBooleanValue",value:function(e){return e&&"0"!==e?'<span data-type="boolean">true</span>':null===e?'<span data-type="null">NULL</span>':'<span data-type="boolean">false</span>'}},{key:"renderNumericValue",value:function(e){return null!==e&&!isNaN(e)&&isFinite(e)?'<span data-type="number">'+String(e)+"</span>":null===e?'<span data-type="null">NULL</span>':'<span data-type="number">NaN</span>'}},{key:"renderStringValue",value:function(e){return e||0===e?(this.htmlescaper.textContent=String(e||""),'<span data-type="string">'+this.htmlescaper.innerHTML+"</span>"):null===e?'<span data-type="null">NULL</span>':'<span data-type="string"></span>'}},{key:"renderUnknownDataTypeValue",value:function(e){switch(V()(e)){case"number":return this.renderNumericValue(e);case"string":return isNaN(Number(e))?this.renderStringValue(e):this.renderNumericValue(e);case"boolean":return this.renderBooleanValue(e);default:return this.renderStringValue(e)}}}]),e}();x()(Et,"htmlescaper",document.createElement("div")),function(e){e[e.NONE=0]="NONE",e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=2]="DESCENDING"}(mt||(mt={}));var wt=function(){function e(t){E()(this,e),x()(this,"name",void 0),x()(this,"caption",void 0),x()(this,"width",100),x()(this,"columnType",void 0),x()(this,"rootDOMNode",void 0),x()(this,"captionDOMNode",void 0),x()(this,"dataGrid",void 0),x()(this,"resizerDOMNode",void 0),x()(this,"sortModeDecoration",void 0),x()(this,"sortDirection",void 0),x()(this,"valueRenderer",void 0),x()(this,"editable",void 0),this.dataGrid=t,this.rootDOMNode=document.createElement("div"),this.rootDOMNode.setAttribute("data-role","column"),this.captionDOMNode=document.createElement("span"),this.captionDOMNode.setAttribute("data-role","caption"),this.sortModeDecoration=document.createElement("div"),this.sortModeDecoration.setAttribute("data-role","sort-direction-indicator"),this.rootDOMNode.appendChild(this.captionDOMNode),this.rootDOMNode.appendChild(this.sortModeDecoration),this.rootDOMNode.style.width=this.width+"px",this.resizerDOMNode=document.createElement("div"),this.resizerDOMNode.setAttribute("data-role","column-resizer")}return T()(e,[{key:"getRootDOMNode",value:function(){return this.rootDOMNode}},{key:"getResizerDOMNode",value:function(){return this.resizerDOMNode}},{key:"getColumnName",value:function(){return this.name}},{key:"withColumnName",value:function(e){return this.name=String(e||""),this.rootDOMNode.setAttribute("data-name",String(e||"")),this.onNameOrCaptionChanged(),this}},{key:"withColumnCaption",value:function(e){return this.caption=e,this.onNameOrCaptionChanged(),this}},{key:"getColumnType",value:function(){return this.columnType}},{key:"withColumnType",value:function(e){return this.columnType=e,this}},{key:"onNameOrCaptionChanged",value:function(){this.captionDOMNode.textContent=this.rootDOMNode.title=String(this.caption||this.name)}},{key:"getWidth",value:function(){return this.width}},{key:"withWidth",value:function(e){return(e=~~e||0)<5&&(e=5),this.width=e,this.rootDOMNode.style.width=this.width+"px",this.dataGrid.updateClientWidth(),this}},{key:"getSortDirection",value:function(){return this.sortDirection}},{key:"withSortDirection",value:function(e){switch(e){case mt.ASCENDING:this.sortDirection=e,this.rootDOMNode.setAttribute("data-sort-direction","ascending");break;case mt.DESCENDING:this.sortDirection=e,this.rootDOMNode.setAttribute("data-sort-direction","descending");break;case mt.NONE:default:this.sortDirection=mt.NONE,this.rootDOMNode.removeAttribute("data-sort-direction")}}},{key:"withValueRenderer",value:function(e){return this.valueRenderer=e||null,this}},{key:"renderValue",value:function(e,t){if(this.valueRenderer)return this.valueRenderer(e,t);switch(this.columnType){case pt.b.BOOLEAN:return Et.renderBooleanValue(e);case pt.b.NUMBER:return Et.renderNumericValue(e);case pt.b.STRING:return Et.renderStringValue(e);case pt.b.UNKNOWN:default:return Et.renderUnknownDataTypeValue(e)}}},{key:"isEditable",value:function(){return this.editable}},{key:"withEditable",value:function(e){return this.editable=!!e,this}}]),e}(),Tt=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"row",void 0),x()(O()(n),"cell",void 0),x()(O()(n),"columnIndex",void 0),x()(O()(n),"column",void 0),x()(O()(n),"dataGrid",void 0),x()(O()(n),"editInput",void 0),x()(O()(n),"previousCellHTML",void 0),n.dataGrid=e,n}return A()(t,e),T()(t,[{key:"getRow",value:function(){return this.row||null}},{key:"getColumnIndex",value:function(){return this.columnIndex||0===this.columnIndex?this.columnIndex:null}},{key:"getColumn",value:function(){return this.column||null}},{key:"getCell",value:function(){return this.cell||null}},{key:"cancelEditing",value:function(){this.isEditing()&&(this.row=void 0,this.cell.innerHTML=this.previousCellHTML,this.cell=void 0,this.column=void 0,this.editInput=void 0)}},{key:"doneEditing",value:function(){if(this.isEditing()){var e;switch(this.column.getColumnType()){case pt.b.BOOLEAN:e=this.editInput.checked;break;case pt.b.NUMBER:e=parseFloat(this.editInput.value),(isNaN(e)||null===e)&&(e=null);break;default:e=this.editInput.value}var t=this.row.getDataAt(this.columnIndex),n=this.columnIndex,i=this.row;this.cancelEditing(),t!==e&&(i.setDataAt(n,e),this.dataGrid.onRowUpdated(i,n,e,t))}}},{key:"editCell",value:function(e){var t=this;this.isEditing()&&this.doneEditing(),e&&null!==e.columnIndex&&(this.row=this.dataGrid.getRows()[e.rowIndex]||null,this.row&&(this.columnIndex=e.columnIndex,this.column=this.dataGrid.getColumns()[e.columnIndex]||null,this.column&&this.column.isEditable()&&(this.cell=this.row.getCells()[e.columnIndex]||null,this.cell&&(this.previousCellHTML=this.cell.innerHTML,this.cell.innerHTML="",this.editInput=this.createEditorInput(this.column.getColumnType(),this.row.getDataAt(this.columnIndex)),this.cell.appendChild(this.editInput),setTimeout((function(){t.editInput.focus();try{t.editInput.select()}catch(e){}}),10),this.editInput.onblur=function(){t.doneEditing()}))))}},{key:"isEditing",value:function(){return!!this.cell&&!!this.row&&!!this.column}},{key:"createEditorInput",value:function(e,t){var n;switch(e){case pt.b.BOOLEAN:(n=document.createElement("input")).setAttribute("type","checkbox"),n.checked=this.castToBoolean(t);break;case pt.b.NUMBER:(n=document.createElement("input")).setAttribute("type","number"),n.value=this.castToNumber(t);break;case pt.b.STRING:case pt.b.UNKNOWN:default:(n=document.createElement("input")).setAttribute("type","text"),n.value=this.castToString(t)}return n.setAttribute("data-role","editor"),n}},{key:"castToBoolean",value:function(e){return"0"!==e&&!!~~e}},{key:"castToNumber",value:function(e){return null===e?"":isNaN(e)||!isFinite(e)?"":String(e)}},{key:"castToString",value:function(e){return e?String(e):""}}]),t}(_.a),Nt=function(e){function t(e){var n;return E()(this,t),n=C()(this,S()(t).call(this)),x()(O()(n),"jq",void 0),x()(O()(n),"uniqueGridId",void 0),x()(O()(n),"internalStyleDOMNode",void 0),x()(O()(n),"columns",[]),x()(O()(n),"rows",[]),x()(O()(n),"rootDOMNode",void 0),x()(O()(n),"headerDOMNode",void 0),x()(O()(n),"selectAllColumnsDOMNode",void 0),x()(O()(n),"bodyDOMNode",void 0),x()(O()(n),"gutterDOMNode",void 0),x()(O()(n),"footerDOMNode",void 0),x()(O()(n),"clientDOMNode",void 0),x()(O()(n),"clientWidth",0),x()(O()(n),"clientHeight",0),x()(O()(n),"clientScrollTop",0),x()(O()(n),"clientScrollLeft",0),x()(O()(n),"sortable",!1),x()(O()(n),"selectedRowIndex",void 0),x()(O()(n),"collection",void 0),x()(O()(n),"editor",void 0),x()(O()(n),"emptyStateHTMLDOMNode",void 0),x()(O()(n),"updateClientHeightDelayed",void 0),x()(O()(n),"renderInternalCssDelayed",void 0),t.styleId++,n.uniqueGridId=t.styleId,n.jq=e,n.rootDOMNode=document.createElement("div"),n.rootDOMNode.setAttribute("data-role","data-grid"),n.rootDOMNode.setAttribute("data-grid-uid",String(n.uniqueGridId)),n.rootDOMNode.appendChild(n.internalStyleDOMNode=document.createElement("style")),n.headerDOMNode=n.rootDOMNode.appendChild(document.createElement("div")),n.headerDOMNode.setAttribute("data-role","header"),n.selectAllColumnsDOMNode=n.headerDOMNode.appendChild(document.createElement("div")),n.selectAllColumnsDOMNode.setAttribute("data-role","select-all-columns"),n.gutterDOMNode=n.rootDOMNode.appendChild(document.createElement("div")),n.gutterDOMNode.setAttribute("data-role","gutter"),n.bodyDOMNode=n.rootDOMNode.appendChild(document.createElement("div")),n.bodyDOMNode.setAttribute("data-role","body"),n.clientDOMNode=n.bodyDOMNode.appendChild(document.createElement("div")),n.clientDOMNode.setAttribute("data-role","client"),n.clientDOMNode.setAttribute("data-allow-keyboard",""),n.clientDOMNode.tabIndex=0,n.footerDOMNode=n.rootDOMNode.appendChild(document.createElement("div")),n.footerDOMNode.setAttribute("data-role","footer"),n.emptyStateHTMLDOMNode=document.createElement("div"),n.emptyStateHTMLDOMNode.setAttribute("data-role","empty-state"),n.bodyDOMNode.appendChild(n.emptyStateHTMLDOMNode),n.updateClientHeightDelayed=F.a.create((function(){n.updateClientHeight()}),100),n.renderInternalCssDelayed=F.a.create((function(){n.renderInternalCSS()}),1),n.editor=new Tt(O()(n)),n.init(),n}return A()(t,e),T()(t,[{key:"getSelectedIndex",value:function(){for(var e=0,t=this.rows.length;e<t;e++)if(this.rows[e].getSelectedState())return e;return-1}},{key:"getRootDOMNode",value:function(){return this.rootDOMNode}},{key:"createColumn",value:function(){var e=new wt(this);return this.columns.push(e),this.headerDOMNode.appendChild(e.getRootDOMNode()),this.headerDOMNode.appendChild(e.getResizerDOMNode()),this.updateClientWidth(),this.renderInternalCssDelayed(),e}},{key:"createRow",value:function(e){var t=new bt(this,e),n=this.rows.length;return t.getRootDOMNode().setAttribute("data-index",String(n)),t.getGutterNumberDOMNode().setAttribute("data-index",String(n)),this.rows.push(t),this.clientDOMNode.appendChild(t.getRootDOMNode()),this.gutterDOMNode.appendChild(t.getGutterNumberDOMNode()),this.updateClientHeightDelayed(),t}},{key:"getClientWidth",value:function(){return this.clientWidth}},{key:"withClientWidth",value:function(e){return(e=~~e||0)<0&&(e=0),this.clientWidth=e,this.clientDOMNode.style.width=e+"px",this}},{key:"getClientHeight",value:function(){return this.clientHeight}},{key:"withClientHeight",value:function(e){return(e=~~e||0)<0&&(e=0),this.clientHeight=e,this.clientDOMNode.style.height=e+"px",this}},{key:"updateClientWidth",value:function(){for(var e=0,t=0,n=this.columns.length;t<n;t++)e+=this.columns[t].getWidth();this.withClientWidth(e),this.renderInternalCSS()}},{key:"updateClientHeight",value:function(){for(var e=0,t=0,n=this.rows.length;t<n;t++)e+=this.rows[t].getHeight();this.withClientHeight(e)}},{key:"getClientScrollTop",value:function(){return this.clientScrollTop}},{key:"withClientScrollTop",value:function(e){return(e=~~e||0)<0&&(e=0),this.clientScrollTop=e,this.bodyDOMNode.scrollTop=this.clientScrollTop,this.renderInternalCSS(),this}},{key:"getClientScrollLeft",value:function(){return this.clientScrollLeft}},{key:"withClientScrollLeft",value:function(e){return(e=~~e||0)<0&&(e=0),this.clientScrollLeft=e,this.bodyDOMNode.scrollLeft=this.clientScrollLeft,this.renderInternalCSS(),this}},{key:"isSortingEnabled",value:function(){return this.sortable}},{key:"withSortingEnabled",value:function(e){if(this.sortable=!!e,!this.sortable)for(var t=0,n=this.columns.length;t<n;t++)this.columns[t].withSortDirection(mt.NONE);return this}},{key:"clearRows",value:function(){for(;this.rows.length;){var e=this.rows.shift();this.clientDOMNode.removeChild(e.getRootDOMNode()),this.gutterDOMNode.removeChild(e.getGutterNumberDOMNode())}this.withClientHeight(0),this.withClientScrollTop(0)}},{key:"dispose",value:function(){for(this.emptyStateHTMLDOMNode.innerHTML="",this.rootDOMNode.removeAttribute("data-num-rows");this.columns.length;){var e=this.columns.shift();this.headerDOMNode.removeChild(e.getRootDOMNode()),this.headerDOMNode.removeChild(e.getResizerDOMNode())}this.clearRows(),this.withClientWidth(0),this.withClientScrollLeft(0),this.updateClientWidth()}},{key:"init",value:function(){var e,t;(e=this.jq)((t=this).bodyDOMNode).on("scroll",(function(e){t.withClientScrollLeft(this.scrollLeft),t.withClientScrollTop(this.scrollTop)})),e(t.headerDOMNode).on("mousedown","[data-role=column-resizer]",(function(e){for(var n,i=0,r=t.columns.length;i<r;i++)if(t.columns[i].getResizerDOMNode()===this){n=t.columns[i];break}if(n){var o=n.getWidth(),a=e.clientX,s=function(e){var t=e.clientX-a;n.withWidth(o+t)};document.body.addEventListener("mousemove",s,!0),document.body.addEventListener("mouseup",(function e(t){document.body.removeEventListener("mousemove",s,!0),document.body.removeEventListener("mouseup",e,!0)}),!0)}})).on("click","[data-role=column] > [data-role=caption]",(function(e){if(t.sortable){for(var n,i=this.parentNode,r=0,o=t.columns.length;r<o;r++)t.columns[r].getRootDOMNode()===i?n=t.columns[r]:t.columns[r].getSortDirection()!==mt.NONE&&t.columns[r].withSortDirection(mt.NONE);if(n){switch(n.getSortDirection()){case mt.ASCENDING:case mt.NONE:default:n.withSortDirection(mt.DESCENDING);break;case mt.DESCENDING:n.withSortDirection(mt.ASCENDING)}t.onColumnSorted(n)}}})),e(t.gutterDOMNode).on("mousedown","> [data-role=gutter-number]",(function(){if(!this.hasAttribute("data-selected")){var n=~~this.getAttribute("data-index");e(t.clientDOMNode).find("> [data-role=row][data-selected]").each((function(){t.rows[~~this.getAttribute("data-index")].withSelectedState(!1)})),t.rows[n].withSelectedState(!0),setTimeout((function(){t.clientDOMNode.focus()}),100)}})),e(t.clientDOMNode).on("mousedown","> [data-role=row]",(function(){if(!this.hasAttribute("data-selected")){var n=~~this.getAttribute("data-index");e(t.clientDOMNode).find("> [data-role=row][data-selected]").each((function(){t.rows[~~this.getAttribute("data-index")].withSelectedState(!1)})),t.rows[n].withSelectedState(!0)}})).on("mousedown","> [data-role=row] > [data-role=cell]",(function(){var e=~~this.getAttribute("data-index"),n=~~this.parentNode.getAttribute("data-index");t.rows[n].withSelectedCellIndex(e)})).on("dblclick","> [data-role=row] > [data-role=cell]",(function(){t.editor.isEditing()||t.editor.editCell(t.getActiveCellCoordinates())})),t.clientDOMNode.addEventListener("keydown",(function(e){var n=e.keyCode||e.charCode,i=e.srcElement||e.target,r=!1;if(i&&-1===["input","select","textarea"].indexOf(i.nodeName.toLowerCase()))switch(n){case 37:t.editor.isEditing()||(r=!0,t.focusPreviousSiblingCell());break;case 39:t.editor.isEditing()||(r=!0,t.focusNextSiblingCell());break;case 38:t.editor.isEditing()||(r=!0,t.focusPreviousRowCell());break;case 40:t.editor.isEditing()||(r=!0,t.focusNextRowCell());break;case 36:t.editor.isEditing()||(r=!0,t.focusFirstColumnCell());break;case 35:t.editor.isEditing()||(r=!0,t.focusLastColumnCell());break;case 33:t.editor.isEditing()||(r=!0,t.focusPageUpCell());break;case 34:t.editor.isEditing()||(r=!0,t.focusPageDownCell());break;case 9:t.editor.isEditing()?(t.editor.doneEditing(),e.shiftKey?t.focusPreviousCell():t.focusNextCell(),t.editor.editCell(t.getActiveCellCoordinates()),r=!0):(r=!0,e.shiftKey?t.focusPreviousCell():t.focusNextCell());break;case 13:t.editor.isEditing()||(t.editor.editCell(t.getActiveCellCoordinates()),r=!0);break;case 27:t.editor.isEditing()&&(t.editor.cancelEditing(),setTimeout((function(){t.clientDOMNode.focus()}),10),r=!0)}else 27===n&&t.editor.isEditing()&&(t.editor.cancelEditing(),setTimeout((function(){t.clientDOMNode.focus()}),10),r=!0),13===n&&t.editor.isEditing()&&(t.editor.doneEditing(),setTimeout((function(){t.clientDOMNode.focus()}),10),r=!0),9===n&&(t.editor.isEditing()?(t.editor.doneEditing(),e.shiftKey?t.focusPreviousCell():t.focusNextCell(),t.editor.editCell(t.getActiveCellCoordinates()),r=!0):(r=!0,e.shiftKey?t.focusPreviousCell():t.focusNextCell(),setTimeout((function(){t.clientDOMNode.focus()}),10)));r&&(e.stopPropagation(),e.preventDefault())}),!0)}},{key:"renderInternalCSS",value:function(){for(var e="",t=0,n=this.columns.length;t<n;t++)e+='\n                [data-role=data-grid][data-grid-uid="'.concat(this.uniqueGridId,'"] > [data-role=body] > [data-role=client] > [data-role=row] > [data-role=cell]:nth-child(').concat(t+1,") {\n                    width: ").concat(this.columns[t].getWidth(),"px\n                }\n            ");this.internalStyleDOMNode.textContent='\n\n            [data-role=data-grid][data-grid-uid="'.concat(this.uniqueGridId,'"] > [data-role=gutter] > [data-role=gutter-number]:first-child {\n                margin-top: -').concat(this.clientScrollTop,'px;\n            }\n\n            [data-role=data-grid][data-grid-uid="').concat(this.uniqueGridId,'"] > [data-role=header] > [data-role=select-all-columns] + [data-role=column] {\n                margin-left: -').concat(this.clientScrollLeft,"px;\n            }\n\n        ")+e}},{key:"getColumns",value:function(){return this.columns}},{key:"withCollection",value:function(e){var t=this;if(this.dispose(),this.collection&&this.collection.dispose(),this.collection=e||null,!this.collection)return this.rootDOMNode.removeAttribute("data-has-footer"),void(this.footerDOMNode.innerHTML="");this.rootDOMNode.setAttribute("data-has-footer",""),this.footerDOMNode.innerHTML=this.collection.getGridFooterHTMLMarkup();for(var n=e.getColumnDescriptors(),i=n.length,r=0;r<i;r++)this.createColumn().withColumnType(n[r].type).withColumnName(n[r].name).withColumnCaption(n[r].caption).withEditable(n[r].editable);return setTimeout((function(){t.collection.setPage(1).fail((function(e){console.error(e)}))}),10),this.collection.onCollectionEmbedded(this.footerDOMNode),this.collection.on("change",(function(){t.clearRows();for(var e=0,n=t.collection.getNumberOfItemsOnCurrentPage();e<n;e++)t.createRow(t.collection.getRowAt(e)).withRowIndex(t.collection.getFirstRowOffsetStart()+e)})),this.collection.on("insert-row",(function(e){for(var n=t.createRow(e),i=0,r=t.rows.length;i<r;i++)t.rows[i]===n?t.rows[i].withSelectedState(!0):t.rows[i].getSelectedState()&&t.rows[i].withSelectedState(!1);t.maintainFocusCellViewportPosition()})),this.collection.on("commit-row",(function(e){t.rows[e].withRowIndex(t.collection.getFirstRowOffsetStart()+e)})),this}},{key:"withEmptyStateHTML",value:function(e){return this.emptyStateHTMLDOMNode.innerHTML=String(e||""),this}},{key:"getCollection",value:function(){return this.collection||null}},{key:"onColumnSorted",value:function(e){this.collection&&this.collection.setSortedColumn(e.getColumnName(),e.getSortDirection())}},{key:"getActiveCellCoordinates",value:function(){for(var e=0,t=0,n=0,i=this.rows.length;n<i;n++){if(this.rows[n].getSelectedState()){for(var r=0,o=Math.min(this.columns.length-1,~~this.rows[n].getSelectedCellIndex());r<o;r++)t+=this.columns[r].getWidth();return{rowIndex:n,columnIndex:this.rows[n].getSelectedCellIndex(),top:e,left:t}}e+=this.rows[n].getHeight()}return null}},{key:"focusPreviousSiblingCell",value:function(){var e=this.getActiveCellCoordinates();e&&0!==e.columnIndex&&(this.rows[e.rowIndex].withSelectedCellIndex(null===e.columnIndex?0:e.columnIndex-1),this.maintainFocusCellViewportPosition())}},{key:"focusNextSiblingCell",value:function(){var e=this.getActiveCellCoordinates();e&&e.columnIndex!==this.columns.length-1&&(this.rows[e.rowIndex].withSelectedCellIndex(null===e.columnIndex?0:e.columnIndex+1),this.maintainFocusCellViewportPosition())}},{key:"focusPreviousRowCell",value:function(){var e=this.getActiveCellCoordinates();e&&0!==e.rowIndex&&null!==e.columnIndex&&(this.rows[e.rowIndex].withSelectedState(!1),this.rows[e.rowIndex].withSelectedCellIndex(null),e.rowIndex--,this.rows[e.rowIndex].withSelectedState(!0),this.rows[e.rowIndex].withSelectedCellIndex(e.columnIndex),this.maintainFocusCellViewportPosition())}},{key:"focusNextRowCell",value:function(){var e=this.getActiveCellCoordinates();if(e&&e.rowIndex!==this.rows.length-1&&null!==e.columnIndex){this.clientDOMNode.offsetHeight;this.rows[e.rowIndex].withSelectedState(!1),this.rows[e.rowIndex].withSelectedCellIndex(null),e.rowIndex++,this.rows[e.rowIndex].withSelectedState(!0),this.rows[e.rowIndex].withSelectedCellIndex(e.columnIndex),this.maintainFocusCellViewportPosition()}}},{key:"focusFirstColumnCell",value:function(){var e=this.getActiveCellCoordinates();e&&0!==e.columnIndex&&(this.rows[e.rowIndex].withSelectedCellIndex(0),this.maintainFocusCellViewportPosition())}},{key:"focusLastColumnCell",value:function(){var e=this.getActiveCellCoordinates();e&&e.columnIndex!==this.columns.length-1&&(this.rows[e.rowIndex].withSelectedCellIndex(this.columns.length-1),this.maintainFocusCellViewportPosition())}},{key:"focusPageUpCell",value:function(){var e=this.getActiveCellCoordinates();if(e&&0!==e.rowIndex&&null!==e.columnIndex){var t=this.clientDOMNode.offsetHeight;for(this.rows[e.rowIndex].withSelectedState(!1),this.rows[e.rowIndex].withSelectedCellIndex(null);e.rowIndex>0&&t>0;)t-=this.rows[e.rowIndex].getHeight(),e.rowIndex--;this.rows[e.rowIndex].withSelectedState(!0),this.rows[e.rowIndex].withSelectedCellIndex(e.columnIndex),this.maintainFocusCellViewportPosition()}}},{key:"focusPageDownCell",value:function(){var e=this.getActiveCellCoordinates();if(e&&e.rowIndex!==this.rows.length-1&&null!==e.columnIndex){var t=this.clientDOMNode.offsetHeight;for(this.rows[e.rowIndex].withSelectedState(!1),this.rows[e.rowIndex].withSelectedCellIndex(null);e.rowIndex<this.rows.length-1&&t>0;)t-=this.rows[e.rowIndex].getHeight(),e.rowIndex++;this.rows[e.rowIndex].withSelectedState(!0),this.rows[e.rowIndex].withSelectedCellIndex(e.columnIndex),this.maintainFocusCellViewportPosition()}}},{key:"focusNextCell",value:function(){var e=this.getActiveCellCoordinates();e&&(null!==e.columnIndex?e.columnIndex<this.columns.length-1?this.focusNextSiblingCell():(this.rows[e.rowIndex].withSelectedState(!1),this.rows[e.rowIndex].withSelectedCellIndex(null),e.rowIndex++,e.rowIndex>=this.rows.length&&(e.rowIndex=0),e.columnIndex=0,this.rows[e.rowIndex].withSelectedState(!0),this.rows[e.rowIndex].withSelectedCellIndex(e.columnIndex),this.maintainFocusCellViewportPosition()):this.focusNextSiblingCell())}},{key:"focusPreviousCell",value:function(){var e=this.getActiveCellCoordinates();e&&(null!==e.columnIndex?e.columnIndex>0?this.focusPreviousSiblingCell():(this.rows[e.rowIndex].withSelectedState(!1),this.rows[e.rowIndex].withSelectedCellIndex(null),e.rowIndex--,e.rowIndex<0&&(e.rowIndex=this.rows.length-1),e.columnIndex=this.columns.length-1,this.rows[e.rowIndex].withSelectedState(!0),this.rows[e.rowIndex].withSelectedCellIndex(e.columnIndex),this.maintainFocusCellViewportPosition()):this.focusPreviousSiblingCell())}},{key:"maintainFocusCellViewportPosition",value:function(){var e=this.getActiveCellCoordinates();if(e){var t=this.rows[e.rowIndex].getRootDOMNode(),n=t.offsetTop;if(n<this.bodyDOMNode.scrollTop)this.bodyDOMNode.scrollTop=n;else{var i=t.offsetHeight,r=this.bodyDOMNode.offsetHeight-20;this.bodyDOMNode.scrollTop+r<n+i&&(this.bodyDOMNode.scrollTop=n+i-r)}if(null!==e.columnIndex){var o=this.rows[e.rowIndex].getCells()[e.columnIndex],a=o.offsetLeft;if(a<this.bodyDOMNode.scrollLeft)this.bodyDOMNode.scrollLeft=a;else{var s=o.offsetWidth,l=this.bodyDOMNode.offsetWidth-20;this.bodyDOMNode.scrollLeft+l<a+s&&(this.bodyDOMNode.scrollLeft=a+s-l)}}}}},{key:"getRows",value:function(){return this.rows}},{key:"onRowUpdated",value:function(e,t,n,i){if(this.trigger("row-updated",e,t,n,i),this.collection){for(var r=null,o=0,a=this.rows.length;o<a;o++)if(this.rows[o]===e){r=o;break}this.collection.updateRow(r,t,n).then((function(){})).fail((function(n){e.setDataAt(t,i),console.error(n)}))}}}]),t}(_.a);x()(Nt,"styleId",0);var Ct=function(){function e(t){E()(this,e),x()(this,"i18n",void 0),this.i18n=t}return T()(e,[{key:"convertFileSizeToString",value:function(t){var n,i;switch(!0){case t/e.KILOBYTE<1:n=t,i=null;break;case t/e.MEGABYTE<1:i="KB",n=t/e.KILOBYTE;break;case t/e.GIGABYTE<1:i="MB",n=t/e.MEGABYTE;break;case t/e.TERABYTE<1:i="GB",n=t/e.GIGABYTE;break;default:i="TB",n=t/e.TERABYTE}return Number(n).toFixed(1).replace(/\.0$/g,"")+(null===i?"":" "+i)}}],[{key:"download",value:function(t,n,i){var r,o,a=window,s="application/octet-stream",l=i||s,u=t,c=!n&&!i&&u,d=document.createElement("a"),h=function(e){return String(e)},f=a.Blob||a.MozBlob||a.WebKitBlob||h,g=n||"download";f=f.call?f.bind(a):Blob;var p=function(e,t){if("download"in d)return d.href=e,d.setAttribute("download",g),d.className="download-js-link",d.innerHTML="downloading...",d.style.display="none",document.body.appendChild(d),setTimeout((function(){d.click(),document.body.removeChild(d),!0===t&&setTimeout((function(){a.URL.revokeObjectURL(d.href)}),250)}),66),!0;if(/(Version)\/(\d+)\.(\d+)(?:\.(\d+))?.*Safari\//.test(navigator.userAgent))return/^data:/.test(e)&&(e="data:"+e.replace(/^data:([\w\/\-+]+)/,s)),window.open(e)||confirm("Displaying New Document\n\nUse Save As... to download, then click back to return to this page.")&&(location.href=e),!0;var n=document.createElement("iframe");document.body.appendChild(n),!t&&/^data:/.test(e)&&(e="data:"+e.replace(/^data:([\w\/\-+]+)/,s)),n.src=e,setTimeout((function(){document.body.removeChild(n)}),333)},v=function(e){for(var t=e.split(/[:;,]/),n=t[1],i=("base64"==t[2]?atob:decodeURIComponent)(t.pop()),r=i.length,o=0,a=new Uint8Array(r);o<r;++o)a[o]=i.charCodeAt(o);return new f([a],{type:n})};if("true"===String(this)&&(l=(u=[u,l])[0],u=u[1]),c&&c.length<2048&&(g=c.split("/").pop().split("?")[0],d.href=c,-1!==d.href.indexOf(c))){var m=new XMLHttpRequest;return m.open("GET",c,!0),m.responseType="blob",m.onload=function(t){e.download(t.target.response,g,s)},setTimeout((function(){m.send()}),0),m}if(/^data:([\w+-]+\/[\w+.-]+)?[,;]/.test(u)){if(!(u.length>2096103.424&&f!==h))return navigator.msSaveBlob?navigator.msSaveBlob(v(u),g):p(u);l=(u=v(u)).type||s}else if(/([\x80-\xff])/.test(u)){for(var y=0,b=new Uint8Array(u.length),E=b.length;y<E;++y)b[y]=u.charCodeAt(y);u=new f([b],{type:l})}if(r=M()(u,f)?u:new f([u],{type:l}),navigator.msSaveBlob)return navigator.msSaveBlob(r,g);if(a.URL)p(a.URL.createObjectURL(r),!0);else{if("string"===typeof r||r.constructor===h)try{return p("data:"+l+";base64,"+a.btoa(r))}catch(w){return p("data:"+l+","+encodeURIComponent(r))}(o=new FileReader).onload=function(){p(this.result)},o.readAsDataURL(r)}return!0}}]),e}();x()(Ct,"KILOBYTE",1024),x()(Ct,"MEGABYTE",1048576),x()(Ct,"GIGABYTE",1073741824),x()(Ct,"TERABYTE",1099511627776);var kt=n(21),St=function(e){function t(e,n,i){var r;return E()(this,t),r=C()(this,S()(t).call(this)),x()(O()(r),"numberOfPages",0),x()(O()(r),"numberOfItemsPerPage",14),x()(O()(r),"rows",[]),x()(O()(r),"currentPage",null),x()(O()(r),"jq",void 0),x()(O()(r),"tableName",void 0),x()(O()(r),"database",void 0),x()(O()(r),"sortColumnName",void 0),x()(O()(r),"sortColumnDirection",void 0),x()(O()(r),"embeddedRootNode",void 0),x()(O()(r),"rowOffsetStart",0),x()(O()(r),"selectedRowIndex",void 0),x()(O()(r),"newRows",[]),r.jq=e,r.tableName=n,r.database=i,"controls"===r.tableName&&(r.numberOfItemsPerPage=99999),r}return A()(t,e),T()(t,[{key:"getNumberOfPages",value:function(){return this.numberOfPages}},{key:"getNumberOfItemsPerPage",value:function(){return this.numberOfItemsPerPage}},{key:"getColumnDescriptors",value:function(){for(var e=this.database.getTable(this.tableName).describe(),n=[],i=0,r=e.length;i<r;i++)n.push({caption:e[i].name,name:e[i].name,type:t.convertJQLColumnTypeToGridColumnType(e[i].type),editable:!0});return n}},{key:"getCurrentPageNumber",value:function(){return this.currentPage}},{key:"setPage",value:function(e){return t=this,this.jq.Deferred((function(n){var i=t.getUncomittedRows();try{var r=t.database.createStatement(t.computePageFetchSQL(e,t.numberOfItemsPerPage,t.sortColumnName,t.sortColumnDirection));t.database.executeStatement(r).then((function(n){t.setSelectedRowIndex(null),t.onNumberOfPagesChanged(t.computeNumberOfPages(n.getCalcFoundRows())),t.rowOffsetStart=(e-1)*t.numberOfItemsPerPage+1,t.onCurrentPageChanged(e),t.rows=[];for(var r=0,o=n.getRowsAsArray(),a=o.length;r<a;r++)t.rows.push(o[r]);t.newRows=[];for(var s=0,l=i.length;s<l;s++)t.rows.push(i[s]),t.newRows.push(t.rows.length-1);t.trigger("change")})).catch((function(e){n.reject(e)}))}catch(o){n.reject(o)}})).promise();var t}},{key:"getNumberOfItemsOnCurrentPage",value:function(){return this.rows.length}},{key:"getRowAt",value:function(e){return JSON.parse(JSON.stringify(this.rows[e]))}},{key:"setSortedColumn",value:function(e,t){return this.sortColumnName=e,this.sortColumnDirection=t,this.setPage(this.currentPage)}},{key:"getGridFooterHTMLMarkup",value:function(){return'\n            <button data-role="previous-page"><span class="i-md i123-arrow_left"></span></button>\n            <label data-role="current-page"><span>Page: </span><input type="number" name="current-page" value="1" min="1" max="1" /></label>\n            <label data-role="total-pages"><span>of&nbsp;</span><span data-role="total-pages">0</span></label>\n            <button data-role="next-page"><span class="i-md i123-arrow_right"></span></button>\n            <span style="width: 20px"></span>\n            <button data-role="refresh" title="Refresh"><span class="i-md i123-refresh"></span></button>\n            <span style="width: 20px"></span>\n            <button data-role="insert-row" title="Insert row"><span class="i-md i123-add"></span></button>\n            <button data-role="delete-current-row" disabled title="Delete row"><span class="i-md i123-delete"></span></button>\n        '}},{key:"onCollectionEmbedded",value:function(e){var t,n;t=this.jq,(n=this).embeddedRootNode=e,t(e).find("input[name=current-page]").on("change",(function(){var e=~~this.value;e>=1&&e<=n.getNumberOfPages()?n.setPage(e):this.value=n.getCurrentPageNumber()})),t(e).find("button[data-role=previous-page]").on("click",(function(){n.getCurrentPageNumber()<=1||n.setPage(n.getCurrentPageNumber()-1)})),t(e).find("button[data-role=next-page]").on("click",(function(){n.getCurrentPageNumber()>=n.getNumberOfPages()||n.setPage(n.getCurrentPageNumber()+1)})),t(e).find("button[data-role=delete-current-row]").on("click",(function(){null!==n.selectedRowIndex&&n.deleteRow(n.selectedRowIndex)})),t(e).find("button[data-role=insert-row]").on("click",(function(){var e=n.createRow();n.rows.push(e),n.newRows.push(n.rows.length-1),n.trigger("insert-row",e)})),t(e).find("button[data-role=refresh]").on("click",(function(){n.setPage(n.getCurrentPageNumber())}))}},{key:"dispose",value:function(){this.events=void 0}},{key:"computePageFetchSQL",value:function(e,t,n,i){var r="";return this.database.getTable(this.tableName).isVirtual()||"session"===this.tableName||(r+="REMOTE "),r+="SELECT SQL_CALC_FOUND_ROWS * FROM "+this.tableName,!n||i!==mt.DESCENDING&&i!==mt.ASCENDING||(r+=" ORDER BY "+n,this.sortColumnDirection==mt.ASCENDING?r+=" ASC":r+=" DESC"),r+=" LIMIT "+(e-1)*t+","+t,console.warn(r),r}},{key:"computeNumberOfPages",value:function(e){return e%this.numberOfItemsPerPage===0?~~(e/this.numberOfItemsPerPage):1+~~(e/this.numberOfItemsPerPage)}},{key:"onNumberOfPagesChanged",value:function(e){var t,n;this.numberOfPages=e,(t=this.jq)((n=this).embeddedRootNode).find("span[data-role=total-pages]").each((function(){this.textContent=String(e)})),t(n.embeddedRootNode).find("input[name=current-page]").attr("max",String(e))}},{key:"getFirstRowOffsetStart",value:function(){return this.rowOffsetStart}},{key:"onCurrentPageChanged",value:function(e){this.currentPage=e,(0,this.jq)(this.embeddedRootNode).find("input[name=current-page]").each((function(){this.value!=e&&(this.value=e)}))}},{key:"updateRow",value:function(e,t,n){return function(i,r){if(r.isUncommitedRow(e))return r.rows[e][t]=n,r.attemptToInsertRow(e),i.Deferred((function(e){e.resolve(!0)}));try{var o=r.database.getTable(r.tableName),a=o.describe(),s=[],l="";o.isVirtual()||"session"===r.tableName||(l+="REMOTE "),l+="UPDATE "+r.tableName+" SET `"+a[t].name+"` = :____new_value____ WHERE ";for(var u={____new_value____:n},c=0,d=a.length;c<d;c++)a[t].name!=a[c].name&&(null!==r.castBinding(r.rows[e][c],a[c].type)?(s.push("`"+a[c].name+"` = :"+a[c].name),u[a[c].name]=r.castBinding(r.rows[e][c],a[c].type)):s.push("`"+a[c].name+"` IS NULL"));l+=s.join(" AND "),l+=" LIMIT 1";var h=r.database.createStatement(l);return console.warn(l),i.Deferred((function(i){r.database.executeStatement(h,u).then((function(o){1===o.getAffectedRows()?(r.rows[e][t]=n,i.resolve(!0)):i.reject(new Error("No rows affected!"))})).catch((function(e){i.reject(e)}))}))}catch(f){return i.Deferred((function(e){e.reject(f)}))}}(this.jq,this)}},{key:"setSelectedRowIndex",value:function(e){this.selectedRowIndex=0===e?0:e||null,function(e,t,n){e(t).find("button[data-role=delete-current-row]").each((function(){this.disabled=null===n}))}(this.jq,this.embeddedRootNode,this.selectedRowIndex)}},{key:"deleteRow",value:function(e){return function(t,n){if(n.isUncommitedRow(e))return n.deleteUncommitedRow(e),n.setPage(n.getCurrentPageNumber());try{var i=n.database.getTable(n.tableName).describe(),r="";"session"!==n.tableName&&(r+="REMOTE "),r+="DELETE FROM "+n.tableName+" WHERE ";for(var o={},a=0,s=i.length;a<s;a++)null!==n.castBinding(n.rows[e][a],i[a].type)?(r+=(a>0?" AND ":"")+"`"+i[a].name+"` = :"+i[a].name,o[i[a].name]=n.castBinding(n.rows[e][a],i[a].type)):r+=(a>0?" AND ":"")+"`"+i[a].name+"` IS NULL";r+=" LIMIT 1";var l=n.database.createStatement(r);return console.warn(r),t.Deferred((function(e){n.database.executeStatement(l,o).then((function(t){1===t.getAffectedRows()?(n.setPage(n.getCurrentPageNumber()),e.resolve(!0)):e.reject(new Error("No rows affected!"))})).catch((function(t){e.reject(t)}))}))}catch(u){return console.error(u),t.Deferred((function(e){e.reject(u)}))}}(this.jq,this)}},{key:"castBinding",value:function(e,t){switch(t){case f.BOOLEAN:return null===e?null:"0"!==e&&!!~~e;case f.NUMBER:if(null===e)return null;var n=parseFloat(String(e));return!isNaN(n)&&isFinite(n)?n:null;default:return e}}},{key:"createRow",value:function(){for(var e=[],t=this.database.getTable(this.tableName).describe(),n=0,i=t.length;n<i;n++)switch(t[n].type){case f.BOOLEAN:e.push(!1);break;case f.STRING:e.push("");break;case f.NUMBER:e.push(0);break;default:case f.NULL:e.push(null)}return e}},{key:"isUncommitedRow",value:function(e){return this.newRows.indexOf(e)>-1}},{key:"deleteUncommitedRow",value:function(e){this.rows.splice(e,1);for(var t=0,n=this.newRows.length;t<n;t++)if(this.newRows[t]===e){this.newRows.splice(t,1);break}for(var i=0,r=this.newRows.length;i<r;i++)if(this.newRows[i]>e){this.newRows[i]--;break}}},{key:"markRowAsComitted",value:function(e){for(var t=0,n=this.newRows.length;t<n;t++)if(this.newRows[t]===e){this.newRows.splice(t,1);break}this.trigger("commit-row",e)}},{key:"getUncomittedRows",value:function(){for(var e=[],t=0,n=this.newRows.length;t<n;t++)e.push(this.rows[this.newRows[t]]);return e}},{key:"attemptToInsertRow",value:function(e){return function(t,n){if(!n.isUncommitedRow(e))return t.Deferred((function(e){e.reject(new Error("Row is already in comitted state!"))})).promise();try{var i=n.database.getTable(n.tableName).describe(),r="";r+="REMOTE ",r+="INSERT INTO "+n.tableName+" SET ";for(var o={},a=0,s=i.length;a<s;a++)null!==n.castBinding(n.rows[e][a],i[a].type)?(r+=(a>0?" , ":"")+"`"+i[a].name+"` = :"+i[a].name,o[i[a].name]=n.castBinding(n.rows[e][a],i[a].type)):r+=(a>0?" , ":"")+"`"+i[a].name+"` = NULL";var l=n.database.createStatement(r);return console.warn(r),t.Deferred((function(t){n.database.executeStatement(l,o).then((function(i){n.markRowAsComitted(e),t.resolve(!0)})).catch((function(e){t.reject(e)}))}))}catch(u){return t.Deferred((function(e){e.reject(u)}))}}(this.jq,this)}}],[{key:"convertJQLColumnTypeToGridColumnType",value:function(e){switch(e){case f.STRING:return pt.b.STRING;case f.NUMBER:return pt.b.NUMBER;case f.BOOLEAN:return pt.b.BOOLEAN;case f.NULL:default:return pt.b.UNKNOWN}}}]),t}(function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),t}(_.a)),It=function(e){function t(){return E()(this,t),C()(this,S()(t).apply(this,arguments))}return A()(t,e),T()(t,[{key:"getGridFooterHTMLMarkup",value:function(){return'\n            <button data-role="previous-page"><span class="i-md i123-arrow_left"></span></button>\n            <label data-role="current-page"><span>Page: </span><input type="number" name="current-page" value="1" min="1" max="1" /></label>\n            <label data-role="total-pages"><span>of&nbsp;</span><span data-role="total-pages">0</span></label>\n            <button data-role="next-page"><span class="i-md i123-arrow_right"></span></button>\n        '}}]),t}(St),Ot=function(){function e(t){var n=this;E()(this,e),x()(this,"uniqueId",void 0),x()(this,"rootDOMNode",void 0),x()(this,"controlsDOMNode",void 0),x()(this,"eventsDOMNode",void 0),x()(this,"controlId",null),x()(this,"eventTypeId",null),x()(this,"index",null),x()(this,"selected",!1),x()(this,"formControlsList",void 0),x()(this,"actions",[]),e.UID++,this.uniqueId=e.UID,this.rootDOMNode=document.createElement("div"),this.rootDOMNode.setAttribute("data-role","rule"),this.controlsDOMNode=document.createElement("select"),this.controlsDOMNode.setAttribute("data-role","control"),this.rootDOMNode.appendChild(this.controlsDOMNode),this.eventsDOMNode=document.createElement("select"),this.eventsDOMNode.setAttribute("data-role","event"),this.formControlsList=t,this.initFormControlsList(),this.controlsDOMNode.onchange=function(){n.controlId=""===n.controlsDOMNode.value?null:n.controlsDOMNode.value,n.initEventsDOMNodeDropdown(n.controlsDOMNode.value),n.onErrorStateChanged()},this.eventsDOMNode.onchange=function(){n.eventTypeId=""===n.eventsDOMNode.value?null:parseInt(n.eventsDOMNode.value),n.onErrorStateChanged()},this.initEventsDOMNodeDropdown(this.eventsDOMNode.value),this.rootDOMNode.appendChild(this.eventsDOMNode),this.rootDOMNode.setAttribute("data-rule-uid",String(this.uniqueId)),this.onErrorStateChanged()}return T()(e,[{key:"getControlId",value:function(){return this.controlId}},{key:"withControlId",value:function(e){if(this.controlId=e||null,!this.controlId)return this.controlsDOMNode.value="",this;for(var t=-1,n=0,i=this.formControlsList.length;n<i;n++)if(this.formControlsList[n].id===e){t=n;break}if(-1===t&&"control_0"!==e){var r=document.createElement("option");r.value=e,r.text="DELETED "+this.controlId,this.controlsDOMNode.add(r)}return this.controlsDOMNode.value=this.controlId,this.initEventsDOMNodeDropdown(this.controlsDOMNode.value),this.onErrorStateChanged(),this}},{key:"getEventTypeId",value:function(){return this.eventTypeId}},{key:"withEventTypeId",value:function(e){return this.eventTypeId=e,this.eventsDOMNode.value=null===e?"":String(e),this.onErrorStateChanged(),this}},{key:"getRootDOMNode",value:function(){return this.rootDOMNode}},{key:"initEventsDOMNodeDropdown",value:function(e){for(var t=this.eventsDOMNode.value;this.eventsDOMNode.options.length;)this.eventsDOMNode.remove(0);var n=document.createElement("option");n.value="",n.text="[Select]",this.eventsDOMNode.add(n),"control_0"!==e?((n=document.createElement("option")).value=JSON.stringify(y.ALL_EVENTS),n.text="* Any",this.eventsDOMNode.add(n),(n=document.createElement("option")).value=JSON.stringify(y.INIT),n.text="Initialized",this.eventsDOMNode.add(n),(n=document.createElement("option")).value=JSON.stringify(y.CHANGE),n.text="Changed",this.eventsDOMNode.add(n),(n=document.createElement("option")).value=JSON.stringify(y.CHECK),n.text="Checked",this.eventsDOMNode.add(n),(n=document.createElement("option")).value=JSON.stringify(y.UNCHECK),n.text="Unchecked",this.eventsDOMNode.add(n),(n=document.createElement("option")).value=JSON.stringify(y.TEXT_INPUT),n.text="Edited",this.eventsDOMNode.add(n),(n=document.createElement("option")).value=JSON.stringify(y.INIT),n.text="Initialized",(n=document.createElement("option")).value=JSON.stringify(y.REINITIALIZE),n.text="Reloaded",this.eventsDOMNode.add(n)):((n=document.createElement("option")).value=JSON.stringify(y.SUBMITTED),n.text="Submitted",this.eventsDOMNode.add(n),(n=document.createElement("option")).value=JSON.stringify(y.APPROVED),n.text="Approved",this.eventsDOMNode.add(n)),this.eventsDOMNode.value=t,-1===this.eventsDOMNode.selectedIndex&&(this.eventsDOMNode.selectedIndex=0)}},{key:"initFormControlsList",value:function(){for(;this.controlsDOMNode.options.length;)this.controlsDOMNode.remove(0);var e=document.createElement("option");e.value="",e.text="[Select]",this.controlsDOMNode.add(e),(e=document.createElement("option")).value="control_0",e.text="[This Form]",this.controlsDOMNode.add(e);for(var t=0,n=this.formControlsList.length;t<n;t++)(e=document.createElement("option")).value=this.formControlsList[t].id,e.text=this.formControlsList[t].name,this.controlsDOMNode.add(e)}},{key:"isSelected",value:function(){return this.selected}},{key:"setSelected",value:function(e){this.selected=!!e,this.selected?this.rootDOMNode.setAttribute("data-selected",""):this.rootDOMNode.removeAttribute("data-selected")}},{key:"getUniqueId",value:function(){return this.uniqueId}},{key:"addAction",value:function(e){return this.actions.push(e),e.withParentRule(this),e}},{key:"deleteAction",value:function(e){for(var t=0,n=this.actions.length;t<n;t++)if(this.actions[t]===e)return this.actions.splice(t,1)[0];return null}},{key:"getActions",value:function(){return this.actions.slice(0)}},{key:"getActionByUniqueId",value:function(e){for(var t=0,n=this.actions.length;t<n;t++)if(this.actions[t].getUniqueId()===e)return this.actions[t];return null}},{key:"onErrorStateChanged",value:function(){if(this.controlId&&null!==this.eventTypeId){for(var e=0,t=this.actions.length;e<t;e++)if(this.actions[e].getRootDOMNode().hasAttribute("data-has-errors"))return void this.rootDOMNode.setAttribute("data-has-errors","");this.rootDOMNode.removeAttribute("data-has-errors")}else this.rootDOMNode.setAttribute("data-has-errors","")}},{key:"getSelectedAction",value:function(){for(var e=0,t=this.actions.length;e<t;e++)if(this.actions[e].isActive())return this.actions[e];return null}},{key:"setSelectedAction",value:function(e){for(var t=0,n=this.actions.length;t<n;t++)this.actions[t]===e?this.actions[t].setActive(!0):this.actions[t].isActive()&&this.actions[t].setActive(!1)}},{key:"moveActionUp",value:function(e){var t=null;if(!(this.actions.length<2)){for(var n=0,i=this.actions.length;n<i;n++)if(this.actions[n]===e){t=n;break}if(0!==t&&null!==t){this.actions.splice(t,1);var r=e.getRootDOMNode().previousSibling;e.getRootDOMNode().parentNode.removeChild(e.getRootDOMNode()),this.actions.splice(t-1,0,e),r.parentNode.insertBefore(e.getRootDOMNode(),r)}}}},{key:"moveActionDown",value:function(e){var t=null;if(!(this.actions.length<2)){for(var n=0,i=this.actions.length;n<i;n++)if(this.actions[n]===e){t=n;break}if(t!==this.actions.length-1&&null!==t){this.actions.splice(t,1);var r=e.getRootDOMNode().nextSibling;e.getRootDOMNode().parentNode.removeChild(e.getRootDOMNode()),this.actions.splice(t+1,0,e),r.parentNode.insertBefore(e.getRootDOMNode(),r.nextSibling)}}}}]),e}();x()(Ot,"UID",0);var Dt=function(){function e(t,n,i,r){var o=this;E()(this,e),x()(this,"uniqueId",void 0),x()(this,"rootDOMNode",void 0),x()(this,"actionTypeDOMNode",void 0),x()(this,"formControlsList",void 0),x()(this,"targetControlDOMNode",void 0),x()(this,"sqlTextEditor",void 0),x()(this,"sql",""),x()(this,"db",void 0),x()(this,"errorDOMNode",void 0),x()(this,"error",null),x()(this,"statement",null),x()(this,"toolbarDOMNode",void 0),x()(this,"jq",void 0),x()(this,"carretCharIndex",0),x()(this,"carretLineIndex",0),x()(this,"commandDispatcher",void 0),x()(this,"onCursorPositionChangedThrottled",void 0),x()(this,"editorInited",!1),x()(this,"parentRule",void 0),x()(this,"active",!1),this.db=n,this.jq=i,this.commandDispatcher=r,e.UID++,this.uniqueId=e.UID,this.rootDOMNode=document.createElement("div"),this.rootDOMNode.setAttribute("data-role","action"),this.rootDOMNode.setAttribute("data-action-uid",String(this.uniqueId)),this.actionTypeDOMNode=document.createElement("select"),this.actionTypeDOMNode.setAttribute("data-role","action-type"),this.rootDOMNode.appendChild(this.actionTypeDOMNode),this.formControlsList=t,this.targetControlDOMNode=document.createElement("select"),this.targetControlDOMNode.setAttribute("data-role","target-control"),this.rootDOMNode.appendChild(this.targetControlDOMNode),this.toolbarDOMNode=document.createElement("div"),this.toolbarDOMNode.setAttribute("data-role","toolbar"),this.rootDOMNode.appendChild(this.toolbarDOMNode),this.iniToolbar(),this.errorDOMNode=document.createElement("div"),this.errorDOMNode.setAttribute("data-role","error"),this.onCursorPositionChangedThrottled=F.a.create((function(){o.onCursorPositionChanged()}),300),this.initActionTypeDOMNode(),this.initTargetControlDOMNode(),this.actionTypeDOMNode.onchange=function(){o.onCursorPositionChangedThrottled(),o.onErrorStateChanged()},this.targetControlDOMNode.onchange=function(){o.onCursorPositionChangedThrottled(),o.onErrorStateChanged()}}return T()(e,[{key:"asyncInitCodeMirrorEditor",value:function(){var e,t,n,i,r,o;this.editorInited||((e=this).sqlTextEditor=null===(t=CodeMirror)||void 0===t?void 0:t(e.rootDOMNode,{value:"asd",mode:"text/x-mariadb",lineNumbers:!0}),e.rootDOMNode.appendChild(e.errorDOMNode),null===(n=e.sqlTextEditor)||void 0===n||n.setSize("100%","80px"),null===(i=e.sqlTextEditor)||void 0===i||i.setValue(e.sql),null===(r=e.sqlTextEditor)||void 0===r||r.on("change",(function(){var t,n;e.sql=null!==(t=null===(n=e.sqlTextEditor)||void 0===n?void 0:n.getValue())&&void 0!==t?t:"",e.onSQLQueryChanged()})),null===(o=e.sqlTextEditor)||void 0===o||o.on("cursorActivity",(function(t){var n=t.getCursor();e.carretCharIndex=n.ch,e.carretLineIndex=n.line,e.onCursorPositionChangedThrottled()})),this.editorInited=!0)}},{key:"getRootDOMNode",value:function(){return this.rootDOMNode}},{key:"getUniqueId",value:function(){return this.uniqueId}},{key:"initActionTypeDOMNode",value:function(){var e=document.createElement("option");e.text="Execute SQL using:",e.value="run",this.actionTypeDOMNode.add(e),(e=document.createElement("option")).text="Set value of control:",e.value="set",this.actionTypeDOMNode.add(e)}},{key:"initTargetControlDOMNode",value:function(){var e=document.createElement("option");e.text="[Select]",e.value="",this.targetControlDOMNode.add(e);for(var t=0,n=this.formControlsList.length;t<n;t++)(e=document.createElement("option")).text=this.formControlsList[t].name,e.value=this.formControlsList[t].id,this.targetControlDOMNode.appendChild(e)}},{key:"getError",value:function(){return this.error}},{key:"getStatement",value:function(){return this.statement}},{key:"onSQLQueryChanged",value:function(){try{if(""===String(this.sql).trim())return this.rootDOMNode.removeAttribute("data-error-state"),this.errorDOMNode.textContent="",this.error=null,this.statement=null,void this.onErrorStateChanged();this.statement=this.db.createStatement(this.sql),this.errorDOMNode.textContent="",this.error=null,this.onErrorStateChanged()}catch(e){this.errorDOMNode.textContent=String(e).replace(/^Error: /g,"").replace(/^Failed to create statement: /g,""),this.error=e,this.statement=null,this.onErrorStateChanged()}}},{key:"iniToolbar",value:function(){var e;this.toolbarDOMNode.innerHTML='\n            <button data-role="insert-table" title="Insert table"><span class="i-md i123-memory" ></span></button>\n            <button data-role="insert-column" title="Insert column"><span class="i-md i123-reports" ></span></button>\n            <button data-role="insert-control" title="Insert form control"><span class="i-md i123-input_area" ></span></button>\n            <div data-role="editor-selection-feedback"></div>\n        ',(0,this.jq)((e=this).toolbarDOMNode).on("click","button[data-role]",(function(){switch(this.getAttribute("data-role")){case"insert-table":e.commandDispatcher.browserForDatabaseTablesDialog().then((function(t){var n;null===(n=e.sqlTextEditor)||void 0===n||n.replaceSelection(t,!0)}));break;case"insert-column":e.commandDispatcher.browserForDatabaseTableColumnsDialog().then((function(t){var n;null===(n=e.sqlTextEditor)||void 0===n||n.replaceSelection(t,!0)}));break;case"insert-control":e.commandDispatcher.browseForFormsControlDialog().then((function(t){var n;null===(n=e.sqlTextEditor)||void 0===n||n.replaceSelection(t,!0)}))}}))}},{key:"onCursorPositionChanged",value:function(){var e,t=this.sql.split("\n")[this.carretLineIndex],n=this.getIdentifierFromStringPosition(t,this.carretCharIndex);e=this,/^control_[\d]+(_[\d]+)?$/.test(n)?e.jq(e.toolbarDOMNode).find("[data-role=editor-selection-feedback]").each((function(){for(var t="<b>UNKNOWN</b> control <b>:"+n+"</b>",i=0,r=e.formControlsList.length;i<r;i++)if(e.formControlsList[i].id==n){t="<b>:"+n+"</b> => <b>"+e.formControlsList[i].name+"</b>";break}this.innerHTML=t})):"this"===n?e.jq(e.toolbarDOMNode).find("[data-role=editor-selection-feedback]").each((function(){if(e.getParentRule().getControlId()){for(var t="",n=e.getParentRule().getControlId(),i=0,r=e.formControlsList.length;i<r;i++)e.formControlsList[i].id===n&&(t=e.formControlsList[i].name);this.innerHTML=t?"<b>:this</b> => <b>"+t+"</b> (:"+n+")":"<b>:this</b> => Select a control on the rule"}else this.innerHTML="<b>:this</b> => Select a control on the rule"})):e.jq(e.toolbarDOMNode).find("[data-role=editor-selection-feedback]").text("")}},{key:"getIdentifierFromStringPosition",value:function(t,n){var i,r,o="",a="",s=t.length;for(r=n-1;r>=0&&e.IDENTIFIER_CHARS.indexOf(i=t.charAt(r))>-1;)o=i+o,r--;for(r=n;r<s&&e.IDENTIFIER_CHARS.indexOf(i=t.charAt(r))>-1;)a+=i,r++;return(o+a).replace(/^[0-9]+/g,"")}},{key:"withSQL",value:function(e){return this.sql=e||"",this.carretLineIndex=0,this.carretCharIndex=0,this.onSQLQueryChanged(),this.onErrorStateChanged(),this}},{key:"withControlId",value:function(e){for(var t=0,n=this.formControlsList.length;t<n;t++)if(this.formControlsList[t].id===e)return this.targetControlDOMNode.value=e,this;var i=document.createElement("option");return i.value=e,i.text="DELETED "+e,this.targetControlDOMNode.add(i),this.targetControlDOMNode.value=e,this}},{key:"getControlId",value:function(){return this.targetControlDOMNode.value}},{key:"getSQL",value:function(){return this.sql}},{key:"onErrorStateChanged",value:function(){this.statement&&(this.statement.getStatementType()===r.SELECT?"set"!==this.actionTypeDOMNode.value&&(this.actionTypeDOMNode.value="set"):"run"!==this.actionTypeDOMNode.value&&(this.actionTypeDOMNode.value="run"));var e=this.rootDOMNode.hasAttribute("data-has-errors");this.error||!this.statement?e||(this.rootDOMNode.setAttribute("data-has-errors",""),this.parentRule&&this.parentRule.onErrorStateChanged()):e&&(this.rootDOMNode.removeAttribute("data-has-errors"),this.parentRule&&this.parentRule.onErrorStateChanged())}},{key:"getParentRule",value:function(){return this.parentRule}},{key:"withParentRule",value:function(e){return this.parentRule=e,this}},{key:"setActive",value:function(e){return this.active=!!e,this.active?this.rootDOMNode.setAttribute("data-selected",""):this.rootDOMNode.removeAttribute("data-selected"),this}},{key:"isActive",value:function(){return this.active}}]),e}();x()(Dt,"IDENTIFIER_CHARS","abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789"),x()(Dt,"UID",0);var At=function(e){function t(){var e,n;E()(this,t);for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];return n=C()(this,(e=S()(t)).call.apply(e,[this].concat(r))),x()(O()(n),"rules",[]),n}return A()(t,e),T()(t,[{key:"addRule",value:function(e){this.rules.length;return this.rules.push(e),this.trigger("change"),e}},{key:"deleteRule",value:function(e){for(var t=0,n=this.rules.length;t<n;t++)if(this.rules[t]===e){var i=this.rules.splice(t,1)[0];return this.trigger("change"),i}return null}},{key:"setSelectedRule",value:function(e){for(var t=0,n=this.rules.length;t<n;t++)this.rules[t]===e?this.rules[t].setSelected(!0):this.rules[t].isSelected()&&this.rules[t].setSelected(!1)}},{key:"getSelectedRule",value:function(){for(var e=0,t=this.rules.length;e<t;e++)if(this.rules[e].isSelected())return this.rules[e];return null}},{key:"getRuleByUniqueId",value:function(e){for(var t=0,n=this.rules.length;t<n;t++)if(this.rules[t].getUniqueId()===e)return this.rules[t];return null}},{key:"getRules",value:function(){return this.rules}},{key:"getJQLConfiguration",value:function(){for(var e=[],t=0,n=this.rules.length;t<n;t++){for(var i={actions:[],eventType:this.rules[t].getEventTypeId(),controlId:this.rules[t].getControlId()},r=0,o=this.rules[t].getActions(),a=o.length;r<a;r++)i.actions.push({controlId:o[r].getControlId(),jql:o[r].getSQL()});e.push(i)}return e}},{key:"moveRuleUp",value:function(e){var t=null;if(!(this.rules.length<2)){for(var n=0,i=this.rules.length;n<i;n++)if(this.rules[n]===e){t=n;break}if(0!==t&&null!==t){this.rules.splice(t,1);var r=e.getRootDOMNode().previousSibling;e.getRootDOMNode().parentNode.removeChild(e.getRootDOMNode()),this.rules.splice(t-1,0,e),r.parentNode.insertBefore(e.getRootDOMNode(),r)}}}},{key:"moveRuleDown",value:function(e){var t=null;if(!(this.rules.length<2)){for(var n=0,i=this.rules.length;n<i;n++)if(this.rules[n]===e){t=n;break}if(t!==this.rules.length-1&&null!==t){this.rules.splice(t,1);var r=e.getRootDOMNode().nextSibling;e.getRootDOMNode().parentNode.removeChild(e.getRootDOMNode()),this.rules.splice(t+1,0,e),r.parentNode.insertBefore(e.getRootDOMNode(),r.nextSibling)}}}}],[{key:"createFromJQLFormRulesConfiguration",value:function(e,n,i,r,o){for(var a=new t,s=0,l=e.length;s<l;s++){var u=a.addRule(new Ot(n));u.withControlId(e[s].controlId).withEventTypeId(e[s].eventType);for(var c=0,d=(e[s].actions||[]).length;c<d;c++){u.addAction(new Dt(n,i,r,o)).withSQL(e[s].actions[c].jql).withControlId(e[s].actions[c].controlId)}}return setTimeout((function(){for(var e=0,t=a.getRules(),n=t.length;e<n;e++)t[e].onErrorStateChanged()}),100),a}}]),t}(_.a),Rt=function(){function e(t){E()(this,e),x()(this,"app",void 0),x()(this,"csvParserOptions",{endOfLineCharacter:"\r\n",columnsEnclosedBy:'"',columnsTerminatedBy:",",fieldsEscapedBy:"",autoTrimAllFields:!0,allColumnsAreEnclosed:!1}),this.app=t}return T()(e,[{key:"setApplicationEnabledStateAction",value:function(e){var t,n,i;t=this.app.getJQuery(),n=this.app,i=this.app,this.app.getResourceManager(),t.ajax("/sf_applications_actions.php",{type:"POST",data:{someaction:"applications_csvconnector_enable_disable",appid:String(i.getApplicationId()),formid:String(i.getFormId()),a_enabled:e?"1":"0"}}).then((function(t){"OK"===String(t||"").trim()&&(e?n.createNotification("Virtual Database & SQL Manager application settings saved successfully",!1,pt.d.SUCCESS,!0):n.createNotification("Virtual Database & SQL Manager application was successfully disabled for this form",!1,pt.d.SUCCESS,!0))})).fail((function(){n.createNotification("Failed to change Virtual Database & SQL Manager enabled state",!1,pt.d.ERROR,!0)}))}},{key:"createNewTableAction",value:function(){var e,t,n,i;e=this.app.getJQuery(),t=this.app,this.app,n=this.app.getResourceManager(),i=this,n.get("/modules/RulesV3/resources/create-new-table-action.html").then((function(n){var r=new kt.a(n),o=null,a=t.createDialog("Create new table",[{type:pt.c.CREATE,callback:function(){try{var n={csvFile:o,tableName:e(a.body).find("label[data-role=database-name] input").val(),tableNamespace:e(a.body).find("label[data-role=database-global-flag] input").is(":checked")?m.GLOBAL:m.FORM,tableAccessMode:e(a.body).find("label[data-role=table-write-access] input").is(":checked")?v.READ_WRITE:v.READ,tableStorageEngine:e(a.body).find("label[data-role=table-storage-engine] input").is(":checked")?p.REMOTE:p.IN_MEMORY,csvFieldEnclosure:i.csvParserOptions.columnsEnclosedBy,csvEncloseAllFields:i.csvParserOptions.allColumnsAreEnclosed,csvFieldDelimiter:i.csvParserOptions.columnsTerminatedBy,csvEscapeCharacter:i.csvParserOptions.fieldsEscapedBy,csvAutoTrim:i.csvParserOptions.autoTrimAllFields,csvLineTerminator:i.csvParserOptions.endOfLineCharacter};if(!n.tableName)throw new Error("Please input a Database table name");if(!o)throw new Error("Please select a CSV file first");if(!o.size)throw new Error("Selected file is empty. Please select a non-empty file");if(!/^([\s\S]+)\.csv$/i.test(o.name))throw new Error('Selected file seems not to be a csv file ("'+o.type+'"). Please select a CSV file');if(o.size>15728640)throw new Error("Selected file size is greater than 15Mb, which is the maximum csv file size");i.app.getDatabase().createTableFromCSVFile(n).then((function(){t.alert("Table created","Table '"+n.tableName+"' was successfully created!",(function(){a.close()}))})).catch((function(e){t.alert("Failed to create table",'There was an error encountered while trying to create your table. Please inspect if the "Advanced options" settings are set up correctly.')}))}catch(r){t.alert("Error creating database table",String(r||"").replace(/^Error: /g,""))}}},{type:pt.c.CANCEL,callback:function(){a.close()}}],{width:"600px"});a.body.innerHTML=r.parse({}),a.body.setAttribute("data-dialog-role","csv-connector-create-table-dialog"),e(a.body).each((function(){e(this).on("click","label[data-role=database-source] a",(function(){i.editAdvancedCSVSettingsPreferencesAction()})),e(this).find("label[data-role=csv-file] input[type=file]").on("change",(function(){o=this.files[0],e(a.body).find("label[data-role=csv-file]").addClass("has-file").find("span.file-name").text(o.name),this.value=null})),e(this).find("label[data-role=csv-file] a").on("click",(function(){e(a.body).find("label[data-role=csv-file]").removeClass("has-file").find("span.file-name").text(""),o=null}))}))})).fail((function(e){t.createNotification('Failed to load "modules/RulesV3/resources/create-new-table-action.html',!1,pt.d.ERROR,!0)}))}},{key:"editAdvancedCSVSettingsPreferencesAction",value:function(){var e,t,n,i;e=this.app.getJQuery(),t=this.app,this.app,n=this.app.getResourceManager(),i=this,n.get("/modules/RulesV3/resources/edit-csv-import-file-options.html").then((function(n){var r=new kt.a(n),o=JSON.parse(JSON.stringify(i.csvParserOptions)),a=t.createDialog("Advanced options",[{type:pt.c.DONE,callback:function(){e(a.body).each((function(){e(this).find("label[data-role=auto-trim-all-fields] input").each((function(){i.csvParserOptions.autoTrimAllFields=this.checked})),e(this).find("label[data-role=enclose-all-fields] input").each((function(){i.csvParserOptions.allColumnsAreEnclosed=this.checked})),e(this).find("label[data-role=end-of-line] select").each((function(){i.csvParserOptions.endOfLineCharacter=i.html2RawString(this.value)})),e(this).find("label[data-role=columns-terminated-by] select").each((function(){i.csvParserOptions.columnsTerminatedBy=i.html2RawString(this.value)})),e(this).find("label[data-role=fields-escaped-by] select").each((function(){i.csvParserOptions.fieldsEscapedBy=i.html2RawString(this.value)})),e(this).find("label[data-role=columns-enclosed-by] select").each((function(){i.csvParserOptions.columnsEnclosedBy=i.html2RawString(this.value)}))})),a.close()}},{type:pt.c.CANCEL,callback:function(){a.close()}}],{width:"700px"});a.body.innerHTML=r.parse(o),a.body.setAttribute("data-dialog-role","csv-connector-edit-csv-options"),e(a.body).each((function(){e(this).find("label[data-role=auto-trim-all-fields] input").each((function(){this.checked=o.autoTrimAllFields})),e(this).find("label[data-role=enclose-all-fields] input").each((function(){this.checked=o.allColumnsAreEnclosed})),e(this).find("label[data-role=end-of-line] select").each((function(){this.value=i.rawString2HTML(o.endOfLineCharacter)})),e(this).find("label[data-role=columns-terminated-by] select").each((function(){this.value=i.rawString2HTML(o.columnsTerminatedBy)})),e(this).find("label[data-role=fields-escaped-by] select").each((function(){this.value=i.rawString2HTML(o.fieldsEscapedBy)})),e(this).find("label[data-role=columns-enclosed-by] select").each((function(){this.value=i.rawString2HTML(o.columnsEnclosedBy)})),e(this).find("form").on("submit",(function(e){e.preventDefault(),e.stopPropagation()}))}))})).fail((function(e){t.createNotification('Failed to load "modules/RulesV3/resources/edit-csv-import-file-options.html',!0,pt.d.ERROR,!0)}))}},{key:"exploreDatabasesAction",value:function(){var e,t,n,i,r;e=this.app.getJQuery(),t=this.app,n=this.app,i=this.app.getResourceManager(),r=this,i.get("/modules/RulesV3/resources/explore-database-dialog.html").then((function(i){var o,a,s={tables:function(){for(var e=[],t=n.getDatabase().enumerateTables(),i=0,r=t.length;i<r;i++){var o=n.getDatabase().getTable(t[i].name);e.push({name:t[i].name,isRemote:o.isRemote(),isInMemory:!o.isRemote()&&!o.isVirtual(),isVirtual:o.isVirtual(),isTransactional:o.isTransactional(),isIndexable:o.isIndexable()})}return e}()},l=new kt.a(i),u=t.createDialog("Explore database",[],{width:"920px",height:"600px"});u.body.innerHTML=l.parse(s),u.dialog.setAttribute("data-dialog-role","explore-database-dialog"),e(u.body).on("click","[data-role=table]",(function(){!function(t){console.warn("set view: ",t),t!==a&&(e(u.dialog).attr("data-has-selected-table",""),e(u.body).find("[data-role=tables-list] > [data-role=table]").each((function(){e(this).attr("data-selected",this.getAttribute("data-name")===t?"":null)})),a=t,o=o||new Nt(r.app.getJQuery()).withSortingEnabled(!0),window.g=o,e(u.body).find("[data-role=selected-table]").each((function(){this.appendChild(o.getRootDOMNode()),n.getDatabase().getTable(t).isVirtual()?o.withCollection(new It(e,t,n.getDatabase())).withEmptyStateHTML("Table <b>"+t+"</b> is a virtual table, which is only available in <b>view form</b> mode."):o.withCollection(new St(e,t,n.getDatabase())).withEmptyStateHTML("There are no items to show in this view")})))}(this.getAttribute("data-name"))})),e(u.body).on("click","[data-role=tables-operations] button[data-role=drop-database]",(function(){var n=null;e(u.body).find("[data-role=tables-list] > [data-role=table][data-selected]").each((function(){n=this.getAttribute("data-name")})),n&&t.prompt("Confirm table deletion",'Are you sure you want to delete table "'+n+'"?',(function(){r.app.getDatabase().dropTable(n,{applicationConfig:btoa(r.app.getDatabase().getApplicationConfig())}).then((function(){e(u.body).find("[data-role=tables-list] > [data-role=table][data-selected]").remove(),o&&o.getRootDOMNode()&&o.getRootDOMNode().parentNode.removeChild(o.getRootDOMNode()),e(u.dialog).attr("data-has-selected-table",null)})).catch((function(e){t.alert("Failed to delete table",'Failed to delete table "'+a+'"')}))}))})).on("click","[data-role=tables-operations] button[data-role=download-database]",(function(){var i=null;e(u.body).find("[data-role=tables-list] > [data-role=table][data-selected]").each((function(){i=this.getAttribute("data-name")})),i&&(n.getDatabase().getTable(i).isVirtual()?t.alert("Table not exportable",'Table "'+i+'" is a virtual table, and cannot be exported to CSV!'):r.app.getDatabase().downloadTableAsCSV(i,{applicationConfig:btoa(r.app.getDatabase().getApplicationConfig())}).then((function(e){"string"===typeof e?Ct.download(e,i+".csv","text/csv"):"object"===V()(e)&&e.value?Ct.download(e.value,i+".csv","text/csv"):t.alert("Table export failed!","There was an error exporting your table as CSV!")})).catch((function(e){t.alert("Table export failed!","There was an error exporting your table as CSV!"),console.error(e)})))})).on("click","[data-role=tables-operations] button[data-role=database-indexes]",(function(){var t=null;e(u.body).find("[data-role=tables-list] > [data-role=table][data-selected]").each((function(){t=this.getAttribute("data-name")})),t&&r.editTableIndexes(t)}))})).fail((function(e){t.createNotification('Failed to load "modules/RulesV3/resources/explore-database-dialog.html"',!0,pt.d.ERROR,!0)}))}},{key:"editFormRulesAction",value:function(){var e,t,n,i,r;e=this.app.getJQuery(),t=this.app,n=this.app,i=this.app.getResourceManager(),r=this,e.when(i.get("/modules/RulesV3/resources/edit-rules-dialog.html")).then((function(i){n.getDatabase().getJQLFormConfiguration({applicationConfig:btoa(n.getDatabase().getApplicationConfig())}).then((function(o){var a,s,l,u=new kt.a(i),c=At.createFromJQLFormRulesConfiguration(o||[],n.getFormControlsList(),n.getDatabase(),e,r),d=t.createDialog("Edit SQL rules",[{type:pt.c.SAVE,callback:function(){n.getDatabase().saveJQLFormConfiguration(c.getJQLConfiguration(),{applicationConfig:btoa(n.getDatabase().getApplicationConfig())}).then((function(){d.close()})).catch((function(){t.alert("Error saving configuration","There was an error saving configuration. Please fix errors, and try again")}))}},{type:pt.c.CANCEL,callback:function(){d.close()}}],{width:"800px",height:"800px"});d.dialog.setAttribute("data-dialog-role","edit-sql-rules"),d.body.innerHTML=u.parse({});var h=function(e){for(;l.firstChild;)l.removeChild(l.firstChild);if(e){l.setAttribute("data-rule-uid",String(e.getUniqueId()));for(var t=e.getActions(),n=t.length,i=0;i<n;i++)l.appendChild(t[i].getRootDOMNode()),t[i].asyncInitCodeMirrorEditor();e.setSelectedAction(e.getActions()[0]||null)}else l.removeAttribute("data-rule-id")};e(d.body).find("[data-role=rules]").each((function(){e(a=this).on("click","> [data-role=rule]",(function(){var e=~~this.getAttribute("data-rule-uid"),t=c.getRuleByUniqueId(e);c.setSelectedRule(t),h(t)}))})),e(d.body).find("[data-role=actions]").each((function(){e(l=this).on("mousedown","> [data-role=action]",(function(){var e=c.getSelectedRule();e.setSelectedAction(e.getActionByUniqueId(~~this.getAttribute("data-action-uid")))}))})),e(d.body).find("[data-role=rules-toolbar]").each((function(){s=this})),e(d.body).find("[data-role=actions-toolbar]").each((function(){e(this).on("click","button[data-role=create-action]",(function(){var t,i,o=~~l.getAttribute("data-rule-uid"),a=c.getRuleByUniqueId(o);t=a,i=new Dt(n.getFormControlsList(),n.getDatabase(),e,r),t.addAction(i),l.appendChild(i.getRootDOMNode()),i.asyncInitCodeMirrorEditor(),t.setSelectedAction(i),t.onErrorStateChanged()})).on("click","button[data-role=delete-action]",(function(){var e=~~l.getAttribute("data-rule-uid"),n=c.getRuleByUniqueId(e);if(n){var i,r,o=n.getSelectedAction();o&&(i=n,r=o,t.prompt("Delete action","Are you sure you want to delete this action?",(function(){l.removeChild(r.getRootDOMNode()),i.deleteAction(r),i.setSelectedAction(null),i.onErrorStateChanged()})))}})).on("click","button[data-role=move-up]",(function(){var e=c.getSelectedRule();if(e){var t=e.getSelectedAction();t&&e.moveActionUp(t)}})).on("click","button[data-role=move-down]",(function(){var e=c.getSelectedRule();if(e){var t=e.getSelectedAction();t&&e.moveActionDown(t)}}))})),e(s).on("click","button[data-role=create-rule]",(function(){var e;e=new Ot(n.getFormControlsList()),c.addRule(e),a.appendChild(e.getRootDOMNode()),c.setSelectedRule(e),h(e)})).on("click","button[data-role=delete-rule]",(function(){var e=c.getSelectedRule();e&&function(e){t.prompt("Delete rule","Are you sure you want to delete this rule containing "+e.getActions().length+" actions?",(function(){for(c.deleteRule(e),a.removeChild(e.getRootDOMNode());l.firstChild;)l.removeChild(l.firstChild)}))}(e)})).on("click","button[data-role=move-up]",(function(){c.moveRuleUp(c.getSelectedRule())})).on("click","button[data-role=move-down]",(function(){c.moveRuleDown(c.getSelectedRule())})),function(){for(;a.firstChild;)a.removeChild(a.firstChild);for(var e=0,t=c.getRules(),n=t.length;e<n;e++)a.appendChild(t[e].getRootDOMNode());if(c.getRules().length){var i=c.getRules()[0];c.setSelectedRule(i),h(i)}}()})).catch((function(e){throw e}))}))}},{key:"getTestConnectionButton",value:function(){return this.app.getJQuery()("[data-role=csv-remote-connection-dialog] #connection-test-button")}},{key:"getConnectionDialogFormSerializedData",value:function(){return btoa(this.app.getJQuery()("#form-connection-dialog").serialize())}},{key:"getDialogSaveButton",value:function(){return this.app.getJQuery()(".ui-dialog .ui-buttons button.btn-secondary-cta")}},{key:"disableDialogSaveButton",value:function(){var e=this.getDialogSaveButton();e&&e.attr("disabled","disabled")}},{key:"enableDialogSaveButton",value:function(){var e=this.getDialogSaveButton();e&&e.removeAttr("disabled")}},{key:"disableDialogTestConnectionButton",value:function(){var e=this.getTestConnectionButton();e&&e.attr("disabled","disabled")}},{key:"enableDialogTestConnectionButton",value:function(){var e=this.getTestConnectionButton();e&&e.removeAttr("disabled")}},{key:"setTextConnectionValue",value:function(e){this.getObjectConnectionTestInput().val(e)}},{key:"testConnection",value:function(){var e,t,n=this,i=(this.getTestConnectionButton(),this.getObjectTestConnectionMessageContainer()),r=this.getObjectTestConnectionMessageExtraDetailsContainer(),o=this.getObjectTestConnectionLoaderContainer(),a=this.getConnectionDialogFormSerializedData();this.disableDialogTestConnectionButton(),e=this.app.getJQuery(),this.app,t=this.app,this.app.getResourceManager(),i.hide(),i.removeClass("errorInDialog"),r.html(""),o.show(),e.when(e.ajax("/sf_applications_actions.php",{type:"POST",data:{someaction:"applications_csvconnector_remote_test_connection",formid:String(t.getFormId()),appid:String(t.getApplicationId()),application_service:"36",formData:a}})).then((function(e,t){n.enableDialogTestConnectionButton();var a=JSON.parse(e);o.hide(),a.success?(i.removeClass("errorInDialog"),r.html(""),n.setTextConnectionValue(1),n.enableDialogSaveButton(),n.disableDialogTestConnectionButton()):(i.addClass("errorInDialog"),r.html(a.errorDetails),n.setTextConnectionValue(0),n.disableDialogSaveButton(),n.enableDialogTestConnectionButton()),i.show(),i.html(a.message)})).fail((function(e){o.hide(),i.show(),i.html(e.toString),n.enableDialogTestConnectionButton()}))}},{key:"getObjectTestConnectionLoaderContainer",value:function(){return this.app.getJQuery()(".ui-dialog .ui-body  [data-role=test-connection-loader]")}},{key:"getObjectTestConnectionMessageContainer",value:function(){return this.app.getJQuery()(".ui-dialog .ui-body  [data-role=csv-remote-test-connection-message]")}},{key:"getObjectTestConnectionMessageExtraDetailsContainer",value:function(){return this.app.getJQuery()(".ui-dialog .ui-body  [data-role=csv-remote-test-connection-message-extra-details]")}},{key:"getObjectConnectionTestInput",value:function(){return this.app.getJQuery()("#connection-test")}},{key:"isConnectionTested",value:function(){return Boolean(1==this.getObjectConnectionTestInput().val())}},{key:"applyOriginalState",value:function(){this.setTextConnectionValue(0),this.getObjectTestConnectionMessageContainer().hide(),this.disableDialogSaveButton(),this.enableDialogTestConnectionButton(),this.getObjectTestConnectionMessageContainer().attr("title","")}},{key:"fillConnectionFields",value:function(){var e={};try{e=JSON.parse(window["CSVConnectorApplicationBox"+String(this.app.getApplicationId())].getConfig())}catch(t){}e&&e.connection&&(e.connection.dbType&&this.app.getJQuery()('form[name="form-connection-dialog"] #connection-type').val(e.connection.dbType),e.connection.host&&this.app.getJQuery()('form[name="form-connection-dialog"] #connection-host').val(e.connection.host),e.connection.port&&this.app.getJQuery()('form[name="form-connection-dialog"] #connection-port').val(e.connection.port),e.connection.user&&this.app.getJQuery()('form[name="form-connection-dialog"] #connection-username').val(e.connection.username),e.connection.dbname&&this.app.getJQuery()('form[name="form-connection-dialog"] #connection-database-name').val(e.connection.dbname),e.connection.isPublicConnection&&this.app.getJQuery()('form[name="form-connection-dialog"] #connection-is-public').val(e.connection.isPublicConnection))}},{key:"useExternalDbAction",value:function(){var e,t,n,i=this;e=this.app.getJQuery(),t=this.app,n=this.app,this.app.getResourceManager().get("/modules/RulesV3/resources/connect-external-db-dialog.html").then((function(r){var o=t.createDialog("Connect to external database",[{type:pt.c.SAVE,callback:function(){if(i.isConnectionTested()){var t=i.getConnectionDialogFormSerializedData();e.when(e.ajax("/sf_applications_actions.php",{type:"POST",data:{someaction:"applications_csvconnector_remote_save_connection",formid:String(n.getFormId()),appid:String(n.getApplicationId()),application_service:"36",formData:t}})).then((function(t,i){var r=JSON.parse(t);r&&r.data&&r.data.useRemoteDatabaseText&&e("#CSVAppBoxConnectionSetExternalDBText-"+String(n.getApplicationId())).html(r.data.useRemoteDatabaseText),window["CSVConnectorApplicationBox"+String(n.getApplicationId())].withConfig(r.config),window["CSVConnectorApplicationBox"+String(n.getApplicationId())].updateRulesV3Data(r),window["CSVConnectorApplicationBox"+String(n.getApplicationId())].applyUseConnectionExternalDB(),o.close()})).fail((function(e){}))}}},{type:pt.c.CANCEL,callback:function(){o.close()}}],{width:"600px"});o.body.innerHTML=r,i.applyOriginalState(),i.fillConnectionFields()}))}},{key:"removeApplicationAction",value:function(){var e,t,n;e=this.app.getJQuery(),t=this.app,n=this.app,this.app.getResourceManager().get("/modules/RulesV3/resources/remove-application-dialog.html").then((function(i){var r=t.createDialog("Remove application",[{type:pt.c.DELETE,callback:function(){var t=e(r.body).find("[name=delete-sql-rules]").is(":checked");e.when(e.ajax("/sf_applications_actions.php",{type:"POST",data:{someaction:"applications_remove",formid:String(n.getFormId()),application_id:String(n.getApplicationId()),application_service:"36",withRules:t}}),n.getDatabase().deleteAllAssociatedSettingsAndAllTables({applicationconfig:btoa(n.getDatabase().getApplicationConfig())})).then((function(e,t){r.close()})).fail((function(e){}))}},{type:pt.c.CANCEL,callback:function(){r.close()}}],{width:"500px"});r.body.innerHTML=i}))}},{key:"rawString2HTML",value:function(e){return JSON.stringify(e||"").replace(/(^"|"$)/g,"").replace(/^\\\\$/g,"\\").replace(/^\\"$/g,'"')}},{key:"html2RawString",value:function(e){return'"'===e?'"':JSON.parse('"'+e.replace(/^\\$/g,"\\\\")+'"')}},{key:"convertJQLColumnTypeToGridColumnType",value:function(e){switch(e){case f.STRING:return pt.b.STRING;case f.NUMBER:return pt.b.NUMBER;case f.BOOLEAN:return pt.b.BOOLEAN;case f.NULL:default:return pt.b.UNKNOWN}}},{key:"editTableIndexes",value:function(e){var t,n,i,r;t=this.app.getJQuery(),n=this.app,i=this.app,r=this.app.getResourceManager(),i.getDatabase().getTable(e).isIndexable()?r.get("/modules/RulesV3/resources/edit-table-indexes-dialog.html").then((function(r){var o,a=i.getDatabase().getTable(e),s=new kt.a(r),l=n.createDialog("Edit indexes",[{type:pt.c.SAVE,callback:function(){for(var t=[],r=0,a=o.getRows(),s=a.length;r<s;r++)(a[r].getDataAt(2)||a[r].getDataAt(3))&&t.push({autoIncrement:a[r].getDataAt(3),unique:a[r].getDataAt(2),name:a[r].getDataAt(0)});i.getDatabase().getTable(e).alterIndexes(t).then((function(){l.close()})).catch((function(e){console.error(e),n.alert("Error modifying indexes","There was an error while trying to modify the table indexes!")}))}},{type:pt.c.CANCEL,callback:function(){l.close()}}],{width:"500px",height:"500px"});l.dialog.setAttribute("data-dialog-role","edit-table-indexes"),l.body.innerHTML=s.parse({}),(o=new Nt(t).withSortingEnabled(!1)).createColumn().withColumnName("Column").withColumnType(pt.b.STRING).withEditable(!1).withWidth(165),o.createColumn().withColumnName("Type").withColumnType(pt.b.STRING).withEditable(!1).withWidth(70),o.createColumn().withColumnName("Unique").withColumnType(pt.b.BOOLEAN).withEditable(!0).withWidth(60).withValueRenderer((function(e){return e?'<span class="i-md i123-key icon"></span>':""})),o.createColumn().withColumnName("Auto").withColumnType(pt.b.BOOLEAN).withEditable(!0).withWidth(60).withValueRenderer((function(e){return e?'<span class="i-md i123-input_number icon"></span>':""}));for(var u=0,c=a.describe(),d=c.length;u<d;u++){var h=function(e){for(var t=[!1,!1],n=0,i=a.getIndexes(),r=i.length;n<r;n++){var o=i[n].getDescriptors();if(1===o.length&&o[0].name===e){t[0]=i[n].isUnique(),t[1]=i[n].isAutoIncrement();break}}return t}(c[u].name);o.createRow([c[u].name,c[u].type,h[0],h[1]]).withRowIndex(u+1)}o.on("row-updated",(function(e,t,i,r){if(3===t)if(e.getDataAt(1)===f.NUMBER){if(i){e.setDataAt(2,!0);for(var a=0,s=o.getRows(),l=s.length;a<l;a++)s[a]!==e&&s[a].getDataAt(3)&&s[a].setDataAt(3,!1)}}else i&&(e.setDataAt(3,!1),n.alert("Not supported","Only columns of type number can be Auto Incremented"))})),l.body.appendChild(o.getRootDOMNode())})):n.alert("Table not indexable",'Table "'+e+'" does not support indexes!')}},{key:"browserForDatabaseTablesDialog",value:function(){return e=this.app.getJQuery(),t=this.app.getDatabase(),n=this.app.getResourceManager(),i=this.app,e.Deferred((function(r){n.get("/modules/RulesV3/resources/browse-for-database-table-dialog.html").then((function(n){var o=new kt.a(n),a=i.createDialog("Insert table in SQL query",[{type:pt.c.OK,callback:function(){a.close();var e=s.getSelectedIndex();if(-1!==e){var t=s.getRows()[e].getDataAt(0);r.resolve(t)}else r.reject(new Error("Canceled"))}},{type:pt.c.CANCEL,callback:function(){a.close(),r.reject(new Error("Close button pressed"))}}],{width:"500px",height:"500px",onCloseButtonClick:function(){r.reject(new Error("Dialog closed by user"))}});a.dialog.setAttribute("data-dialog-role","browse-for-table-dialog"),a.body.innerHTML=o.parse({});var s=new Nt(e).withEmptyStateHTML("There are no database tables created").withSortingEnabled(!1);a.body.appendChild(s.getRootDOMNode()),s.createColumn().withColumnName("table").withWidth(300).withColumnType(pt.b.STRING);for(var l=0,u=t.enumerateTables(),c=u.length;l<c;l++)s.createRow([u[l].name])}))})).promise();var e,t,n,i}},{key:"browserForDatabaseTableColumnsDialog",value:function(){return e=this.app.getJQuery(),t=this.app.getDatabase(),n=this.app.getResourceManager(),i=this.app,e.Deferred((function(r){n.get("/modules/RulesV3/resources/browse-for-database-table-dialog.html").then((function(n){var o=new kt.a(n),a=i.createDialog("Insert table column in SQL query",[{type:pt.c.OK,callback:function(){a.close();var e=s.getSelectedIndex();if(-1!==e){var t=s.getRows()[e].getDataAt(1);r.resolve(t)}else r.reject(new Error("Canceled"))}},{type:pt.c.CANCEL,callback:function(){a.close(),r.reject(new Error("Close button pressed"))}}],{width:"500px",height:"500px",onCloseButtonClick:function(){r.reject(new Error("Dialog closed by user"))}});a.dialog.setAttribute("data-dialog-role","browse-for-table-dialog"),a.body.innerHTML=o.parse({});var s=new Nt(e).withEmptyStateHTML("There are no database tables created").withSortingEnabled(!1);a.body.appendChild(s.getRootDOMNode()),s.createColumn().withColumnName("table").withWidth(100).withColumnType(pt.b.STRING),s.createColumn().withColumnName("column").withWidth(150).withColumnType(pt.b.STRING),s.createColumn().withColumnName("type").withWidth(100).withColumnType(pt.b.STRING);for(var l=0,u=t.enumerateTables(),c=u.length;l<c;l++)for(var d=t.getTable(u[l].name).describe(),h=0,f=d.length;h<f;h++)s.createRow([u[l].name,d[h].name,d[h].type])}))})).promise();var e,t,n,i}},{key:"browseForFormsControlDialog",value:function(){return e=this.app.getJQuery(),t=this.app.getFormControlsList(),n=this.app.getResourceManager(),i=this.app,e.Deferred((function(r){n.get("/modules/RulesV3/resources/browse-for-form-control-dialog.html").then((function(n){var o=new kt.a(n),a=i.createDialog("Insert control in SQL query",[{type:pt.c.OK,callback:function(){a.close();var t=s.getSelectedIndex();if(-1!==t){var n=s.getRows()[t].getDataAt(0),i=e(a.body).find("input[name=insert-as-binding]").is(":checked");r.resolve((i?":":"")+n)}else r.reject(new Error("Canceled"))}},{type:pt.c.CANCEL,callback:function(){a.close(),r.reject(new Error("Close button pressed"))}}],{width:"500px",height:"500px",onCloseButtonClick:function(){r.reject(new Error("Dialog closed by user"))}});a.dialog.setAttribute("data-dialog-role","browse-for-control-dialog"),a.body.innerHTML=o.parse({});var s=new Nt(e).withEmptyStateHTML("There are no database tables created").withSortingEnabled(!1);e(a.body).find("[data-role=grid-placeholder]").get(0).appendChild(s.getRootDOMNode()),s.createColumn().withColumnName("control_id").withColumnCaption("ID").withWidth(180).withColumnType(pt.b.STRING),s.createColumn().withColumnName("control_label").withColumnCaption("Label").withWidth(200).withColumnType(pt.b.STRING);for(var l=0,u=t.length;l<u;l++)s.createRow([t[l].id,t[l].name])}))})).promise();var e,t,n,i}},{key:"queryDatabaseAction",value:function(){var e,t,n;e=this.app.getJQuery(),t=this.app,n=this.app,this.app.getResourceManager().get("/modules/RulesV3/resources/query-database-dialog.html").then((function(i){var o,a,s=new kt.a(i),l=t.createDialog("Database console",[],{width:"800px"});l.dialog.setAttribute("data-dialog-role","database-console"),l.body.innerHTML=s.parse({});var u=function(t){var i=+new Date;e(l.body).find("[data-role=query-result]").each((function(){var o;(o=this).innerHTML="<div data-role=loading>Loading</div>",e(l.body).find("[data-role=query-statistics]").each((function(){!function(s){s.innerHTML="";try{var l=n.getDatabase().createStatement(t);n.getDatabase().executeStatement(l,{}).then((function(t){o.innerHTML="";var n=+new Date;switch(l.getStatementType()){case r.SELECT:!function(t,n,i,r){if(a?a.dispose():a=new Nt(e).withSortingEnabled(!1).withEmptyStateHTML("Query returned no rows"),t.appendChild(a.getRootDOMNode()),i.getRows().length){var o=i.getRows()[0],s=0;for(var l in o)a.createColumn().withColumnName("col_"+s).withColumnCaption(l).withWidth(100).withColumnType(pt.b.UNKNOWN),s++;for(var u=0,c=i.getRowsAsArray().length,d=i.getRowsAsArray(),h=0,f=d.length;h<f;h++)if(a.createRow(d[h]).withRowIndex(h+1),h>=49){u=f-50;break}e(n).append('<div data-role="info">'+c+" row(s) found in "+(r/1e3).toFixed(3)+" seconds</div>"),0!=u&&e(n).append('<div data-role="info">'+u+" row(s) were not displayed</div>")}}(o,s,t,n-i);break;case r.DELETE:case r.UPDATE:case r.INSERT:!function(t,n,i){e(t).append('<div data-role="info">'+n.getAffectedRows()+" row(s) affected in "+(i/1e3).toFixed(3)+" seconds</div>")}(s,t,n-i)}})).catch((function(e){var t;o.innerHTML="",t=M()(e,Error)?String(e):"string"===typeof e?e:JSON.stringify(e,void 0,4);var n=document.createElement("div");n.setAttribute("data-role","error"),n.textContent=t.replace(/^Error: /g,""),o.appendChild(n)}))}catch(c){o.innerHTML="";var u=document.createElement("div");u.setAttribute("data-role","error"),u.textContent=c.toString().replace(/^Error: /g,""),o.appendChild(u)}}(this)}))}))};e(l.body).find("[data-role=query-builder]").each((function(){var e,t;null===(t=o=null===(e=CodeMirror)||void 0===e?void 0:e(this,{value:"",mode:"text/x-mariadb",lineNumbers:!0}))||void 0===t||t.setSize("100%","80px")})),e(l.body).on("click","button[data-role=run-query]",(function(){var e,t,n=null!==(e=null===(t=o)||void 0===t?void 0:t.getValue())&&void 0!==e?e:"";u(n)}))}))}},{key:"onChangeConnectionCredentials",value:function(){this.applyOriginalState()}}]),e}(),xt=n(79),_t=function(){function e(t){E()(this,e),x()(this,"jq",void 0),x()(this,"i18n",void 0),this.jq=t,this.i18n=new xt.a,this.i18n.setTranslations({myforms_UI_btn_SAVE:"Save",myforms_UI_btn_CANCEL:"Cancel",myforms_UI_btn_OK:"Ok",myforms_UI_btn_CLOSE:"Close",myforms_UI_btn_YES:"Yes",myforms_UI_btn_NO:"No",applications_UI_btn_CREATE:"Create",applications_UI_btn_DONE:"Done",myforms_UI_btn_DELETE:"Delete"})}return T()(e,[{key:"getI18n",value:function(){return this.i18n}},{key:"getJQuery",value:function(){return this.jq}}]),e}(),Lt=function(){function e(){E()(this,e)}return T()(e,null,[{key:"create",value:function(e){return ot.createVirtualTable([{name:"index",type:f.NUMBER,default:0},{name:"name",type:f.STRING,default:0},{name:"label",type:f.STRING,default:""},{name:"readOnly",type:f.BOOLEAN,default:!1},{name:"disabled",type:f.BOOLEAN,default:!1},{name:"value",type:f.STRING,default:""},{name:"checked",type:f.BOOLEAN,default:!1},{name:"visible",type:f.BOOLEAN,default:!1},{name:"calculated",type:f.BOOLEAN,default:!1}])}}]),e}(),Mt=function(){function e(){E()(this,e)}return T()(e,null,[{key:"create",value:function(e){return ot.createVirtualTable([{name:"userId",type:f.NUMBER,default:0},{name:"userEmail",type:f.STRING,default:""}])}}]),e}(),Ft=function(e){function t(e,n,i,r,o){var a,s,l;return E()(this,t),a=C()(this,S()(t).call(this,new _t(i),i,null,null)),x()(O()(a),"applicationId",void 0),x()(O()(a),"formId",void 0),x()(O()(a),"jq",void 0),x()(O()(a),"db",void 0),x()(O()(a),"resourceManager",void 0),x()(O()(a),"formControlsList",[]),x()(O()(a),"commandDispatcher",void 0),x()(O()(a),"onApplicationEnableCheckboxClick",void 0),x()(O()(a),"onCreateNewDatabaseButtonClick",void 0),x()(O()(a),"onExploreDatabaseButtonClick",void 0),x()(O()(a),"onCreateSQLRuleButtonClick",void 0),x()(O()(a),"onRemoveApplicationButtonClick",void 0),x()(O()(a),"onQueryDatabaseButtonClick",void 0),x()(O()(a),"sessionVirtualTable","session"),x()(O()(a),"controlsVirtualTable","controls"),a.jq=i,a.db=r,a.resourceManager=new yt(a.jq,{}),a.applicationId=e,a.formId=n,a.formControlsList=o,a.commandDispatcher=new Rt(O()(a)),s=O()(a),l=a.jq,s.db.hasTable("controls")||s.db.withTable("controls",Lt.create(s.db)),s.db.hasTable("session")||s.db.withTable("session",Mt.create(s.db)),s.onApplicationEnableCheckboxClick=function(e){s._onApplicationEnableCheckboxClick(this)},s.onCreateNewDatabaseButtonClick=function(e){s._onCreateNewTableButtonClick(this)},s.onExploreDatabaseButtonClick=function(e){s._onExploreDatabaseButtonClick(this)},s.onCreateSQLRuleButtonClick=function(e){s._onCreateSQLRuleButtonClick(this)},s.onRemoveApplicationButtonClick=function(e){s._onRemoveApplicationButtonClick(this)},s.onQueryDatabaseButtonClick=function(e){s._onQueryDatabaseButtonClick(this)},l(document).on("click","#app_isenabled_".concat(s.applicationId),s.onApplicationEnableCheckboxClick).on("click","#csvConnectorAppCreateDatabaseButton-".concat(s.applicationId),s.onCreateNewDatabaseButtonClick).on("click","#csvConnectorAppExploreDatabaseButton-".concat(s.applicationId),s.onExploreDatabaseButtonClick).on("click","#csvConnectorAppCustomizeButton-".concat(s.applicationId),s.onCreateSQLRuleButtonClick).on("click","#csvConnectorAppRemoveButton-".concat(s.applicationId),s.onRemoveApplicationButtonClick).on("click","#csvConnectorAppQueryDatabaseButton-".concat(s.applicationId),s.onQueryDatabaseButtonClick).on("click","#csvConnectorAppUseExternalDBButton-".concat(s.applicationId),s._onUseExternalDbButtonClick.bind(s)).on("click","[data-role=csv-remote-connection-dialog] #connection-test-button",s._onTestConnectionButtonClick.bind(s)),l(document).on("change",".ui-dialog select[name=connection-type]",s._onChangeConnectionCredentials.bind(s)).on("change",".ui-dialog input[name=connection-host]",s._onChangeConnectionCredentials.bind(s)).on("change",".ui-dialog input[name=connection-port]",s._onChangeConnectionCredentials.bind(s)).on("change",".ui-dialog input[name=connection-username]",s._onChangeConnectionCredentials.bind(s)).on("change",".ui-dialog input[name=connection-password]",s._onChangeConnectionCredentials.bind(s)).on("change",".ui-dialog input[name=connection-database-name]",s._onChangeConnectionCredentials.bind(s)),a}return A()(t,e),T()(t,[{key:"getApplicationId",value:function(){return this.applicationId}},{key:"getFormId",value:function(){return this.formId}},{key:"getResourceManager",value:function(){return this.resourceManager}},{key:"getJQuery",value:function(){return this.jq}},{key:"getDatabase",value:function(){return this.db}},{key:"getFormControlsList",value:function(){return this.formControlsList}},{key:"destroy",value:function(){var e,t;e=this.jq,t=this,e(document).off("click","#app_isenabled_"+t.applicationId,t.onApplicationEnableCheckboxClick).off("click","#csvConnectorAppCreateDatabaseButton-"+t.applicationId,t.onCreateNewDatabaseButtonClick).off("click","#csvConnectorAppExploreDatabaseButton-"+t.applicationId,t.onExploreDatabaseButtonClick).off("click","#csvConnectorAppCustomizeButton-"+t.applicationId,t.onCreateSQLRuleButtonClick).off("click","#csvConnectorAppRemoveButton-"+t.applicationId,t.onRemoveApplicationButtonClick),this.db=null,this.jq=null}},{key:"_onApplicationEnableCheckboxClick",value:function(e){this.commandDispatcher.setApplicationEnabledStateAction(e.checked)}},{key:"_onCreateNewTableButtonClick",value:function(e){this.commandDispatcher.createNewTableAction()}},{key:"_onExploreDatabaseButtonClick",value:function(e){this.commandDispatcher.exploreDatabasesAction()}},{key:"_onCreateSQLRuleButtonClick",value:function(e){this.commandDispatcher.editFormRulesAction()}},{key:"_onRemoveApplicationButtonClick",value:function(e){this.commandDispatcher.removeApplicationAction()}},{key:"_onQueryDatabaseButtonClick",value:function(e){this.commandDispatcher.queryDatabaseAction()}},{key:"_onUseExternalDbButtonClick",value:function(){this.commandDispatcher.useExternalDbAction()}},{key:"_onTestConnectionButtonClick",value:function(){this.commandDispatcher.testConnection()}},{key:"_onChangeConnectionCredentials",value:function(){this.commandDispatcher.onChangeConnectionCredentials()}},{key:"createNotification",value:function(e){!(arguments.length>1&&void 0!==arguments[1])||arguments[1],arguments.length>2&&void 0!==arguments[2]?arguments[2]:pt.d.DEFAULT,arguments.length>3&&arguments[3];console.warn("NOTIFICATION: ",e);try{messages_to_user_push_message(e,0,this.applicationId)}catch(t){}return null}},{key:"getVirtualTables",value:function(){this.db.hasTable(this.controlsVirtualTable)||this.db.withTable(this.controlsVirtualTable,Lt.create(this.db)),this.db.hasTable(this.sessionVirtualTable)||this.db.withTable(this.sessionVirtualTable,Mt.create(this.db))}}]),t}(vt),Pt=function(){function e(){E()(this,e)}return T()(e,null,[{key:"initDatabaseFunctions",value:function(e){return e.hasLocalFunction("DATE_DIFF")||e.withFunction("DATE_DIFF",ft.DATE_DIFF,!0,!1),e.hasLocalFunction("DATE_BETWEEN")||e.withFunction("DATE_BETWEEN",ft.DATE_BETWEEN,!0,!1),e.hasLocalFunction("DATE_GET_NUMBER_OF_DAYS")||e.withFunction("DATE_GET_NUMBER_OF_DAYS",ft.DATE_GET_NUMBER_OF_DAYS,!0,!1),e.hasLocalFunction("TIME_GET_NUMBER_OF_MINUTES")||e.withFunction("TIME_GET_NUMBER_OF_MINUTES",ft.TIME_GET_NUMBER_OF_MINUTES,!0,!1),e.hasLocalFunction("DATE_FORMAT")||e.withFunction("DATE_FORMAT",ft.DATE_FORMAT,!0,!1),e.hasLocalFunction("CURRENT_DATE")||e.withFunction("CURRENT_DATE",ft.CURRENT_DATE,!0,!1),e.hasLocalFunction("DATE_COMPARE")||e.withFunction("DATE_COMPARE",ft.DATE_COMPARE,!0,!1),e.hasLocalFunction("TIME_COMPARE")||e.withFunction("TIME_COMPARE",ft.TIME_COMPARE,!0,!1),e.hasLocalFunction("DATE_ADD_INTERVAL")||e.withFunction("DATE_ADD_INTERVAL",ft.DATE_ADD_INTERVAL,!0,!1),e.hasLocalFunction("CONCAT")||e.withFunction("CONCAT",ft.CONCAT,!0,!0),e.hasLocalFunction("SUM")||e.withFunction("SUM",ft.SUM,!0,!1),e.hasLocalFunction("EQUALS")||e.withFunction("EQUALS",ft.EQUALS,!0,!1),e.hasLocalFunction("COMPARE")||e.withFunction("COMPARE",ft.COMPARE,!0,!1),e.hasLocalFunction("IF")||e.withFunction("IF",ft.IF,!0,!1),e.hasLocalFunction("BOOL")||e.withFunction("BOOL",ft.BOOL,!0,!1),e.hasLocalFunction("INT")||e.withFunction("INT",ft.INT,!0,!1),e.hasLocalFunction("FLOAT")||e.withFunction("FLOAT",ft.FLOAT,!0,!1),e.hasLocalFunction("STRING")||e.withFunction("STRING",ft.STRING,!0,!1),e.hasLocalFunction("ALERT")||e.withFunction("ALERT",ft.ALERT,!0,!1),e.hasLocalFunction("DATE_UID")||e.withFunction("DATE_UID",ft.UNIQUE_ID_BASED_ON_DATE_MILISECOND,!0,!1),e.hasLocalFunction("WORKING_DAYS_BETWEEN")||e.withFunction("WORKING_DAYS_BETWEEN",null,!1,!0),e.hasLocalFunction("RESERVATION_DATE_INTERSECT")||e.withFunction("RESERVATION_DATE_INTERSECT",null,!1,!0),e.hasLocalFunction("FROM_BASE64")||e.withFunction("FROM_BASE64",ft.FROM_BASE64,!0,!0),e.hasLocalFunction("TO_BASE64")||e.withFunction("TO_BASE64",ft.TO_BASE64,!0,!0),e.hasLocalFunction("REPLACE")||e.withFunction("REPLACE",ft.REPLACE,!0,!0),e}}]),e}(),Bt=function(){function e(){E()(this,e),x()(this,"queries",{}),x()(this,"active",!1)}return T()(e,[{key:"setActive",value:function(e){return this.active=e,this.active||(this.queries={}),this}},{key:"isActive",value:function(){return this.active}},{key:"isQueryDuplicate",value:function(e){if(!this.active)return!1;if("number"===typeof this.queries[e]&&+new Date-this.queries[e]<50)return!0;return!1}},{key:"storeQuery",value:function(e){this.active&&(this.queries[e]=+new Date)}}]),e}(),Ut=function(){function e(){E()(this,e),x()(this,"enabled",!1);try{window.localStorage&&window.localStorage.getItem&&window.localStorage.getItem("FormRulesDebugging")?(console.log("Rules v3 Logger enabled"),this.enabled=!0):console.log("Rules v3 Logger disabled")}catch(t){console.log("Rules v3 Logger disabled")}}return T()(e,[{key:"log",value:function(){if(!this.enabled&&!window.FormRulesDebugging)return this;for(var e=new Date,t=["[LOG]["+e.getDate()+"."+(e.getMonth()+1)+"."+e.getFullYear()+"@"+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+","+e.getMilliseconds()+"]"],n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];for(var o=0,a=i.length;o<a;o++)t.push("string"===typeof i[o]?i[o]:JSON.stringify(i[o]));return console.log(t.join(" ")),this}}]),e}(),Vt=function(e){function t(){var e;return E()(this,t),e=C()(this,S()(t).call(this)),x()(O()(e),"jq",void 0),x()(O()(e),"rpcEndpointName",void 0),x()(O()(e),"rpcEndpointSalesforceName",void 0),x()(O()(e),"authorizationToken",void 0),x()(O()(e),"authorizationTokenSalesforce",void 0),x()(O()(e),"db",void 0),x()(O()(e),"adminApplication",void 0),x()(O()(e),"rules",[]),x()(O()(e),"domAbstractionLayer",void 0),x()(O()(e),"logger",void 0),x()(O()(e),"initialized",!1),x()(O()(e),"previouslySubmittedData",null),x()(O()(e),"duplicateQueryDiscarder",void 0),x()(O()(e),"salesforceAffectedControlsTriggers",void 0),x()(O()(e),"salesforceAffectedControls",void 0),x()(O()(e),"statementCache",{}),x()(O()(e),"applicationConfig",void 0),e.db=Pt.initDatabaseFunctions(new dt),e.logger=new Ut,e.duplicateQueryDiscarder=new Bt,e}return A()(t,e),T()(t,[{key:"getDatabase",value:function(){return this.db}},{key:"withJQuery",value:function(e){return this.jq=e,this.db.initPlanner(),this}},{key:"withRPCEndpointName",value:function(e){return this.db.withRPCEndpointName(this.rpcEndpointName=e),this}},{key:"withRPCEndpointSalesforceName",value:function(e){return this.db.withRPCEndpointSalesforceName(this.rpcEndpointSalesforceName=e),this}},{key:"withAuthorizationToken",value:function(e){return this.db.withAuthorizationToken(this.authorizationToken=e),this}},{key:"withApplicationConfig",value:function(e){return this.db.withApplicationConfig(this.applicationConfig=e),this}},{key:"withAuthorizationTokenSalesforce",value:function(e){return this.db.withAuthorizationTokenSalesforce(this.authorizationTokenSalesforce=e),this}},{key:"withJQLBackendTables",value:function(e){if(null===e)return this;for(var t=this.db.enumerateTables(),n=0,i=t.length;n<i;n++)this.db.unmountTable(t[n].name);return this.db.withTablesList(e),this}},{key:"withJQLTable",value:function(e,t){return this.db.withTable(e,t),this}},{key:"exploreDatabase",value:function(e){if(!this.domAbstractionLayer)throw new Error("This operation is only available in view-form page!");new Rt(e).exploreDatabasesAction()}},{key:"bootstrapCSVConnectorApplication",value:function(e,t,n){var i=/^applications_box_([\d]+)$/.exec(e);if(i){var r=parseInt(i[1]);if(!isNaN(r)){if(this.adminApplication){if(this.adminApplication.getApplicationId()===r&&this.adminApplication.getFormId()===t)return void this.adminApplication.getVirtualTables();this.adminApplication.destroy()}this.adminApplication=new Ft(r,t,window.$||window.$x,this.getDatabase(),n),console.warn("Bootstrapped admin application #".concat(r))}}}},{key:"withDOMAbstractionLayer",value:function(e){return this.domAbstractionLayer=e,this}},{key:"getRules",value:function(){return this.rules}},{key:"resetRules",value:function(e){this.rules=e}},{key:"withRules",value:function(e){for(var t=0,n=(e||[]).length;t<n;t++)this.rules.push(e[t]);return this.logger.log("Added ".concat((e||[]).length," rules in RulesV3 engine")),this}},{key:"initializeInFormViewMode",value:function(){var e=this;if(this.initialized)throw new Error("RulesV3: Engine already initialized!");if(!this.domAbstractionLayer)throw new Error("Cannot initialize RulesV3 engine: No DOMAbstraction layer provided at this point!");return this.domAbstractionLayer.on("control-event",(function(t,n,i,r){e.dispatchControlEvent(t,i,n,r)})),this.domAbstractionLayer.trigger("initialize"),this.initialized=!0,this.logger.log("Initialized RulesV3 in view form mode"),this.markUsedSalesforceControls(),this}},{key:"dispatchControlEvent",value:function(e,t,n,i){var r=this,o=t;if(e===y.REINITIALIZE&&this.initializeControlValueWithPreviouslySubmittedData(t,n,i),this.rules&&this.rules.length){var a=null,s=null,l=null;n&&(!function(e){try{var t=e(n).parents('div[data-type="repeatable-group"]')[0];a=e(t).data("repeatable-path")}catch(i){}}(window.jQuery||window.$||window.$x),a&&(l="".concat(t,"_rp").concat(String(a)),s=n.value));for(var u=0,c=this.rules.length;u<c;u++)null!==(t="undefined"!==typeof this.rules[u].repeatablePath&&a?l:o)&&this.areTheSameControlIDs(String(this.rules[u].controlId),t)&&null!==e&&(e===this.rules[u].eventType||y.ALL_EVENTS===this.rules[u].eventType&&y.REINITIALIZE!==e||y.INIT===e&&this.rules[u].isRule)&&null!==this.rules[u].actions&&this.rules[u].actions.length&&this.executeControlEventActions(this.rules[u].actions,(function(){return s||r.domAbstractionLayer.getControlValueById(t)}),i,e,a);this.trigger("dispatch",t)}}},{key:"initializeControlValueWithPreviouslySubmittedData",value:function(e,t,n){null!==this.domAbstractionLayer&&this.domAbstractionLayer.initializeControlValueWhenTheFormIsPrefillingASubmission(e,n)}},{key:"areTheSameControlIDs",value:function(e,t){return e.replace(/^control_/g,"")===t.replace(/^control_/g,"")}},{key:"executeControlEventActions",value:function(e,t,n,i,o){var a=this;o=o||null;for(var s,l,u,c=+new Date,d=0,h=e.length;d<h;d++)if((s=e[d].jql)&&!/^([\s]+)?$/.test(s))if(this.duplicateQueryDiscarder.isQueryDuplicate(s))this.logger.log("DISCARD: ",s),setTimeout((function(){a.db.triggerNextQuery()}));else if(this.duplicateQueryDiscarder.storeQuery(s),!e[d].controlId||this.domAbstractionLayer.controlExistsInForm(String(e[d].controlId))){l=function(){return{this:i!==y.REINITIALIZE?t():n}},this.logger.log("SQL: ".concat(s));try{var f=s+e[d].controlId;(u=this.statementCache[f])||(u=this.db.createStatement(s),this.statementCache[f]=u),function(e,t){a.db.executeStatement(e,l).then((function(n){var i=+new Date;e.getStatementType()===r.SELECT?(a.logger.log("".concat(e.getStatementType()," statement (").concat(((i-c)/1e3).toFixed(3),"s): "),JSON.stringify(n.getRowsAsArray()),"to control: ",String(t.controlId)),a.domAbstractionLayer.setControlValueById(String(t.controlId),n.getRowsAsArray(),null,o)):a.logger.log("".concat(e.getStatementType()," statement (").concat(((i-c)/1e3).toFixed(3),"s): "),n.getAffectedRows(),"rows were affected")})).catch((function(e){console.warn("SQL failed: ".concat(String(s),": ").concat(e.toString())),console.error(e)}))}(u,e[d])}catch(g){this.logger.log("JQL failed: ","".concat(String(s),": ").concat(g.toString())),console.error(g)}}else console.warn("SKIP QUERY: ","".concat(s," => control id ").concat(JSON.stringify(e[d].controlId)," not found in form")),setTimeout((function(){a.db.triggerNextQuery()}));else setTimeout((function(){a.db.triggerNextQuery()}))}},{key:"getLogger",value:function(){return this.logger}},{key:"getDOMAbstractionLayer",value:function(){return this.domAbstractionLayer}},{key:"getPreviouslySubmittedFormData",value:function(){return this.previouslySubmittedData}},{key:"getSubmissionValueForControlId",value:function(e){return null!==this.previouslySubmittedData&&e&&this.previouslySubmittedData.hasOwnProperty(e)?this.previouslySubmittedData[e]:null}},{key:"createDOMAbstractionLayer",value:function(e){switch(e){case ct.LEGACY_EDITOR:return new gt(this.jq,this);case ct.LATEST_EDITOR_VERSION:return new window.AbstractionLayerV2(arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2]);default:throw new Error("Sorry, but RulesV3 engine don't know how to create a DOM Abstraction layer of type ".concat(JSON.stringify(this.domAbstractionLayer)))}}},{key:"getDuplicateQueryDiscarder",value:function(){return this.duplicateQueryDiscarder}},{key:"markUsedSalesforceControls",value:function(){for(var e=[],t=[],n=0,i=this.rules||[],r=i.length;n<r;n++)if(i[n].isSalesforce){e.push(i[n].controlId);for(var o=0,a=i[n].actions||[],s=a.length;o<s;o++)t.push(a[o].controlId)}this.salesforceAffectedControlsTriggers=e,this.salesforceAffectedControls=t}},{key:"getSalesforceAffectedControlsTriggers",value:function(){return this.salesforceAffectedControlsTriggers}},{key:"getSalesforceAffectedControls",value:function(){return this.salesforceAffectedControls}},{key:"hasSalesforceRule",value:function(){return this.rules.some((function(e){return!0===e.isSalesforce}))}},{key:"isSalesforceWithPrefillTriggerRule",value:function(){var e=[y.REINITIALIZE,y.CHANGE];return this.rules.every((function(t){return e.includes(t.eventType)}))}},{key:"shouldShowLoaderOnSalesforce",value:function(){return this.hasSalesforceRule&&!this.isSalesforceWithPrefillTriggerRule()}},{key:"shouldShowLoader",value:function(){return 0!==this.rules.length&&(this.rules.length>t.SHOW_LOADER_RULES_COUNT||this.shouldShowLoaderOnSalesforce())}}],[{key:"getInstance",value:function(){return this.instance||(this.instance=new t)}}]),t}(_.a);x()(Vt,"SHOW_LOADER_RULES_COUNT",100),x()(Vt,"instance",void 0),window.RulesV3=Vt,window.JQLNativeFunctions=ft}});